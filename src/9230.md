  RFC 9230          Oblivious DoH   June 2022
  ----------------- --------------- -----------
  Kinnear, et al.   Experimental    \[Page\]

::: {#external-metadata .document-information}
:::

::: {#internal-metadata .document-information}

Stream:
:   Independent Submission

RFC:
:   [9230](https://www.rfc-editor.org/rfc/rfc9230){.eref}

Category:
:   Experimental

Published:
:   June 2022

ISSN:
:   2070-1721

Authors:

:   ::: author
    ::: author-name
    E. Kinnear
    :::

    ::: org
    Apple Inc.
    :::
    :::

    ::: author
    ::: author-name
    P. McManus
    :::

    ::: org
    Fastly
    :::
    :::

    ::: author
    ::: author-name
    T. Pauly
    :::

    ::: org
    Apple Inc.
    :::
    :::

    ::: author
    ::: author-name
    T. Verma
    :::

    ::: org
    Cloudflare
    :::
    :::

    ::: author
    ::: author-name
    C.A. Wood
    :::

    ::: org
    Cloudflare
    :::
    :::
:::

# RFC 9230 {#rfcnum}

# Oblivious DNS over HTTPS {#title}

::: {#section-abstract .section}
## [Abstract](#abstract){.selfRef}

This document describes a protocol that allows clients to hide their IP
addresses from DNS resolvers via proxying encrypted DNS over HTTPS (DoH)
messages. This improves privacy of DNS operations by not allowing any
one server entity to be aware of both the client IP address and the
content of DNS queries and answers.[¶](#section-abstract-1){.pilcrow}

This experimental protocol has been developed outside the IETF and is
published here to guide implementation, ensure interoperability among
implementations, and enable wide-scale
experimentation.[¶](#section-abstract-2){.pilcrow}
:::

::: {#status-of-memo}
::: {#section-boilerplate.1 .section}
## [Status of This Memo](#name-status-of-this-memo){.section-name .selfRef} {#name-status-of-this-memo}

This document is not an Internet Standards Track specification; it is
published for examination, experimental implementation, and
evaluation.[¶](#section-boilerplate.1-1){.pilcrow}

This document defines an Experimental Protocol for the Internet
community. This is a contribution to the RFC Series, independently of
any other RFC stream. The RFC Editor has chosen to publish this document
at its discretion and makes no statement about its value for
implementation or deployment. Documents approved for publication by the
RFC Editor are not candidates for any level of Internet Standard; see
Section 2 of RFC 7841.[¶](#section-boilerplate.1-2){.pilcrow}

Information about the current status of this document, any errata, and
how to provide feedback on it may be obtained at
<https://www.rfc-editor.org/info/rfc9230>.[¶](#section-boilerplate.1-3){.pilcrow}
:::
:::

::: {#copyright}
::: {#section-boilerplate.2 .section}
## [Copyright Notice](#name-copyright-notice){.section-name .selfRef} {#name-copyright-notice}

Copyright (c) 2022 IETF Trust and the persons identified as the document
authors. All rights reserved.[¶](#section-boilerplate.2-1){.pilcrow}

This document is subject to BCP 78 and the IETF Trust\'s Legal
Provisions Relating to IETF Documents
(<https://trustee.ietf.org/license-info>) in effect on the date of
publication of this document. Please review these documents carefully,
as they describe your rights and restrictions with respect to this
document.[¶](#section-boilerplate.2-2){.pilcrow}
:::
:::

::: {#toc}
::: {#section-toc.1 .section}
[▲](#){.toplink}

## [Table of Contents](#name-table-of-contents){.section-name .selfRef} {#name-table-of-contents}

-   ::: {#section-toc.1-1.1}
    [1](#section-1){.xref}.  [Introduction](#name-introduction){.xref}

    -   ::: {#section-toc.1-1.1.2.1}
        [1.1](#section-1.1){.xref}.  [Specification of
        Requirements](#name-specification-of-requiremen){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.2}
    [2](#section-2){.xref}.  [Terminology](#name-terminology){.xref}
    :::

-   ::: {#section-toc.1-1.3}
    [3](#section-3){.xref}.  [Deployment
    Requirements](#name-deployment-requirements){.xref}
    :::

-   ::: {#section-toc.1-1.4}
    [4](#section-4){.xref}.  [HTTP Exchange](#name-http-exchange){.xref}

    -   ::: {#section-toc.1-1.4.2.1}
        [4.1](#section-4.1){.xref}.  [HTTP
        Request](#name-http-request){.xref}
        :::

    -   ::: {#section-toc.1-1.4.2.2}
        [4.2](#section-4.2){.xref}.  [HTTP Request
        Example](#name-http-request-example){.xref}
        :::

    -   ::: {#section-toc.1-1.4.2.3}
        [4.3](#section-4.3){.xref}.  [HTTP
        Response](#name-http-response){.xref}
        :::

    -   ::: {#section-toc.1-1.4.2.4}
        [4.4](#section-4.4){.xref}.  [HTTP Response
        Example](#name-http-response-example){.xref}
        :::

    -   ::: {#section-toc.1-1.4.2.5}
        [4.5](#section-4.5){.xref}.  [HTTP
        Metadata](#name-http-metadata){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.5}
    [5](#section-5){.xref}.  [Configuration and Public Key
    Format](#name-configuration-and-public-ke){.xref}
    :::

-   ::: {#section-toc.1-1.6}
    [6](#section-6){.xref}.  [Protocol
    Encoding](#name-protocol-encoding){.xref}

    -   ::: {#section-toc.1-1.6.2.1}
        [6.1](#section-6.1){.xref}.  [Message
        Format](#name-message-format){.xref}
        :::

    -   ::: {#section-toc.1-1.6.2.2}
        [6.2](#section-6.2){.xref}.  [Encryption and Decryption
        Routines](#name-encryption-and-decryption-r){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.7}
    [7](#section-7){.xref}.  [Oblivious Client
    Behavior](#name-oblivious-client-behavior){.xref}
    :::

-   ::: {#section-toc.1-1.8}
    [8](#section-8){.xref}.  [Oblivious Target
    Behavior](#name-oblivious-target-behavior){.xref}
    :::

-   ::: {#section-toc.1-1.9}
    [9](#section-9){.xref}.  [Compliance
    Requirements](#name-compliance-requirements){.xref}
    :::

-   ::: {#section-toc.1-1.10}
    [10](#section-10){.xref}. [Experiment
    Overview](#name-experiment-overview){.xref}
    :::

-   ::: {#section-toc.1-1.11}
    [11](#section-11){.xref}. [Security
    Considerations](#name-security-considerations){.xref}

    -   ::: {#section-toc.1-1.11.2.1}
        [11.1](#section-11.1){.xref}.  [Denial of
        Service](#name-denial-of-service){.xref}
        :::

    -   ::: {#section-toc.1-1.11.2.2}
        [11.2](#section-11.2){.xref}.  [Proxy
        Policies](#name-proxy-policies){.xref}
        :::

    -   ::: {#section-toc.1-1.11.2.3}
        [11.3](#section-11.3){.xref}.  [Authentication](#name-authentication){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.12}
    [12](#section-12){.xref}. [IANA
    Considerations](#name-iana-considerations){.xref}

    -   ::: {#section-toc.1-1.12.2.1}
        [12.1](#section-12.1){.xref}.  [Oblivious DoH Message Media
        Type](#name-oblivious-doh-message-media){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.13}
    [13](#section-13){.xref}. [References](#name-references){.xref}

    -   ::: {#section-toc.1-1.13.2.1}
        [13.1](#section-13.1){.xref}.  [Normative
        References](#name-normative-references){.xref}
        :::

    -   ::: {#section-toc.1-1.13.2.2}
        [13.2](#section-13.2){.xref}.  [Informative
        References](#name-informative-references){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.14}
    [Appendix A](#appendix-A){.xref}.  [Use of Generic Proxy
    Services](#name-use-of-generic-proxy-servic){.xref}
    :::

-   ::: {#section-toc.1-1.15}
    [](#appendix-B){.xref}[Acknowledgments](#name-acknowledgments){.xref}
    :::

-   ::: {#section-toc.1-1.16}
    [](#appendix-C){.xref}[Authors\'
    Addresses](#name-authors-addresses){.xref}
    :::
:::
:::

::: {#introduction}
::: {#section-1 .section}
## [1.](#section-1){.section-number .selfRef} [Introduction](#name-introduction){.section-name .selfRef} {#name-introduction}

DNS over HTTPS (DoH) \[[RFC8484](#RFC8484){.xref}\] defines a mechanism
to allow DNS messages to be transmitted in HTTP messages protected with
TLS. This provides improved confidentiality and authentication for DNS
interactions in various circumstances.[¶](#section-1-1){.pilcrow}

While DoH can prevent eavesdroppers from directly reading the contents
of DNS exchanges, clients cannot send DNS queries to and receive answers
from servers without revealing their local IP address (and thus
information about the identity or location of the client) to the
server.[¶](#section-1-2){.pilcrow}

Proposals such as Oblivious DNS
\[[OBLIVIOUS-DNS](#I-D.annee-dprive-oblivious-dns){.xref}\] increase
privacy by ensuring that no single DNS server is aware of both the
client IP address and the message contents.[¶](#section-1-3){.pilcrow}

This document defines Oblivious DoH, an experimental protocol built on
DoH that permits proxied resolution, in which DNS messages are encrypted
so that no server can independently read both the client IP address and
the DNS message contents.[¶](#section-1-4){.pilcrow}

As with DoH, DNS messages exchanged over Oblivious DoH are fully formed
DNS messages. Clients that want to receive answers that are relevant to
the network they are on without revealing their exact IP address can
thus use the EDNS0 Client Subnet option (\[[RFC7871](#RFC7871){.xref}\],
[Section
7.1.2](https://www.rfc-editor.org/rfc/rfc7871#section-7.1.2){.relref})
to provide a hint to the resolver using Oblivious
DoH.[¶](#section-1-5){.pilcrow}

This mechanism is intended to be used as one mechanism for resolving
privacy-sensitive content in the broader context of DNS
privacy.[¶](#section-1-6){.pilcrow}

This experimental protocol has been developed outside the IETF and is
published here to guide implementation, ensure interoperability among
implementations, and enable wide-scale experimentation. See [Section
10](#experiment){.xref} for more details about the
experiment.[¶](#section-1-7){.pilcrow}

::: {#specification-of-requirements}
::: {#section-1.1 .section}
### [1.1.](#section-1.1){.section-number .selfRef} [Specification of Requirements](#name-specification-of-requiremen){.section-name .selfRef} {#name-specification-of-requiremen}

The key words \"[MUST]{.bcp14}\", \"[MUST NOT]{.bcp14}\",
\"[REQUIRED]{.bcp14}\", \"[SHALL]{.bcp14}\", \"[SHALL NOT]{.bcp14}\",
\"[SHOULD]{.bcp14}\", \"[SHOULD NOT]{.bcp14}\",
\"[RECOMMENDED]{.bcp14}\", \"[NOT RECOMMENDED]{.bcp14}\",
\"[MAY]{.bcp14}\", and \"[OPTIONAL]{.bcp14}\" in this document are to be
interpreted as described in BCP 14 \[[RFC2119](#RFC2119){.xref}\]
\[[RFC8174](#RFC8174){.xref}\] when, and only when, they appear in all
capitals, as shown here.[¶](#section-1.1-1){.pilcrow}
:::
:::
:::
:::

::: {#terminology}
::: {#section-2 .section}
## [2.](#section-2){.section-number .selfRef} [Terminology](#name-terminology){.section-name .selfRef} {#name-terminology}

This document defines the following terms:[¶](#section-2-1){.pilcrow}

[]{.break}

Oblivious Client:

:   A client that sends DNS queries to an Oblivious Target, through an
    Oblivious Proxy. The Client is responsible for selecting the
    combination of Proxy and Target to use for a given
    query.[¶](#section-2-2.2.1){.pilcrow}

:   

Oblivious Proxy:

:   An HTTP server that proxies encrypted DNS queries and responses
    between an Oblivious Client and an Oblivious Target and is
    identified by a URI Template \[[RFC6570](#RFC6570){.xref}\] (see
    [Section 4.1](#oblivious-request){.xref}). Note that this Oblivious
    Proxy is not acting as a full HTTP proxy but is instead a
    specialized server used to forward Oblivious DNS
    messages.[¶](#section-2-2.4.1){.pilcrow}

:   

Oblivious Target:

:   An HTTP server that receives and decrypts encrypted Oblivious Client
    DNS queries from an Oblivious Proxy and returns encrypted DNS
    responses via that same Proxy. In order to provide DNS responses,
    the Target can be a DNS resolver, be co-located with a resolver, or
    forward to a resolver.[¶](#section-2-2.6.1){.pilcrow}

:   

Throughout the rest of this document, we use the terms \"Client\",
\"Proxy\", and \"Target\" to refer to an Oblivious Client, Oblivious
Proxy, and Oblivious Target, respectively.[¶](#section-2-3){.pilcrow}
:::
:::

::: {#deployment-requirements}
::: {#section-3 .section}
## [3.](#section-3){.section-number .selfRef} [Deployment Requirements](#name-deployment-requirements){.section-name .selfRef} {#name-deployment-requirements}

Oblivious DoH requires, at a minimum:[¶](#section-3-1){.pilcrow}

-   [An Oblivious Proxy server, identified by a URI
    Template.[¶](#section-3-2.1){.pilcrow}]{#section-3-2.1}
-   [An Oblivious Target server. The Target and Proxy are expected to be
    non-colluding (see [Section
    11](#security-considerations){.xref}).[¶](#section-3-2.2){.pilcrow}]{#section-3-2.2}
-   [One or more Target public keys for encrypting DNS queries sent to a
    Target via a Proxy ([Section 5](#publickey){.xref}). These keys
    guarantee that only the intended Target can decrypt Client
    queries.[¶](#section-3-2.3){.pilcrow}]{#section-3-2.3}

The mechanism for discovering and provisioning the Proxy URI Template
and Target public keys is out of scope for this
document.[¶](#section-3-3){.pilcrow}
:::
:::

::: {#http-exchange}
::: {#section-4 .section}
## [4.](#section-4){.section-number .selfRef} [HTTP Exchange](#name-http-exchange){.section-name .selfRef} {#name-http-exchange}

Unlike direct resolution, oblivious hostname resolution over DoH
involves three parties:[¶](#section-4-1){.pilcrow}

1.  [The Client, which generates
    queries.[¶](#section-4-2.1){.pilcrow}]{#section-4-2.1}
2.  [The Proxy, which receives encrypted queries from the Client and
    passes them on to a
    Target.[¶](#section-4-2.2){.pilcrow}]{#section-4-2.2}
3.  [The Target, which receives proxied queries from the Client via the
    Proxy and produces proxied
    answers.[¶](#section-4-2.3){.pilcrow}]{#section-4-2.3}

[]{#name-oblivious-doh-exchange}

::: {#fig-doh-exchange}
::: {#section-4-3.1 .alignLeft .art-text .artwork}
         --- [ Request encrypted with Target public key ] -->
    +---------+             +-----------+             +-----------+
    | Client  +-------------> Oblivious +-------------> Oblivious |
    |         <-------------+   Proxy   <-------------+  Target   |
    +---------+             +-----------+             +-----------+
        <-- [   Response encrypted with symmetric key   ] ---
:::

[Figure 1](#figure-1){.selfRef}: [Oblivious DoH
Exchange](#name-oblivious-doh-exchange){.selfRef}
:::

::: {#oblivious-request}
::: {#section-4.1 .section}
### [4.1.](#section-4.1){.section-number .selfRef} [HTTP Request](#name-http-request){.section-name .selfRef} {#name-http-request}

Oblivious DoH queries are created by the Client and are sent to the
Proxy as HTTP requests using the POST method. Clients are configured
with a Proxy URI Template \[[RFC6570](#RFC6570){.xref}\] and the Target
URI. The scheme for both the Proxy URI Template and the Target URI
[MUST]{.bcp14} be \"https\". The Proxy URI Template uses the Level 3
encoding defined in [Section
1.2](https://www.rfc-editor.org/rfc/rfc6570#section-1.2){.relref} of
\[[RFC6570](#RFC6570){.xref}\] and contains two variables:
\"targethost\", which indicates the hostname of the Target server; and
\"targetpath\", which indicates the path on which the Target is
accessible. Examples of Proxy URI Templates are shown
below:[¶](#section-4.1-1){.pilcrow}

::: {#section-4.1-2 .alignLeft .art-text .artwork}
    https://dnsproxy.example/dns-query{?targethost,targetpath}
    https://dnsproxy.example/{targethost}/{targetpath}

[¶](#section-4.1-2){.pilcrow}
:::

The URI Template [MUST]{.bcp14} contain both the \"targethost\" and
\"targetpath\" variables exactly once and [MUST NOT]{.bcp14} contain any
other variables. The variables [MUST]{.bcp14} be within the path or
query components of the URI. Clients [MUST]{.bcp14} ignore
configurations that do not conform to this template. See [Section
4.2](#request-example){.xref} for an example
request.[¶](#section-4.1-3){.pilcrow}

Oblivious DoH messages have no cache value, since both requests and
responses are encrypted using ephemeral key material. Requests and
responses [MUST NOT]{.bcp14} be cached.[¶](#section-4.1-4){.pilcrow}

Clients [MUST]{.bcp14} set the HTTP Content-Type header to
\"application/oblivious-dns-message\" to indicate that this request is
an Oblivious DoH query intended for proxying. Clients also
[SHOULD]{.bcp14} set this same value for the HTTP Accept
header.[¶](#section-4.1-5){.pilcrow}

A correctly encoded request has the HTTP Content-Type header
\"application/oblivious-dns-message\", uses the HTTP POST method, and
contains \"targethost\" and \"targetpath\" variables. If the Proxy fails
to match the \"targethost\" and \"targetpath\" variables from the path,
it [MUST]{.bcp14} treat the request as malformed. The Proxy constructs
the URI of the Target with the \"https\" scheme, using the value of
\"targethost\" as the URI host and the percent-decoded value of
\"targetpath\" as the URI path. Proxies [MUST]{.bcp14} check that Client
requests are correctly encoded and [MUST]{.bcp14} return a 4xx (Client
Error) if the check fails, along with the Proxy-Status response header
with an \"error\" parameter of type \"http_request_error\"
\[[RFC9209](#RFC9209){.xref}\].[¶](#section-4.1-6){.pilcrow}

Proxies [MAY]{.bcp14} choose to not forward connections to non-standard
ports. In such cases, Proxies can indicate the error with a 403 response
status code, along with a Proxy-Status response header with an \"error\"
parameter of type \"http_request_denied\" and with an appropriate
explanation in \"details\".[¶](#section-4.1-7){.pilcrow}

If the Proxy cannot establish a connection to the Target, it can
indicate the error with a 502 response status code, along with a
Proxy-Status response header with an \"error\" parameter whose type
indicates the reason. For example, if DNS resolution fails, the error
type might be \"dns_timeout\", whereas if the TLS connection fails, the
error type might be \"tls_protocol_error\".[¶](#section-4.1-8){.pilcrow}

Upon receipt of requests from a Proxy, Targets [MUST]{.bcp14} validate
that the request has the HTTP Content-Type header
\"application/oblivious-dns-message\" and uses the HTTP POST method.
Targets can respond with a 4xx response status code if this check
fails.[¶](#section-4.1-9){.pilcrow}
:::
:::

::: {#request-example}
::: {#section-4.2 .section}
### [4.2.](#section-4.2){.section-number .selfRef} [HTTP Request Example](#name-http-request-example){.section-name .selfRef} {#name-http-request-example}

The following example shows how a Client requests that a Proxy,
\"dnsproxy.example\", forward an encrypted message to
\"dnstarget.example\". The URI Template for the Proxy is
\"https://dnsproxy.example/dns-query{?targethost,targetpath}\". The URI
for the Target is
\"https://dnstarget.example/dns-query\".[¶](#section-4.2-1){.pilcrow}

::: {#section-4.2-2}
``` {.lang-http-message .sourcecode}
:method = POST
:scheme = https
:authority = dnsproxy.example
:path = /dns-query?targethost=dnstarget.example&targetpath=/dns-query
accept = application/oblivious-dns-message
content-type = application/oblivious-dns-message
content-length = 106

<Bytes containing an encrypted Oblivious DNS query>
```

[¶](#section-4.2-2){.pilcrow}
:::

The Proxy then sends the following request on to the
Target:[¶](#section-4.2-3){.pilcrow}

::: {#section-4.2-4}
``` {.lang-http-message .sourcecode}
:method = POST
:scheme = https
:authority = dnstarget.example
:path = /dns-query
accept = application/oblivious-dns-message
content-type = application/oblivious-dns-message
content-length = 106

<Bytes containing an encrypted Oblivious DNS query>
```

[¶](#section-4.2-4){.pilcrow}
:::
:::
:::

::: {#oblivious-response}
::: {#section-4.3 .section}
### [4.3.](#section-4.3){.section-number .selfRef} [HTTP Response](#name-http-response){.section-name .selfRef} {#name-http-response}

The response to an Oblivious DoH query is generated by the Target. It
[MUST]{.bcp14} set the Content-Type HTTP header to
\"application/oblivious-dns-message\" for all successful responses. The
body of the response contains an encrypted DNS message; see [Section
6](#encryption){.xref}.[¶](#section-4.3-1){.pilcrow}

The response from a Target [MUST]{.bcp14} set the Content-Type HTTP
header to \"application/oblivious-dns-message\", and that same type
[MUST]{.bcp14} be used on all successful responses sent by the Proxy to
the Client. A Client [MUST]{.bcp14} only consider a response that
contains the Content-Type header before processing the payload. A
response without the appropriate header [MUST]{.bcp14} be treated as an
error and be handled appropriately. All other aspects of the HTTP
response and error handling are inherited from standard
DoH.[¶](#section-4.3-2){.pilcrow}

Proxies forward responses from the Target to the Client, without any
modifications to the body or status code. The Proxy also
[SHOULD]{.bcp14} add a Proxy-Status response header with a
\"received-status\" parameter indicating that the status code was
generated by the Target.[¶](#section-4.3-3){.pilcrow}

Note that if a Client receives a 3xx status code and chooses to follow a
redirect, the subsequent request [MUST]{.bcp14} also be performed
through a Proxy in order to avoid directly exposing requests to the
Target.[¶](#section-4.3-4){.pilcrow}

Requests that cannot be processed by the Target result in 4xx (Client
Error) responses. If the Target and Client keys do not match, it is an
authorization failure (HTTP status code 401; see [Section
15.5.2](https://www.rfc-editor.org/rfc/rfc9110#section-15.5.2){.relref}
of \[[HTTP](#RFC9110){.xref}\]). Otherwise, if the Client\'s request is
invalid, such as in the case of decryption failure, wrong message type,
or deserialization failure, this is a bad request (HTTP status code 400;
see [Section
15.5.1](https://www.rfc-editor.org/rfc/rfc9110#section-15.5.1){.relref}
of \[[HTTP](#RFC9110){.xref}\]).[¶](#section-4.3-5){.pilcrow}

Even in the case of DNS responses indicating failure, such as SERVFAIL
or NXDOMAIN, a successful HTTP response with a 2xx status code is used
as long as the DNS response is valid. This is identical to how DoH
\[[RFC8484](#RFC8484){.xref}\] handles HTTP response
codes.[¶](#section-4.3-6){.pilcrow}
:::
:::

::: {#http-response-example}
::: {#section-4.4 .section}
### [4.4.](#section-4.4){.section-number .selfRef} [HTTP Response Example](#name-http-response-example){.section-name .selfRef} {#name-http-response-example}

The following example shows a 2xx (Successful) response that can be sent
from a Target to a Client via a Proxy.[¶](#section-4.4-1){.pilcrow}

::: {#section-4.4-2}
``` {.lang-http-message .sourcecode}
:status = 200
content-type = application/oblivious-dns-message
content-length = 154

<Bytes containing an encrypted Oblivious DNS response>
```

[¶](#section-4.4-2){.pilcrow}
:::
:::
:::

::: {#http-metadata}
::: {#section-4.5 .section}
### [4.5.](#section-4.5){.section-number .selfRef} [HTTP Metadata](#name-http-metadata){.section-name .selfRef} {#name-http-metadata}

Proxies forward requests and responses between Clients and Targets as
specified in [Section 4.1](#oblivious-request){.xref}. Metadata sent
with these messages could inadvertently weaken or remove Oblivious DoH
privacy properties. Proxies [MUST NOT]{.bcp14} send any
Client-identifying information about Clients to Targets, such as
\"Forwarded\" HTTP headers \[[RFC7239](#RFC7239){.xref}\]. Additionally,
Clients [MUST NOT]{.bcp14} include any private state in requests to
Proxies, such as HTTP cookies. See [Section
11.3](#authentication){.xref} for related discussion about Client
authentication information.[¶](#section-4.5-1){.pilcrow}
:::
:::
:::
:::

::: {#publickey}
::: {#section-5 .section}
## [5.](#section-5){.section-number .selfRef} [Configuration and Public Key Format](#name-configuration-and-public-ke){.section-name .selfRef} {#name-configuration-and-public-ke}

In order to send a message to a Target, the Client needs to know a
public key to use for encrypting its queries. The mechanism for
discovering this configuration is out of scope for this
document.[¶](#section-5-1){.pilcrow}

Servers ought to rotate public keys regularly. It is
[RECOMMENDED]{.bcp14} that servers rotate keys every day. Shorter
rotation windows reduce the anonymity set of Clients that might use the
public key, whereas longer rotation windows widen the time frame of
possible compromise.[¶](#section-5-2){.pilcrow}

An Oblivious DNS public key configuration is a structure encoded, using
TLS-style encoding \[[RFC8446](#RFC8446){.xref}\], as
follows:[¶](#section-5-3){.pilcrow}

::: {#section-5-4}
``` {.lang-tls-presentation .sourcecode}
struct {
   uint16 kem_id;
   uint16 kdf_id;
   uint16 aead_id;
   opaque public_key<1..2^16-1>;
} ObliviousDoHConfigContents;

struct {
   uint16 version;
   uint16 length;
   select (ObliviousDoHConfig.version) {
      case 0x0001: ObliviousDoHConfigContents contents;
   }
} ObliviousDoHConfig;

ObliviousDoHConfig ObliviousDoHConfigs<1..2^16-1>;
```

[¶](#section-5-4){.pilcrow}
:::

The `ObliviousDoHConfigs` structure contains one or more
`ObliviousDoHConfig` structures in decreasing order of preference. This
allows a server to support multiple versions of Oblivious DoH and
multiple sets of Oblivious DoH parameters.[¶](#section-5-5){.pilcrow}

An `ObliviousDoHConfig` structure contains a versioned representation of
an Oblivious DoH configuration, with the following
fields.[¶](#section-5-6){.pilcrow}

[]{.break}

version:

:   The version of Oblivious DoH for which this configuration is used.
    Clients [MUST]{.bcp14} ignore any `ObliviousDoHConfig` structure
    with a version they do not support. The version of Oblivious DoH
    specified in this document is
    `0x0001`.[¶](#section-5-7.2.1){.pilcrow}

:   

length:

:   The length, in bytes, of the next
    field.[¶](#section-5-7.4.1){.pilcrow}

:   

contents:

:   An opaque byte string whose contents depend on the version. For this
    specification, the contents are an `ObliviousDoHConfigContents`
    structure.[¶](#section-5-7.6.1){.pilcrow}

:   

An `ObliviousDoHConfigContents` structure contains the information
needed to encrypt a message under
`ObliviousDoHConfigContents.public_key` such that only the owner of the
corresponding private key can decrypt the message. The values for
`ObliviousDoHConfigContents.kem_id`,
`ObliviousDoHConfigContents.kdf_id`, and
`ObliviousDoHConfigContents.aead_id` are described in [Section
7](https://www.rfc-editor.org/rfc/rfc9180#section-7){.relref} of
\[[HPKE](#RFC9180){.xref}\]. The fields in this structure are as
follows:[¶](#section-5-8){.pilcrow}

[]{.break}

kem_id:

:   The hybrid public key encryption (HPKE) key encapsulation mechanism
    (KEM) identifier corresponding to `public_key`. Clients
    [MUST]{.bcp14} ignore any `ObliviousDoHConfig` structure with a key
    using a KEM they do not support.[¶](#section-5-9.2.1){.pilcrow}

:   

kdf_id:

:   The HPKE key derivation function (KDF) identifier corresponding to
    `public_key`. Clients [MUST]{.bcp14} ignore any `ObliviousDoHConfig`
    structure with a key using a KDF they do not
    support.[¶](#section-5-9.4.1){.pilcrow}

:   

aead_id:

:   The HPKE authenticated encryption with associated data (AEAD)
    identifier corresponding to `public_key`. Clients [MUST]{.bcp14}
    ignore any `ObliviousDoHConfig` structure with a key using an AEAD
    they do not support.[¶](#section-5-9.6.1){.pilcrow}

:   

public_key:

:   The HPKE public key used by the Client to encrypt Oblivious DoH
    queries.[¶](#section-5-9.8.1){.pilcrow}

:   
:::
:::

::: {#encryption}
::: {#section-6 .section}
## [6.](#section-6){.section-number .selfRef} [Protocol Encoding](#name-protocol-encoding){.section-name .selfRef} {#name-protocol-encoding}

This section includes encoding and wire format details for Oblivious
DoH, as well as routines for encrypting and decrypting encoded
values.[¶](#section-6-1){.pilcrow}

::: {#encoding}
::: {#section-6.1 .section}
### [6.1.](#section-6.1){.section-number .selfRef} [Message Format](#name-message-format){.section-name .selfRef} {#name-message-format}

There are two types of Oblivious DoH messages: Queries (0x01) and
Responses (0x02). Both messages carry the following
information:[¶](#section-6.1-1){.pilcrow}

1.  [A DNS message, which is either a Query or Response, depending on
    context.[¶](#section-6.1-2.1){.pilcrow}]{#section-6.1-2.1}
2.  [Padding of arbitrary length, which [MUST]{.bcp14} contain all
    zeros.[¶](#section-6.1-2.2){.pilcrow}]{#section-6.1-2.2}

They are encoded using the following
structure:[¶](#section-6.1-3){.pilcrow}

::: {#section-6.1-4}
``` {.lang-tls-presentation .sourcecode}
struct {
   opaque dns_message<1..2^16-1>;
   opaque padding<0..2^16-1>;
} ObliviousDoHMessagePlaintext;
```

[¶](#section-6.1-4){.pilcrow}
:::

Both Query and Response messages use the `ObliviousDoHMessagePlaintext`
format.[¶](#section-6.1-5){.pilcrow}

::: {#section-6.1-6}
``` {.lang-tls-presentation .sourcecode}
ObliviousDoHMessagePlaintext ObliviousDoHQuery;
ObliviousDoHMessagePlaintext ObliviousDoHResponse;
```

[¶](#section-6.1-6){.pilcrow}
:::

An encrypted `ObliviousDoHMessagePlaintext` parameter is carried in an
`ObliviousDoHMessage` message, encoded as
follows:[¶](#section-6.1-7){.pilcrow}

::: {#section-6.1-8}
``` {.lang-tls-presentation .sourcecode}
struct {
   uint8  message_type;
   opaque key_id<0..2^16-1>;
   opaque encrypted_message<1..2^16-1>;
} ObliviousDoHMessage;
```

[¶](#section-6.1-8){.pilcrow}
:::

The `ObliviousDoHMessage` structure contains the following
fields:[¶](#section-6.1-9){.pilcrow}

[]{.break}

message_type:

:   A one-byte identifier for the type of message. Query messages use
    `message_type` 0x01, and Response messages use `message_type`
    0x02.[¶](#section-6.1-10.2.1){.pilcrow}

:   

key_id:

:   The identifier of the corresponding `ObliviousDoHConfigContents`
    key. This is computed as
    `Expand(Extract("", config), "odoh key id", Nh)`, where `config` is
    the `ObliviousDoHConfigContents` structure and `Extract`, `Expand`,
    and `Nh` are as specified by the HPKE cipher suite KDF corresponding
    to `config.kdf_id`.[¶](#section-6.1-10.4.1){.pilcrow}

:   

encrypted_message:

:   An encrypted message for the Oblivious Target (for Query messages)
    or Client (for Response messages). Implementations [MAY]{.bcp14}
    enforce limits on the size of this field, depending on the size of
    plaintext DNS messages. (DNS queries, for example, will not reach
    the size limit of 2\^16-1 in
    practice.)[¶](#section-6.1-10.6.1){.pilcrow}

:   

The contents of `ObliviousDoHMessage.encrypted_message` depend on
`ObliviousDoHMessage.message_type`. In particular,
`ObliviousDoHMessage.encrypted_message` is an encryption of an
`ObliviousDoHQuery` message if the message is a Query and an encryption
of `ObliviousDoHResponse` if the message is a
Response.[¶](#section-6.1-11){.pilcrow}
:::
:::

::: {#encryption-and-decryption-routines}
::: {#section-6.2 .section}
### [6.2.](#section-6.2){.section-number .selfRef} [Encryption and Decryption Routines](#name-encryption-and-decryption-r){.section-name .selfRef} {#name-encryption-and-decryption-r}

Clients use the following utility functions for encrypting a Query and
decrypting a Response as described in [Section
7](#odoh-Client){.xref}.[¶](#section-6.2-1){.pilcrow}

-   [encrypt_query_body: Encrypt an Oblivious DoH
    query.[¶](#section-6.2-2.1){.pilcrow}]{#section-6.2-2.1}

::: {#section-6.2-3}
``` {.lang-pseudocode .sourcecode}
def encrypt_query_body(pkR, key_id, Q_plain):
  enc, context = SetupBaseS(pkR, "odoh query")
  aad = 0x01 || len(key_id) || key_id
  ct = context.Seal(aad, Q_plain)
  Q_encrypted = enc || ct
  return Q_encrypted
```

[¶](#section-6.2-3){.pilcrow}
:::

-   [decrypt_response_body: Decrypt an Oblivious DoH
    response.[¶](#section-6.2-4.1){.pilcrow}]{#section-6.2-4.1}

::: {#section-6.2-5}
``` {.lang-pseudocode .sourcecode}
def decrypt_response_body(context, Q_plain, R_encrypted, resp_nonce):
  aead_key, aead_nonce = derive_secrets(context, Q_plain, resp_nonce)
  aad = 0x02 || len(resp_nonce) || resp_nonce
  R_plain, error = Open(key, nonce, aad, R_encrypted)
  return R_plain, error
```

[¶](#section-6.2-5){.pilcrow}
:::

The `derive_secrets` function is described
below.[¶](#section-6.2-6){.pilcrow}

Targets use the following utility functions in processing queries and
producing responses as described in [Section
8](#odoh-target){.xref}.[¶](#section-6.2-7){.pilcrow}

-   [setup_query_context: Set up an HPKE context used for decrypting an
    Oblivious DoH
    query.[¶](#section-6.2-8.1){.pilcrow}]{#section-6.2-8.1}

::: {#section-6.2-9}
``` {.lang-pseudocode .sourcecode}
def setup_query_context(skR, key_id, Q_encrypted):
  enc || ct = Q_encrypted
  context = SetupBaseR(enc, skR, "odoh query")
  return context
```

[¶](#section-6.2-9){.pilcrow}
:::

-   [decrypt_query_body: Decrypt an Oblivious DoH
    query.[¶](#section-6.2-10.1){.pilcrow}]{#section-6.2-10.1}

::: {#section-6.2-11}
``` {.lang-pseudocode .sourcecode}
def decrypt_query_body(context, key_id, Q_encrypted):
  aad = 0x01 || len(key_id) || key_id
  enc || ct = Q_encrypted
  Q_plain, error = context.Open(aad, ct)
  return Q_plain, error
```

[¶](#section-6.2-11){.pilcrow}
:::

-   [derive_secrets: Derive keying material used for encrypting an
    Oblivious DoH
    response.[¶](#section-6.2-12.1){.pilcrow}]{#section-6.2-12.1}

::: {#section-6.2-13}
``` {.lang-pseudocode .sourcecode}
def derive_secrets(context, Q_plain, resp_nonce):
  secret = context.Export("odoh response", Nk)
  salt = Q_plain || len(resp_nonce) || resp_nonce
  prk = Extract(salt, secret)
  key = Expand(odoh_prk, "odoh key", Nk)
  nonce = Expand(odoh_prk, "odoh nonce", Nn)
  return key, nonce
```

[¶](#section-6.2-13){.pilcrow}
:::

The `random(N)` function returns `N` cryptographically secure random
bytes from a good source of entropy \[[RFC4086](#RFC4086){.xref}\]. The
`max(A, B)` function returns `A` if `A > B`, and `B`
otherwise.[¶](#section-6.2-14){.pilcrow}

-   [encrypt_response_body: Encrypt an Oblivious DoH
    response.[¶](#section-6.2-15.1){.pilcrow}]{#section-6.2-15.1}

::: {#section-6.2-16}
``` {.lang-pseudocode .sourcecode}
def encrypt_response_body(R_plain, aead_key, aead_nonce, resp_nonce):
  aad = 0x02 || len(resp_nonce) || resp_nonce
  R_encrypted = Seal(aead_key, aead_nonce, aad, R_plain)
  return R_encrypted
```

[¶](#section-6.2-16){.pilcrow}
:::
:::
:::
:::
:::

::: {#odoh-Client}
::: {#section-7 .section}
## [7.](#section-7){.section-number .selfRef} [Oblivious Client Behavior](#name-oblivious-client-behavior){.section-name .selfRef} {#name-oblivious-client-behavior}

Let `M` be a DNS message (query) a Client wishes to protect with
Oblivious DoH. When sending an Oblivious DoH Query for resolving `M` to
an Oblivious Target with `ObliviousDoHConfigContents` `config`, a Client
does the following:[¶](#section-7-1){.pilcrow}

1.  [Creates an `ObliviousDoHQuery` structure, carrying the message M
    and padding, to produce
    Q_plain.[¶](#section-7-2.1){.pilcrow}]{#section-7-2.1}
2.  [Deserializes `config.public_key` to produce a public key pkR of
    type `config.kem_id`.[¶](#section-7-2.2){.pilcrow}]{#section-7-2.2}
3.  [Computes the encrypted message as
    `Q_encrypted = encrypt_query_body(pkR, key_id, Q_plain)`, where
    `key_id` is as computed in [Section 6](#encryption){.xref}. Note
    also that `len(key_id)` outputs the length of `key_id` as a two-byte
    unsigned integer.[¶](#section-7-2.3){.pilcrow}]{#section-7-2.3}
4.  [Outputs an `ObliviousDoHMessage` message `Q`, where
    `Q.message_type = 0x01`, `Q.key_id` carries `key_id`, and
    `Q.encrypted_message = Q_encrypted`.[¶](#section-7-2.4){.pilcrow}]{#section-7-2.4}

The Client then sends `Q` to the Proxy according to [Section
4.1](#oblivious-request){.xref}. Once the Client receives a response
`R`, encrypted as specified in [Section 8](#odoh-target){.xref}, it uses
`decrypt_response_body` to decrypt `R.encrypted_message` (using
`R.key_id` as a nonce) and produce R_plain. Clients [MUST]{.bcp14}
validate `R_plain.padding` (as all zeros) before using
`R_plain.dns_message`.[¶](#section-7-3){.pilcrow}
:::
:::

::: {#odoh-target}
::: {#section-8 .section}
## [8.](#section-8){.section-number .selfRef} [Oblivious Target Behavior](#name-oblivious-target-behavior){.section-name .selfRef} {#name-oblivious-target-behavior}

Targets that receive a Query message Q decrypt and process it as
follows:[¶](#section-8-1){.pilcrow}

1.  [Look up the `ObliviousDoHConfigContents` information according to
    `Q.key_id`. If no such key exists, the Target [MAY]{.bcp14} discard
    the query, and if so, it [MUST]{.bcp14} return a 401 (Unauthorized)
    response to the Proxy. Otherwise, let `skR` be the private key
    corresponding to this public key, or one chosen for trial
    decryption.[¶](#section-8-2.1){.pilcrow}]{#section-8-2.1}
2.  [Compute
    `context = setup_query_context(skR, Q.key_id, Q.encrypted_message)`.[¶](#section-8-2.2){.pilcrow}]{#section-8-2.2}
3.  [Compute
    `Q_plain, error = decrypt_query_body(context, Q.key_id, Q.encrypted_message)`.[¶](#section-8-2.3){.pilcrow}]{#section-8-2.3}
4.  [If no error was returned and `Q_plain.padding` is valid (all
    zeros), resolve `Q_plain.dns_message` as needed, yielding a DNS
    message M. Otherwise, if an error was returned or the padding was
    invalid, return a 400 (Client Error) response to the
    Proxy.[¶](#section-8-2.4){.pilcrow}]{#section-8-2.4}
5.  [Create an `ObliviousDoHResponseBody` structure, carrying the
    message `M` and padding, to produce
    `R_plain`.[¶](#section-8-2.5){.pilcrow}]{#section-8-2.5}
6.  [Create a fresh nonce
    `resp_nonce = random(max(Nn, Nk))`.[¶](#section-8-2.6){.pilcrow}]{#section-8-2.6}
7.  [Compute
    `aead_key, aead_nonce = derive_secrets(context, Q_plain, resp_nonce)`.[¶](#section-8-2.7){.pilcrow}]{#section-8-2.7}
8.  [Compute
    `R_encrypted = encrypt_response_body(R_plain, aead_key, aead_nonce, resp_nonce)`.
    The `key_id` field used for encryption carries `resp_nonce` in order
    for Clients to derive the same secrets. Also, the `Seal` function is
    the function that is associated with the HPKE
    AEAD.[¶](#section-8-2.8){.pilcrow}]{#section-8-2.8}
9.  [Output an `ObliviousDoHMessage` message `R`, where
    `R.message_type = 0x02`, `R.key_id = resp_nonce`, and
    `R.encrypted_message = R_encrypted`.[¶](#section-8-2.9){.pilcrow}]{#section-8-2.9}

The Target then sends `R` in a 2xx (Successful) response to the Proxy;
see [Section 4.3](#oblivious-response){.xref}. The Proxy forwards the
message `R` without modification back to the Client as the HTTP response
to the Client\'s original HTTP request. In the event of an error
(non-2xx status code), the Proxy forwards the Target error to the
Client; see [Section
4.3](#oblivious-response){.xref}.[¶](#section-8-3){.pilcrow}
:::
:::

::: {#compliance}
::: {#section-9 .section}
## [9.](#section-9){.section-number .selfRef} [Compliance Requirements](#name-compliance-requirements){.section-name .selfRef} {#name-compliance-requirements}

Oblivious DoH uses HPKE for public key encryption
\[[HPKE](#RFC9180){.xref}\]. In the absence of an application profile
standard specifying otherwise, a compliant Oblivious DoH implementation
[MUST]{.bcp14} support the following HPKE cipher
suite:[¶](#section-9-1){.pilcrow}

[]{.break}

KEM:
:   DHKEM(X25519, HKDF-SHA256) (see \[[HPKE](#RFC9180){.xref}\],
    [Section
    7.1](https://www.rfc-editor.org/rfc/rfc9180#section-7.1){.relref})[¶](#section-9-2.2){.pilcrow}
:   

KDF:
:   HKDF-SHA256 (see \[[HPKE](#RFC9180){.xref}\], [Section
    7.2](https://www.rfc-editor.org/rfc/rfc9180#section-7.2){.relref})[¶](#section-9-2.4){.pilcrow}
:   

AEAD:
:   AES-128-GCM (see \[[HPKE](#RFC9180){.xref}\], [Section
    7.3](https://www.rfc-editor.org/rfc/rfc9180#section-7.3){.relref})[¶](#section-9-2.6){.pilcrow}
:   
:::
:::

::: {#experiment}
::: {#section-10 .section}
## [10.](#section-10){.section-number .selfRef} [Experiment Overview](#name-experiment-overview){.section-name .selfRef} {#name-experiment-overview}

This document describes an experimental protocol built on DoH. The
purpose of this experiment is to assess deployment configuration
viability and related performance impacts on DNS resolution by measuring
key performance indicators such as resolution latency. Experiment
participants will test various parameters affecting service operation
and performance, including mechanisms for discovery and configuration of
DoH Proxies and Targets, as well as performance implications of
connection reuse and pools where appropriate. The results of this
experiment will be used to influence future protocol design and
deployment efforts related to Oblivious DoH, such as Oblivious HTTP
\[[OHTP](#I-D.ietf-ohai-ohttp){.xref}\]. Implementations of DoH that are
not involved in the experiment will not recognize this protocol and will
not participate in the experiment. It is anticipated that the use of
Oblivious DoH will be widespread and that this experiment will be of
long duration.[¶](#section-10-1){.pilcrow}
:::
:::

::: {#security-considerations}
::: {#section-11 .section}
## [11.](#section-11){.section-number .selfRef} [Security Considerations](#name-security-considerations){.section-name .selfRef} {#name-security-considerations}

Oblivious DoH aims to keep knowledge of the true query origin and its
contents known only to Clients. As a simplified model, consider a case
where there exist two Clients C1 and C2, one Proxy P, and one Target T.
Oblivious DoH assumes an extended Dolev-Yao style attacker
\[[Dolev-Yao](#Dolev-Yao){.xref}\] that can observe all network activity
and can adaptively compromise either P or T, but not C1 or C2. Note that
compromising both P and T is equivalent to collusion between these two
parties in practice. Once compromised, the attacker has access to all
session information and private key material. (This generalizes to
arbitrarily many Clients, Proxies, and Targets, with the constraints
that (1) not all Targets and Proxies are simultaneously compromised and
(2) at least two Clients are left uncompromised.) The attacker is
prohibited from sending Client-identifying information, such as IP
addresses, to Targets. (This would allow the attacker to trivially link
a query to the corresponding Client.)[¶](#section-11-1){.pilcrow}

In this model, both C1 and C2 send Oblivious DoH queries Q1 and Q2,
respectively, through P to T, and T provides answers A1 and A2. The
attacker aims to link C1 to (Q1, A1) and C2 to (Q2, A2), respectively.
The attacker succeeds if this linkability is possible without any
additional interaction. (For example, if T is compromised, it could
return a DNS answer corresponding to an entity it controls and then
observe the subsequent connection from a Client, learning its identity
in the process. Such attacks are out of scope for this
model.)[¶](#section-11-2){.pilcrow}

Oblivious DoH security prevents such linkability. Informally, this
means:[¶](#section-11-3){.pilcrow}

1.  [Queries and answers are known only to Clients and Targets in
    possession of the corresponding response key and HPKE keying
    material. In particular, Proxies know the origin and destination of
    an oblivious query, yet do not know the plaintext query. Likewise,
    Targets know only the oblivious query origin, i.e., the Proxy, and
    the plaintext query. Only the Client knows both the plaintext query
    contents and
    destination.[¶](#section-11-4.1){.pilcrow}]{#section-11-4.1}
2.  [Target resolvers cannot link queries from the same Client in the
    absence of unique per-Client
    keys.[¶](#section-11-4.2){.pilcrow}]{#section-11-4.2}

Traffic analysis mitigations are outside the scope of this document. In
particular, this document does not prescribe padding lengths for
`ObliviousDoHQuery` and `ObliviousDoHResponse` messages. Implementations
[SHOULD]{.bcp14} follow the guidance in \[[RFC8467](#RFC8467){.xref}\]
for choosing padding length.[¶](#section-11-5){.pilcrow}

Oblivious DoH security does not depend on Proxy and Target
indistinguishability. Specifically, an on-path attacker could determine
whether a connection to a specific endpoint is used for oblivious or
direct DoH queries. However, this has no effect on the confidentiality
goals listed above.[¶](#section-11-6){.pilcrow}

::: {#denial-of-service}
::: {#section-11.1 .section}
### [11.1.](#section-11.1){.section-number .selfRef} [Denial of Service](#name-denial-of-service){.section-name .selfRef} {#name-denial-of-service}

Malicious Clients (or Proxies) can send bogus Oblivious DoH queries to
Targets as a Denial-of-Service (DoS) attack. Target servers can throttle
processing requests if such an event occurs. Additionally, since Targets
provide explicit errors upon decryption failure, i.e., if ciphertext
decryption fails or if the plaintext DNS message is malformed, Proxies
can throttle specific Clients in response to these errors. In general,
however, Targets trust Proxies to not overwhelm the Target, and it is
expected that Proxies implement either some form of rate limiting or
client authentication to limit abuse; see [Section
11.3](#authentication){.xref}.[¶](#section-11.1-1){.pilcrow}

Malicious Targets or Proxies can send bogus answers in response to
Oblivious DoH queries. Response decryption failure is a signal that
either the Proxy or Target is misbehaving. Clients can choose to stop
using one or both of these servers in the event of such failure.
However, as noted above, malicious Targets and Proxies are out of scope
for the threat model.[¶](#section-11.1-2){.pilcrow}
:::
:::

::: {#proxy-policies}
::: {#section-11.2 .section}
### [11.2.](#section-11.2){.section-number .selfRef} [Proxy Policies](#name-proxy-policies){.section-name .selfRef} {#name-proxy-policies}

Proxies are free to enforce any forwarding policy they desire for
Clients. For example, they can choose to only forward requests to known
or otherwise trusted Targets.[¶](#section-11.2-1){.pilcrow}

Proxies that do not reuse connections to Targets for many Clients may
allow Targets to link individual queries to unknown Targets. To mitigate
this linkability vector, it is [RECOMMENDED]{.bcp14} that Proxies pool
and reuse connections to Targets. Note that this benefits performance as
well as privacy, since queries do not incur any delay that might
otherwise result from Proxy-to-Target connection
establishment.[¶](#section-11.2-2){.pilcrow}
:::
:::

::: {#authentication}
::: {#section-11.3 .section}
### [11.3.](#section-11.3){.section-number .selfRef} [Authentication](#name-authentication){.section-name .selfRef} {#name-authentication}

Depending on the deployment scenario, Proxies and Targets might require
authentication before use. Regardless of the authentication mechanism in
place, Proxies [MUST NOT]{.bcp14} reveal any Client authentication
information to Targets. This is required so Targets cannot uniquely
identify individual Clients.[¶](#section-11.3-1){.pilcrow}

Note that if Targets require Proxies to authenticate at the HTTP or
application layer before use, this ought to be done before attempting to
forward any Client query to the Target. This will allow Proxies to
distinguish 401 (Unauthorized) response codes due to authentication
failure from 401 response codes due to Client key mismatch; see [Section
4.3](#oblivious-response){.xref}.[¶](#section-11.3-2){.pilcrow}
:::
:::
:::
:::

::: {#iana}
::: {#section-12 .section}
## [12.](#section-12){.section-number .selfRef} [IANA Considerations](#name-iana-considerations){.section-name .selfRef} {#name-iana-considerations}

This document makes changes to the \"Media Types\" registry. The changes
are described in the following subsection.[¶](#section-12-1){.pilcrow}

::: {#oblivious-doh-message-media-type}
::: {#section-12.1 .section}
### [12.1.](#section-12.1){.section-number .selfRef} [Oblivious DoH Message Media Type](#name-oblivious-doh-message-media){.section-name .selfRef} {#name-oblivious-doh-message-media}

This document registers a new media type,
\"application/oblivious-dns-message\".[¶](#section-12.1-1){.pilcrow}

[]{.break}

Type name:
:   application[¶](#section-12.1-2.2){.pilcrow}
:   

Subtype name:
:   oblivious-dns-message[¶](#section-12.1-2.4){.pilcrow}
:   

Required parameters:
:   N/A[¶](#section-12.1-2.6){.pilcrow}
:   

Optional parameters:
:   N/A[¶](#section-12.1-2.8){.pilcrow}
:   

Encoding considerations:
:   This is a binary format, containing encrypted DNS requests and
    responses encoded as `ObliviousDoHMessage` values, as defined in
    [Section 6.1](#encoding){.xref}.[¶](#section-12.1-2.10){.pilcrow}
:   

Security considerations:
:   See this document. The content is an encrypted DNS message, and not
    executable code.[¶](#section-12.1-2.12){.pilcrow}
:   

Interoperability considerations:
:   This document specifies the format of conforming messages and the
    interpretation thereof; see [Section
    6.1](#encoding){.xref}.[¶](#section-12.1-2.14){.pilcrow}
:   

Published specification:
:   This document[¶](#section-12.1-2.16){.pilcrow}
:   

Applications that use this media type:
:   This media type is intended to be used by Clients wishing to hide
    their DNS queries when using DNS over
    HTTPS.[¶](#section-12.1-2.18){.pilcrow}
:   

Additional information:
:   N/A[¶](#section-12.1-2.20){.pilcrow}
:   

Person and email address to contact for further information:
:   See the Authors\' Addresses
    section.[¶](#section-12.1-2.22){.pilcrow}
:   

Intended usage:
:   COMMON[¶](#section-12.1-2.24){.pilcrow}
:   

Restrictions on usage:
:   N/A[¶](#section-12.1-2.26){.pilcrow}
:   

Author:
:   Tommy Pauly (tpauly\@apple.com)[¶](#section-12.1-2.28){.pilcrow}
:   

Change controller:
:   IETF[¶](#section-12.1-2.30){.pilcrow}
:   

Provisional registration? (standards tree only):
:   No[¶](#section-12.1-2.32){.pilcrow}
:   
:::
:::
:::
:::

::: {#section-13 .section}
## [13.](#section-13){.section-number .selfRef} [References](#name-references){.section-name .selfRef} {#name-references}

::: {#section-13.1 .section}
### [13.1.](#section-13.1){.section-number .selfRef} [Normative References](#name-normative-references){.section-name .selfRef} {#name-normative-references}

\[HPKE\]
:   [Barnes, R.]{.refAuthor}, [Bhargavan, K.]{.refAuthor},
    [Lipp, B.]{.refAuthor}, and [C. Wood]{.refAuthor}, [\"Hybrid Public
    Key Encryption\"]{.refTitle}, [RFC 9180]{.seriesInfo}, [DOI
    10.17487/RFC9180]{.seriesInfo}, February 2022,
    \<<https://www.rfc-editor.org/info/rfc9180>\>.
:   

\[HTTP\]
:   [Fielding, R., Ed.]{.refAuthor}, [Nottingham, M., Ed.]{.refAuthor},
    and [J. Reschke, Ed.]{.refAuthor}, [\"HTTP Semantics\"]{.refTitle},
    [STD 97]{.seriesInfo}, [RFC 9110]{.seriesInfo}, [DOI
    10.17487/RFC9110]{.seriesInfo}, June 2022,
    \<<https://www.rfc-editor.org/info/rfc9110>\>.
:   

\[RFC2119\]
:   [Bradner, S.]{.refAuthor}, [\"Key words for use in RFCs to Indicate
    Requirement Levels\"]{.refTitle}, [BCP 14]{.seriesInfo}, [RFC
    2119]{.seriesInfo}, [DOI 10.17487/RFC2119]{.seriesInfo}, March 1997,
    \<<https://www.rfc-editor.org/info/rfc2119>\>.
:   

\[RFC4086\]
:   [Eastlake 3rd, D.]{.refAuthor}, [Schiller, J.]{.refAuthor}, and [S.
    Crocker]{.refAuthor}, [\"Randomness Requirements for
    Security\"]{.refTitle}, [BCP 106]{.seriesInfo}, [RFC
    4086]{.seriesInfo}, [DOI 10.17487/RFC4086]{.seriesInfo}, June 2005,
    \<<https://www.rfc-editor.org/info/rfc4086>\>.
:   

\[RFC6570\]
:   [Gregorio, J.]{.refAuthor}, [Fielding, R.]{.refAuthor},
    [Hadley, M.]{.refAuthor}, [Nottingham, M.]{.refAuthor}, and [D.
    Orchard]{.refAuthor}, [\"URI Template\"]{.refTitle}, [RFC
    6570]{.seriesInfo}, [DOI 10.17487/RFC6570]{.seriesInfo}, March 2012,
    \<<https://www.rfc-editor.org/info/rfc6570>\>.
:   

\[RFC8174\]
:   [Leiba, B.]{.refAuthor}, [\"Ambiguity of Uppercase vs Lowercase in
    RFC 2119 Key Words\"]{.refTitle}, [BCP 14]{.seriesInfo}, [RFC
    8174]{.seriesInfo}, [DOI 10.17487/RFC8174]{.seriesInfo}, May 2017,
    \<<https://www.rfc-editor.org/info/rfc8174>\>.
:   

\[RFC8446\]
:   [Rescorla, E.]{.refAuthor}, [\"The Transport Layer Security (TLS)
    Protocol Version 1.3\"]{.refTitle}, [RFC 8446]{.seriesInfo}, [DOI
    10.17487/RFC8446]{.seriesInfo}, August 2018,
    \<<https://www.rfc-editor.org/info/rfc8446>\>.
:   

\[RFC8467\]
:   [Mayrhofer, A.]{.refAuthor}, [\"Padding Policies for Extension
    Mechanisms for DNS (EDNS(0))\"]{.refTitle}, [RFC 8467]{.seriesInfo},
    [DOI 10.17487/RFC8467]{.seriesInfo}, October 2018,
    \<<https://www.rfc-editor.org/info/rfc8467>\>.
:   

\[RFC8484\]
:   [Hoffman, P.]{.refAuthor} and [P. McManus]{.refAuthor}, [\"DNS
    Queries over HTTPS (DoH)\"]{.refTitle}, [RFC 8484]{.seriesInfo},
    [DOI 10.17487/RFC8484]{.seriesInfo}, October 2018,
    \<<https://www.rfc-editor.org/info/rfc8484>\>.
:   

\[RFC9209\]
:   [Nottingham, M.]{.refAuthor} and [P. Sikora]{.refAuthor}, [\"The
    Proxy-Status HTTP Response Header Field\"]{.refTitle}, [RFC
    9209]{.seriesInfo}, [DOI 10.17487/RFC9209]{.seriesInfo}, June 2022,
    \<<https://www.rfc-editor.org/info/rfc9209>\>.
:   
:::

::: {#section-13.2 .section}
### [13.2.](#section-13.2){.section-number .selfRef} [Informative References](#name-informative-references){.section-name .selfRef} {#name-informative-references}

\[Dolev-Yao\]
:   [Dolev, D.]{.refAuthor} and [A. C. Yao]{.refAuthor}, [\"On the
    Security of Public Key Protocols\"]{.refTitle}, [IEEE Transactions
    on Information Theory, Vol. IT-29, No. 2]{.refContent}, [DOI
    10.1109/TIT.1983.1056650]{.seriesInfo}, March 1983,
    \<<https://www.cs.huji.ac.il/~dolev/pubs/dolev-yao-ieee-01056650.pdf>\>.
:   

\[OBLIVIOUS-DNS\]
:   [Edmundson, A.]{.refAuthor}, [Schmitt, P.]{.refAuthor},
    [Feamster, N.]{.refAuthor}, and [A. Mankin]{.refAuthor},
    [\"Oblivious DNS - Strong Privacy for DNS Queries\"]{.refTitle},
    [Work in Progress]{.refContent}, [Internet-Draft,
    draft-annee-dprive-oblivious-dns-00]{.seriesInfo}, 2 July 2018,
    \<<https://datatracker.ietf.org/doc/html/draft-annee-dprive-oblivious-dns-00>\>.
:   

\[OHTP\]
:   [Thomson, M.]{.refAuthor} and [C.A. Wood]{.refAuthor}, [\"Oblivious
    HTTP\"]{.refTitle}, [Work in Progress]{.refContent},
    [Internet-Draft, draft-ietf-ohai-ohttp-01]{.seriesInfo}, 15 February
    2022,
    \<<https://datatracker.ietf.org/doc/html/draft-ietf-ohai-ohttp-01>\>.
:   

\[RFC7239\]
:   [Petersson, A.]{.refAuthor} and [M. Nilsson]{.refAuthor},
    [\"Forwarded HTTP Extension\"]{.refTitle}, [RFC 7239]{.seriesInfo},
    [DOI 10.17487/RFC7239]{.seriesInfo}, June 2014,
    \<<https://www.rfc-editor.org/info/rfc7239>\>.
:   

\[RFC7871\]
:   [Contavalli, C.]{.refAuthor}, [van der Gaast, W.]{.refAuthor},
    [Lawrence, D.]{.refAuthor}, and [W. Kumari]{.refAuthor}, [\"Client
    Subnet in DNS Queries\"]{.refTitle}, [RFC 7871]{.seriesInfo}, [DOI
    10.17487/RFC7871]{.seriesInfo}, May 2016,
    \<<https://www.rfc-editor.org/info/rfc7871>\>.
:   
:::
:::

::: {#use-of-generic-proxy-services}
::: {#appendix-A .section}
## [Appendix A.](#appendix-A){.section-number .selfRef} [Use of Generic Proxy Services](#name-use-of-generic-proxy-servic){.section-name .selfRef} {#name-use-of-generic-proxy-servic}

Using DoH over anonymizing proxy services such as Tor can also achieve
the desired goal of separating query origins from their contents.
However, there are several reasons why such systems are undesirable as
contrasted with Oblivious DoH:[¶](#appendix-A-1){.pilcrow}

1.  [Tor is meant to be a generic connection-level anonymity system, and
    it incurs higher latency costs and protocol complexity for the
    purpose of proxying individual DNS queries. In contrast, Oblivious
    DoH is a lightweight protocol built on DoH, implemented as an
    application-layer proxy, that can be enabled as a default mode for
    users that need increased
    privacy.[¶](#appendix-A-2.1){.pilcrow}]{#appendix-A-2.1}
2.  [As a one-hop proxy, Oblivious DoH encourages connectionless proxies
    to mitigate Client query correlation with few round trips. In
    contrast, multi-hop systems such as Tor often run secure connections
    (TLS) end to end, which means that DoH servers could track queries
    over the same connection. Using a fresh DoH connection per query
    would incur a non-negligible penalty in connection setup
    time.[¶](#appendix-A-2.2){.pilcrow}]{#appendix-A-2.2}
:::
:::

::: {#acknowledgments}
::: {#appendix-B .section}
## [Acknowledgments](#name-acknowledgments){.section-name .selfRef} {#name-acknowledgments}

This work is inspired by Oblivious DNS
\[[OBLIVIOUS-DNS](#I-D.annee-dprive-oblivious-dns){.xref}\]. Thanks to
all of the authors of that document. Thanks to [Nafeez
Ahamed]{.contact-name}, [Elliot Briggs]{.contact-name}, [Marwan
Fayed]{.contact-name}, [Jonathan Hoyland]{.contact-name}, [Frederic
Jacobs]{.contact-name}, [Tommy Jensen]{.contact-name}, [Erik
Nygren]{.contact-name}, [Paul Schmitt]{.contact-name}, [Brian
Swander]{.contact-name}, and [Peter Wu]{.contact-name} for their
feedback and input.[¶](#appendix-B-1){.pilcrow}
:::
:::

::: {#authors-addresses}
::: {#appendix-C .section}
## [Authors\' Addresses](#name-authors-addresses){.section-name .selfRef} {#name-authors-addresses}

::: {.left dir="auto"}
[Eric Kinnear]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Apple Inc.]{.org}
:::

::: {.left dir="auto"}
[One Apple Park Way]{.street-address}
:::

::: {.left dir="auto"}
[Cupertino]{.locality}, [California]{.region} [95014]{.postal-code}
:::

::: {.left dir="auto"}
[United States of America]{.country-name}
:::

::: email
Email: <ekinnear@apple.com>
:::

::: {.left dir="auto"}
[Patrick McManus]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Fastly]{.org}
:::

::: email
Email: <mcmanus@ducksong.com>
:::

::: {.left dir="auto"}
[Tommy Pauly]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Apple Inc.]{.org}
:::

::: {.left dir="auto"}
[One Apple Park Way]{.street-address}
:::

::: {.left dir="auto"}
[Cupertino]{.locality}, [California]{.region} [95014]{.postal-code}
:::

::: {.left dir="auto"}
[United States of America]{.country-name}
:::

::: email
Email: <tpauly@apple.com>
:::

::: {.left dir="auto"}
[Tanya Verma]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Cloudflare]{.org}
:::

::: {.left dir="auto"}
[101 Townsend St]{.street-address}
:::

::: {.left dir="auto"}
[San Francisco]{.locality}, [California]{.region} [94107]{.postal-code}
:::

::: {.left dir="auto"}
[United States of America]{.country-name}
:::

::: email
Email: <vermatanyax@gmail.com>
:::

::: {.left dir="auto"}
[Christopher A. Wood]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Cloudflare]{.org}
:::

::: {.left dir="auto"}
[101 Townsend St]{.street-address}
:::

::: {.left dir="auto"}
[San Francisco]{.locality}, [California]{.region} [94107]{.postal-code}
:::

::: {.left dir="auto"}
[United States of America]{.country-name}
:::

::: email
Email: <caw@heapingbits.net>
:::
:::
:::
