  RFC 8952         Captive Portal Architecture   November 2020
  ---------------- ----------------------------- ---------------
  Larose, et al.   Informational                 \[Page\]

::: {#external-metadata .document-information}
:::

::: {#internal-metadata .document-information}

Stream:
:   Internet Engineering Task Force (IETF)

RFC:
:   [8952](https://www.rfc-editor.org/rfc/rfc8952){.eref}

Category:
:   Informational

Published:
:   November 2020

ISSN:
:   2070-1721

Authors:

:   ::: author
    ::: author-name
    K. Larose
    :::

    ::: org
    Agilicus
    :::
    :::

    ::: author
    ::: author-name
    D. Dolson
    :::
    :::

    ::: author
    ::: author-name
    H. Liu
    :::

    ::: org
    Google
    :::
    :::
:::

# RFC 8952 {#rfcnum}

# Captive Portal Architecture {#title}

::: {#section-abstract .section}
## [Abstract](#abstract){.selfRef}

This document describes a captive portal architecture. Network
provisioning protocols such as DHCP or Router Advertisements (RAs), an
optional signaling protocol, and an HTTP API are used to provide the
solution.[¶](#section-abstract-1){.pilcrow}
:::

::: {#status-of-memo}
::: {#section-boilerplate.1 .section}
## [Status of This Memo](#name-status-of-this-memo){.section-name .selfRef} {#name-status-of-this-memo}

This document is not an Internet Standards Track specification; it is
published for informational
purposes.[¶](#section-boilerplate.1-1){.pilcrow}

This document is a product of the Internet Engineering Task Force
(IETF). It represents the consensus of the IETF community. It has
received public review and has been approved for publication by the
Internet Engineering Steering Group (IESG). Not all documents approved
by the IESG are candidates for any level of Internet Standard; see
Section 2 of RFC 7841.[¶](#section-boilerplate.1-2){.pilcrow}

Information about the current status of this document, any errata, and
how to provide feedback on it may be obtained at
<https://www.rfc-editor.org/info/rfc8952>.[¶](#section-boilerplate.1-3){.pilcrow}
:::
:::

::: {#copyright}
::: {#section-boilerplate.2 .section}
## [Copyright Notice](#name-copyright-notice){.section-name .selfRef} {#name-copyright-notice}

Copyright (c) 2020 IETF Trust and the persons identified as the document
authors. All rights reserved.[¶](#section-boilerplate.2-1){.pilcrow}

This document is subject to BCP 78 and the IETF Trust\'s Legal
Provisions Relating to IETF Documents
(<https://trustee.ietf.org/license-info>) in effect on the date of
publication of this document. Please review these documents carefully,
as they describe your rights and restrictions with respect to this
document. Code Components extracted from this document must include
Simplified BSD License text as described in Section 4.e of the Trust
Legal Provisions and are provided without warranty as described in the
Simplified BSD License.[¶](#section-boilerplate.2-2){.pilcrow}
:::
:::

::: {#toc}
::: {#section-toc.1 .section}
[▲](#){.toplink}

## [Table of Contents](#name-table-of-contents){.section-name .selfRef} {#name-table-of-contents}

-   ::: {#section-toc.1-1.1}
    [1](#section-1){.xref}.  [Introduction](#name-introduction){.xref}[¶](#section-toc.1-1.1.1){.pilcrow}

    -   ::: {#section-toc.1-1.1.2.1}
        [1.1](#section-1.1){.xref}.  [Requirements
        Language](#name-requirements-language){.xref}[¶](#section-toc.1-1.1.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.1.2.2}
        [1.2](#section-1.2){.xref}.  [Terminology](#name-terminology){.xref}[¶](#section-toc.1-1.1.2.2.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.2}
    [2](#section-2){.xref}.  [Components](#name-components){.xref}[¶](#section-toc.1-1.2.1){.pilcrow}

    -   ::: {#section-toc.1-1.2.2.1}
        [2.1](#section-2.1){.xref}.  [User
        Equipment](#name-user-equipment){.xref}[¶](#section-toc.1-1.2.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.2.2.2}
        [2.2](#section-2.2){.xref}.  [Provisioning
        Service](#name-provisioning-service){.xref}[¶](#section-toc.1-1.2.2.2.1){.pilcrow}

        -   ::: {#section-toc.1-1.2.2.2.2.1}
            [2.2.1](#section-2.2.1){.xref}.  [DHCP or Router
            Advertisements](#name-dhcp-or-router-advertisemen){.xref}[¶](#section-toc.1-1.2.2.2.2.1.1){.pilcrow}
            :::

        -   ::: {#section-toc.1-1.2.2.2.2.2}
            [2.2.2](#section-2.2.2){.xref}.  [Provisioning
            Domains](#name-provisioning-domains){.xref}[¶](#section-toc.1-1.2.2.2.2.2.1){.pilcrow}
            :::
        :::

    -   ::: {#section-toc.1-1.2.2.3}
        [2.3](#section-2.3){.xref}.  [Captive Portal API
        Server](#name-captive-portal-api-server){.xref}[¶](#section-toc.1-1.2.2.3.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.2.2.4}
        [2.4](#section-2.4){.xref}.  [Captive Portal Enforcement
        Device](#name-captive-portal-enforcement-){.xref}[¶](#section-toc.1-1.2.2.4.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.2.2.5}
        [2.5](#section-2.5){.xref}.  [Captive Portal
        Signal](#name-captive-portal-signal){.xref}[¶](#section-toc.1-1.2.2.5.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.2.2.6}
        [2.6](#section-2.6){.xref}.  [Component
        Diagram](#name-component-diagram){.xref}[¶](#section-toc.1-1.2.2.6.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.3}
    [3](#section-3){.xref}.  [User Equipment
    Identity](#name-user-equipment-identity){.xref}[¶](#section-toc.1-1.3.1){.pilcrow}

    -   ::: {#section-toc.1-1.3.2.1}
        [3.1](#section-3.1){.xref}.  [Identifiers](#name-identifiers){.xref}[¶](#section-toc.1-1.3.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.2}
        [3.2](#section-3.2){.xref}.  [Recommended
        Properties](#name-recommended-properties){.xref}[¶](#section-toc.1-1.3.2.2.1){.pilcrow}

        -   ::: {#section-toc.1-1.3.2.2.2.1}
            [3.2.1](#section-3.2.1){.xref}.  [Uniquely Identify User
            Equipment](#name-uniquely-identify-user-equi){.xref}[¶](#section-toc.1-1.3.2.2.2.1.1){.pilcrow}
            :::

        -   ::: {#section-toc.1-1.3.2.2.2.2}
            [3.2.2](#section-3.2.2){.xref}.  [Hard to
            Spoof](#name-hard-to-spoof){.xref}[¶](#section-toc.1-1.3.2.2.2.2.1){.pilcrow}
            :::

        -   ::: {#section-toc.1-1.3.2.2.2.3}
            [3.2.3](#section-3.2.3){.xref}.  [Visible to the API
            Server](#name-visible-to-the-api-server){.xref}[¶](#section-toc.1-1.3.2.2.2.3.1){.pilcrow}
            :::

        -   ::: {#section-toc.1-1.3.2.2.2.4}
            [3.2.4](#section-3.2.4){.xref}.  [Visible to the Enforcement
            Device](#name-visible-to-the-enforcement-){.xref}[¶](#section-toc.1-1.3.2.2.2.4.1){.pilcrow}
            :::
        :::

    -   ::: {#section-toc.1-1.3.2.3}
        [3.3](#section-3.3){.xref}.  [Evaluating Types of
        Identifiers](#name-evaluating-types-of-identif){.xref}[¶](#section-toc.1-1.3.2.3.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.4}
        [3.4](#section-3.4){.xref}.  [Example Identifier
        Types](#name-example-identifier-types){.xref}[¶](#section-toc.1-1.3.2.4.1){.pilcrow}

        -   ::: {#section-toc.1-1.3.2.4.2.1}
            [3.4.1](#section-3.4.1){.xref}.  [Physical
            Interface](#name-physical-interface){.xref}[¶](#section-toc.1-1.3.2.4.2.1.1){.pilcrow}
            :::

        -   ::: {#section-toc.1-1.3.2.4.2.2}
            [3.4.2](#section-3.4.2){.xref}.  [IP
            Address](#name-ip-address){.xref}[¶](#section-toc.1-1.3.2.4.2.2.1){.pilcrow}
            :::

        -   ::: {#section-toc.1-1.3.2.4.2.3}
            [3.4.3](#section-3.4.3){.xref}.  [Media Access Control (MAC)
            Address](#name-media-access-control-mac-ad){.xref}[¶](#section-toc.1-1.3.2.4.2.3.1){.pilcrow}
            :::
        :::

    -   ::: {#section-toc.1-1.3.2.5}
        [3.5](#section-3.5){.xref}.  [Context-Free
        URI](#name-context-free-uri){.xref}[¶](#section-toc.1-1.3.2.5.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.4}
    [4](#section-4){.xref}.  [Solution
    Workflow](#name-solution-workflow){.xref}[¶](#section-toc.1-1.4.1){.pilcrow}

    -   ::: {#section-toc.1-1.4.2.1}
        [4.1](#section-4.1){.xref}.  [Initial
        Connection](#name-initial-connection){.xref}[¶](#section-toc.1-1.4.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.4.2.2}
        [4.2](#section-4.2){.xref}.  [Conditions about to
        Expire](#name-conditions-about-to-expire){.xref}[¶](#section-toc.1-1.4.2.2.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.4.2.3}
        [4.3](#section-4.3){.xref}.  [Handling of Changes in Portal
        URI](#name-handling-of-changes-in-port){.xref}[¶](#section-toc.1-1.4.2.3.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.5}
    [5](#section-5){.xref}.  [IANA
    Considerations](#name-iana-considerations){.xref}[¶](#section-toc.1-1.5.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.6}
    [6](#section-6){.xref}.  [Security
    Considerations](#name-security-considerations){.xref}[¶](#section-toc.1-1.6.1){.pilcrow}

    -   ::: {#section-toc.1-1.6.2.1}
        [6.1](#section-6.1){.xref}.  [Trusting the
        Network](#name-trusting-the-network){.xref}[¶](#section-toc.1-1.6.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.6.2.2}
        [6.2](#section-6.2){.xref}.  [Authenticated
        APIs](#name-authenticated-apis){.xref}[¶](#section-toc.1-1.6.2.2.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.6.2.3}
        [6.3](#section-6.3){.xref}.  [Secure
        APIs](#name-secure-apis){.xref}[¶](#section-toc.1-1.6.2.3.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.6.2.4}
        [6.4](#section-6.4){.xref}.  [Risks Associated with the
        Signaling
        Protocol](#name-risks-associated-with-the-s){.xref}[¶](#section-toc.1-1.6.2.4.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.6.2.5}
        [6.5](#section-6.5){.xref}.  [User
        Options](#name-user-options){.xref}[¶](#section-toc.1-1.6.2.5.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.6.2.6}
        [6.6](#section-6.6){.xref}.  [Privacy](#name-privacy){.xref}[¶](#section-toc.1-1.6.2.6.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.7}
    [7](#section-7){.xref}.  [References](#name-references){.xref}[¶](#section-toc.1-1.7.1){.pilcrow}

    -   ::: {#section-toc.1-1.7.2.1}
        [7.1](#section-7.1){.xref}.  [Normative
        References](#name-normative-references){.xref}[¶](#section-toc.1-1.7.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.7.2.2}
        [7.2](#section-7.2){.xref}.  [Informative
        References](#name-informative-references){.xref}[¶](#section-toc.1-1.7.2.2.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.8}
    [Appendix A](#section-appendix.a){.xref}.  [Existing Captive Portal
    Detection
    Implementations](#name-existing-captive-portal-det){.xref}[¶](#section-toc.1-1.8.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.9}
    [](#section-appendix.b){.xref}[Acknowledgments](#name-acknowledgments){.xref}[¶](#section-toc.1-1.9.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.10}
    [](#section-appendix.c){.xref}[Authors\'
    Addresses](#name-authors-addresses){.xref}[¶](#section-toc.1-1.10.1){.pilcrow}
    :::
:::
:::

::: {#section-1 .section}
## [1.](#section-1){.section-number .selfRef} [Introduction](#name-introduction){.section-name .selfRef} {#name-introduction}

In this document, \"Captive Portal\" is used to describe a network to
which a device may be voluntarily attached, such that network access is
limited until some requirements have been fulfilled. Typically, a user
is required to use a web browser to fulfill requirements imposed by the
network operator, such as reading advertisements, accepting an
acceptable-use policy, or providing some form of
credentials.[¶](#section-1-1){.pilcrow}

Implementations of captive portals generally require a web server, some
method to allow/block traffic, and some method to alert the user. Common
methods of alerting the user in implementations prior to this work
involve modifying HTTP or DNS traffic.[¶](#section-1-2){.pilcrow}

This document describes an architecture for implementing captive portals
while addressing most of the problems arising for current captive portal
mechanisms. The architecture is guided by these
requirements:[¶](#section-1-3){.pilcrow}

-   [Current captive portal solutions typically implement some
    variations of forging DNS or HTTP responses. Some attempt
    man-in-the-middle (MITM) proxy of HTTPS in order to forge responses.
    Captive portal solutions should not have to break any protocols or
    otherwise act in the manner of an attacker. Therefore, solutions
    [MUST NOT]{.bcp14} require the forging of responses from DNS or HTTP
    servers or from any other
    protocol.[¶](#section-1-4.1){.pilcrow}]{#section-1-4.1}
-   [Solutions [MUST]{.bcp14} permit clients to perform DNSSEC
    validation, which rules out solutions that forge DNS responses.
    Solutions [SHOULD]{.bcp14} permit clients to detect and avoid TLS
    man-in-the-middle attacks without requiring a human to perform any
    kind of \"exception\"
    processing.[¶](#section-1-4.2){.pilcrow}]{#section-1-4.2}
-   [To maximize universality and adoption, solutions [MUST]{.bcp14}
    operate at the layer of Internet Protocol (IP) or above, not being
    specific to any particular access technology such as cable, Wi-Fi,
    or mobile telecom.[¶](#section-1-4.3){.pilcrow}]{#section-1-4.3}
-   [Solutions [SHOULD]{.bcp14} allow a device to query the network to
    determine whether the device is captive, without the solution being
    coupled to forging intercepted protocols or requiring the device to
    make sacrificial queries to \"canary\" URIs to check for response
    tampering (see [Appendix A](#app-additional){.xref}). Current
    captive portal solutions that work by affecting DNS or HTTP
    generally only function as intended with browsers, breaking other
    applications using those protocols; applications using other
    protocols are not alerted that the network is a captive
    portal.[¶](#section-1-4.4){.pilcrow}]{#section-1-4.4}
-   [The state of captivity [SHOULD]{.bcp14} be explicitly available to
    devices via a standard protocol, rather than having to infer the
    state indirectly.[¶](#section-1-4.5){.pilcrow}]{#section-1-4.5}
-   [The architecture [MUST]{.bcp14} provide a path of incremental
    migration, acknowledging the existence of a huge variety of
    pre-existing portals and end-user device implementations and
    software versions. This requirement is not to recommend or
    standardize existing approaches, but rather to provide device and
    portal implementors a path to a new
    standard.[¶](#section-1-4.6){.pilcrow}]{#section-1-4.6}

A side benefit of the architecture described in this document is that
devices without user interfaces are able to identify parameters of
captivity. However, this document does not describe a mechanism for such
devices to negotiate for unrestricted network access. A future document
could provide a solution to devices without user interfaces. This
document focuses on devices with user
interfaces.[¶](#section-1-5){.pilcrow}

The architecture uses the following
mechanisms:[¶](#section-1-6){.pilcrow}

-   [Network provisioning protocols provide end-user devices with a
    Uniform Resource Identifier (URI) \[[RFC3986](#RFC3986){.xref}\] for
    the API that end-user devices query for information about what is
    required to escape captivity. DHCP, DHCPv6, and Router Advertisement
    options for this purpose are available in
    \[[RFC8910](#RFC8910){.xref}\]. Other protocols (such as RADIUS),
    Provisioning Domains
    \[[CAPPORT-PVD](#I-D.pfister-capport-pvd){.xref}\], or static
    configuration may also be used to convey this Captive Portal API
    URI. A device [MAY]{.bcp14} query this API at any time to determine
    whether the network is holding the device in a captive
    state.[¶](#section-1-7.1){.pilcrow}]{#section-1-7.1}
-   [A Captive Portal can signal User Equipment in response to
    transmissions by the User Equipment. This signal works in response
    to any Internet protocol and is not done by modifying protocols in
    band. This signal does not carry the Captive Portal API URI; rather,
    it provides a signal to the User Equipment that it is in a captive
    state.[¶](#section-1-7.2){.pilcrow}]{#section-1-7.2}
-   [Receipt of a Captive Portal Signal provides a hint that User
    Equipment could be captive. In response, the device [MAY]{.bcp14}
    query the provisioned API to obtain information about the network
    state. The device can take immediate action to satisfy the portal
    (according to its
    configuration/policy).[¶](#section-1-7.3){.pilcrow}]{#section-1-7.3}

The architecture attempts to provide confidentiality, authentication,
and safety mechanisms to the extent possible.[¶](#section-1-8){.pilcrow}

::: {#section-1.1 .section}
### [1.1.](#section-1.1){.section-number .selfRef} [Requirements Language](#name-requirements-language){.section-name .selfRef} {#name-requirements-language}

The key words \"[MUST]{.bcp14}\", \"[MUST NOT]{.bcp14}\",
\"[REQUIRED]{.bcp14}\", \"[SHALL]{.bcp14}\", \"[SHALL NOT]{.bcp14}\",
\"[SHOULD]{.bcp14}\", \"[SHOULD NOT]{.bcp14}\",
\"[RECOMMENDED]{.bcp14}\", \"[NOT RECOMMENDED]{.bcp14}\",
\"[MAY]{.bcp14}\", and \"[OPTIONAL]{.bcp14}\" in this document are to be
interpreted as described in BCP 14 \[[RFC2119](#RFC2119){.xref}\]
\[[RFC8174](#RFC8174){.xref}\] when, and only when, they appear in all
capitals, as shown here.[¶](#section-1.1-1){.pilcrow}
:::

::: {#section-1.2 .section}
### [1.2.](#section-1.2){.section-number .selfRef} [Terminology](#name-terminology){.section-name .selfRef} {#name-terminology}

[]{.break}

Captive Portal
:   A network that limits the communication of attached devices to
    restricted hosts until the user has satisfied Captive Portal
    Conditions, after which access is permitted to a wider set of hosts
    (typically the Internet).[¶](#section-1.2-1.2){.pilcrow}
:   

Captive Portal Conditions
:   Site-specific requirements that a user or device must satisfy in
    order to gain access to the wider
    network.[¶](#section-1.2-1.4){.pilcrow}
:   

Captive Portal Enforcement Device
:   The network equipment that enforces the traffic restriction. Also
    known as \"Enforcement Device\".[¶](#section-1.2-1.6){.pilcrow}
:   

Captive Portal User Equipment
:   A device that has voluntarily joined a network for purposes of
    communicating beyond the constraints of the Captive Portal. Also
    known as \"User Equipment\".[¶](#section-1.2-1.8){.pilcrow}
:   

User Portal
:   The web server providing a user interface for assisting the user in
    satisfying the conditions to escape
    captivity.[¶](#section-1.2-1.10){.pilcrow}
:   

Captive Portal API
:   An HTTP API allowing User Equipment to query information about its
    state of captivity within the Captive Portal. This information might
    include how to obtain full network access (e.g., by visiting a URI).
    Also known as \"API\".[¶](#section-1.2-1.12){.pilcrow}
:   

Captive Portal API Server
:   A server hosting the Captive Portal API. Also known as \"API
    Server\".[¶](#section-1.2-1.14){.pilcrow}
:   

Captive Portal Signal
:   A notification from the network used to signal to the User Equipment
    that the state of its captivity could have
    changed.[¶](#section-1.2-1.16){.pilcrow}
:   

Captive Portal Signaling Protocol
:   The protocol for communicating Captive Portal Signals. Also known as
    \"Signaling Protocol\".[¶](#section-1.2-1.18){.pilcrow}
:   

Captive Portal Session
:   Also referred to simply as the \"Session\", a Captive Portal Session
    is the association for a particular User Equipment instance that
    starts when it interacts with the Captive Portal and gains open
    access to the network and ends when the User Equipment moves back
    into the original captive state. The Captive Network maintains the
    state of each active Session and can limit Sessions based on a
    length of time or a number of bytes used. The Session is associated
    with a particular User Equipment instance using the User
    Equipment\'s identifier (see [Section
    3](#ue_identity){.xref}).[¶](#section-1.2-1.20){.pilcrow}
:   
:::
:::

::: {#section-2 .section}
## [2.](#section-2){.section-number .selfRef} [Components](#name-components){.section-name .selfRef} {#name-components}

::: {#section_client}
::: {#section-2.1 .section}
### [2.1.](#section-2.1){.section-number .selfRef} [User Equipment](#name-user-equipment){.section-name .selfRef} {#name-user-equipment}

The User Equipment is the device that a user desires to be attached to a
network with full access to all hosts on the network (e.g., to have
Internet access). The User Equipment communication is typically
restricted by the Enforcement Device, described in [Section
2.4](#section_capport_enforcement){.xref}, until site-specific
requirements have been met.[¶](#section-2.1-1){.pilcrow}

This document only considers devices with web browsers, with web
applications being the means of satisfying Captive Portal Conditions. An
example of such User Equipment is a smart
phone.[¶](#section-2.1-2){.pilcrow}

The User Equipment:[¶](#section-2.1-3){.pilcrow}

-   [[SHOULD]{.bcp14} support provisioning of the URI for the Captive
    Portal API (e.g., by
    DHCP).[¶](#section-2.1-4.1){.pilcrow}]{#section-2.1-4.1}
-   [[SHOULD]{.bcp14} distinguish Captive Portal API access per network
    interface, in the manner of Provisioning Domain Architecture
    \[[RFC7556](#RFC7556){.xref}\].[¶](#section-2.1-4.2){.pilcrow}]{#section-2.1-4.2}
-   [[SHOULD]{.bcp14} have a non-spoofable mechanism for notifying the
    user of the Captive
    Portal.[¶](#section-2.1-4.3){.pilcrow}]{#section-2.1-4.3}
-   [[SHOULD]{.bcp14} have a web browser so that the user may navigate
    to the User
    Portal.[¶](#section-2.1-4.4){.pilcrow}]{#section-2.1-4.4}
-   [[SHOULD]{.bcp14} support updates to the Captive Portal API URI from
    the Provisioning
    Service.[¶](#section-2.1-4.5){.pilcrow}]{#section-2.1-4.5}
-   [[MAY]{.bcp14} prevent applications from using networks that do not
    grant full network access. For example, a device connected to a
    mobile network may be connecting to a captive Wi-Fi network; the
    operating system could avoid updating the default route to a device
    on the captive Wi-Fi network until network access restrictions have
    been lifted (excepting access to the User Portal) in the new
    network. This has been termed \"make before
    break\".[¶](#section-2.1-4.6){.pilcrow}]{#section-2.1-4.6}

None of the above requirements are mandatory because (a) we do not wish
to say users or devices must seek full access to the Captive Portal, (b)
the requirements may be fulfilled by manually visiting the captive
portal web application, and (c) legacy devices must continue to be
supported.[¶](#section-2.1-5){.pilcrow}

If User Equipment supports the Captive Portal API, it [MUST]{.bcp14}
validate the API Server\'s TLS certificate (see
\[[RFC2818](#RFC2818){.xref}\]) according to the procedures in
\[[RFC6125](#RFC6125){.xref}\]. The API Server\'s URI is obtained via a
network provisioning protocol, which will typically provide a hostname
to be used in TLS server certificate validation, against a DNS-ID in the
server certificate. If the API Server is identified by IP address, the
iPAddress subjectAltName is used to validate the server certificate. An
Enforcement Device [SHOULD]{.bcp14} allow access to any services that
User Equipment could need to contact to perform certificate validation,
such as Online Certificate Status Protocol (OCSP) responders,
Certificate Revocation Lists (CRLs), and NTP servers; see [Section
4.1](https://www.rfc-editor.org/rfc/rfc8908#section-4.1){.relref} of
\[[RFC8908](#RFC8908){.xref}\] for more information. If certificate
validation fails, User Equipment [MUST NOT]{.bcp14} make any calls to
the API Server.[¶](#section-2.1-6){.pilcrow}

The User Equipment can store the last response it received from the
Captive Portal API as a cached view of its state within the Captive
Portal. This state can be used to determine whether its Captive Portal
Session is near expiry. For example, the User Equipment might compare a
timestamp indicating when the Session expires to the current time.
Storing state in this way can reduce the need for communication with the
Captive Portal API. However, it could lead to the state becoming stale
if the User Equipment\'s view of the relevant conditions (byte quota,
for example) is not consistent with the Captive Portal
API\'s.[¶](#section-2.1-7){.pilcrow}
:::
:::

::: {#section_provisioning}
::: {#section-2.2 .section}
### [2.2.](#section-2.2){.section-number .selfRef} [Provisioning Service](#name-provisioning-service){.section-name .selfRef} {#name-provisioning-service}

The Provisioning Service is primarily responsible for providing a
Captive Portal API URI to the User Equipment when it connects to the
network, and later if the URI changes. The Provisioning Service could
also be the same service that is responsible for provisioning the User
Equipment for access to the Captive Portal (e.g., by providing it with
an IP address). This section discusses two mechanisms that may be used
to provide the Captive Portal API URI to the User
Equipment.[¶](#section-2.2-1){.pilcrow}

::: {#section_dhcp}
::: {#section-2.2.1 .section}
#### [2.2.1.](#section-2.2.1){.section-number .selfRef} [DHCP or Router Advertisements](#name-dhcp-or-router-advertisemen){.section-name .selfRef} {#name-dhcp-or-router-advertisemen}

A standard for providing a Captive Portal API URI using DHCP or Router
Advertisements is described in \[[RFC8910](#RFC8910){.xref}\]. The
captive portal architecture expects this URI to indicate the API
described in [Section
2.3](#section_api){.xref}.[¶](#section-2.2.1-1){.pilcrow}
:::
:::

::: {#section_pvd}
::: {#section-2.2.2 .section}
#### [2.2.2.](#section-2.2.2){.section-number .selfRef} [Provisioning Domains](#name-provisioning-domains){.section-name .selfRef} {#name-provisioning-domains}

\[[CAPPORT-PVD](#I-D.pfister-capport-pvd){.xref}\] proposes a mechanism
for User Equipment to be provided with Provisioning Domain (PvD)
Bootstrap Information containing the URI for the API described in
[Section 2.3](#section_api){.xref}.[¶](#section-2.2.2-1){.pilcrow}
:::
:::
:::
:::

::: {#section_api}
::: {#section-2.3 .section}
### [2.3.](#section-2.3){.section-number .selfRef} [Captive Portal API Server](#name-captive-portal-api-server){.section-name .selfRef} {#name-captive-portal-api-server}

The purpose of a Captive Portal API is to permit a query of Captive
Portal state without interrupting the user. This API thereby removes the
need for User Equipment to perform clear-text \"canary\" (see [Appendix
A](#app-additional){.xref}) queries to check for response
tampering.[¶](#section-2.3-1){.pilcrow}

The URI of this API will have been provisioned to the User Equipment.
(Refer to [Section
2.2](#section_provisioning){.xref}.)[¶](#section-2.3-2){.pilcrow}

This architecture expects the User Equipment to query the API when the
User Equipment attaches to the network and multiple times thereafter.
Therefore, the API [MUST]{.bcp14} support multiple repeated queries from
the same User Equipment and return the state of captivity for the
equipment.[¶](#section-2.3-3){.pilcrow}

At minimum, the API [MUST]{.bcp14} provide the state of captivity.
Further, the API [MUST]{.bcp14} be able to provide a URI for the User
Portal. The scheme for the URI [MUST]{.bcp14} be \"https\" so that the
User Equipment communicates with the User Portal over
TLS.[¶](#section-2.3-4){.pilcrow}

If the API receives a request for state that does not correspond to the
requesting User Equipment, the API [SHOULD]{.bcp14} deny access. Given
that the API might use the User Equipment\'s identifier for
authentication, this requirement motivates [Section
3.2.2](#id_recommended_hard){.xref}.[¶](#section-2.3-5){.pilcrow}

A caller to the API needs to be presented with evidence that the content
it is receiving is for a version of the API that it supports. For an
HTTP-based interaction, such as in \[[RFC8908](#RFC8908){.xref}\], this
might be achieved by using a content type that is unique to the
protocol.[¶](#section-2.3-6){.pilcrow}

When User Equipment receives Captive Portal Signals, the User Equipment
[MAY]{.bcp14} query the API to check its state of captivity. The User
Equipment [SHOULD]{.bcp14} rate-limit these API queries in the event of
the signal being flooded. (See [Section
6](#Security){.xref}.)[¶](#section-2.3-7){.pilcrow}

The API [MUST]{.bcp14} be extensible to support future use cases by
allowing extensible information elements.[¶](#section-2.3-8){.pilcrow}

The API [MUST]{.bcp14} use TLS to ensure server authentication. The
implementation of the API [MUST]{.bcp14} ensure both confidentiality and
integrity of any information provided by or required by
it.[¶](#section-2.3-9){.pilcrow}

This document does not specify the details of the
API.[¶](#section-2.3-10){.pilcrow}
:::
:::

::: {#section_capport_enforcement}
::: {#section-2.4 .section}
### [2.4.](#section-2.4){.section-number .selfRef} [Captive Portal Enforcement Device](#name-captive-portal-enforcement-){.section-name .selfRef} {#name-captive-portal-enforcement-}

The Enforcement Device component restricts the network access of User
Equipment according to the site-specific policy. Typically, User
Equipment is permitted access to a small number of services (according
to the policies of the network provider) and is denied general network
access until it satisfies the Captive Portal
Conditions.[¶](#section-2.4-1){.pilcrow}

The Enforcement Device component:[¶](#section-2.4-2){.pilcrow}

-   [Allows traffic to pass for User Equipment that is permitted to use
    the network and has satisfied the Captive Portal
    Conditions.[¶](#section-2.4-3.1){.pilcrow}]{#section-2.4-3.1}
-   [Blocks (discards) traffic according to the site-specific policy for
    User Equipment that has not yet satisfied the Captive Portal
    Conditions.[¶](#section-2.4-3.2){.pilcrow}]{#section-2.4-3.2}
-   [Optionally signals User Equipment using the Captive Portal
    Signaling Protocol if certain traffic is
    blocked.[¶](#section-2.4-3.3){.pilcrow}]{#section-2.4-3.3}
-   [Permits User Equipment that has not satisfied the Captive Portal
    Conditions to access necessary APIs and web pages to fulfill
    requirements for escaping
    captivity.[¶](#section-2.4-3.4){.pilcrow}]{#section-2.4-3.4}
-   [Updates allow/block rules per User Equipment in response to
    operations from the User
    Portal.[¶](#section-2.4-3.5){.pilcrow}]{#section-2.4-3.5}
:::
:::

::: {#section_signal}
::: {#section-2.5 .section}
### [2.5.](#section-2.5){.section-number .selfRef} [Captive Portal Signal](#name-captive-portal-signal){.section-name .selfRef} {#name-captive-portal-signal}

When User Equipment first connects to a network, or when there are
changes in status, the Enforcement Device could generate a signal toward
the User Equipment. This signal indicates that the User Equipment might
need to contact the API Server to receive updated information. For
instance, this signal might be generated when the end of a Session is
imminent or when network access was denied. For simplicity, and to
reduce the attack surface, all signals [SHOULD]{.bcp14} be considered
equivalent by the User Equipment as a hint to contact the API. If future
solutions have multiple signal types, each type [SHOULD]{.bcp14} be
rate-limited independently.[¶](#section-2.5-1){.pilcrow}

An Enforcement Device [MUST]{.bcp14} rate-limit any signal generated in
response to these conditions. See [Section
6.4](#section_signal_risks){.xref} for a discussion of risks related to
a Captive Portal Signal.[¶](#section-2.5-2){.pilcrow}
:::
:::

::: {#section-2.6 .section}
### [2.6.](#section-2.6){.section-number .selfRef} [Component Diagram](#name-component-diagram){.section-name .selfRef} {#name-component-diagram}

The following diagram shows the communication between each component in
the case where the Captive Portal has a User Portal and the User
Equipment chooses to visit the User Portal in response to discovering
and interacting with the API Server.[¶](#section-2.6-1){.pilcrow}

[]{#name-captive-portal-architecture}

::: {#components}
::: {#section-2.6-2.1 .artwork .art-text .alignLeft}
    o . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . o
    . CAPTIVE PORTAL                                                .
    . +------------+  Join Network               +--------------+   .
    . |            |+--------------------------->| Provisioning |   .
    . |            |  Provision API URI          |  Service     |   .
    . |            |<---------------------------+|              |   .
    . |   User     |                             +--------------+   .
    . | Equipment  |  Query captivity status     +-------------+    .
    . |            |+--------------------------->|  API        |    .
    . |            |  Captivity status response  |  Server     |    .
    . |            |<---------------------------+|             |    .
    . |            |                             +------+------+    .
    . |            |                                    | Status    .
    . |            | Portal UI page requests     +------+------+    .
    . |            |+--------------------------->|             |    .
    . |            | Portal UI pages             | User Portal |    .
    . |            |<---------------------------+|             |    .
    . +------------+                             |             |    .
    .     ^   ^ |                                +-------------+    .
    .     |   | | Data to/from ext. network               |         .
    .     |   | +-----------------> +---------------+  Allow/Deny   .
    .     |   +--------------------+|               |    Rules      .
    .     |                         | Enforcement   |     |         .
    .     |   Captive Portal Signal | Device        |<----+         .
    .     +-------------------------+---------------+               .
    .                                      ^ |                      .
    .                                      | |                      .
    .                          Data to/from external network        .
    .                                      | |                      .
    o . . . . . . . . . . . . . . . . . . .| |. . . . . . . . . . . o
                                           | v
                                      EXTERNAL NETWORK
:::

[Figure 1](#figure-1){.selfRef}: [Captive Portal Architecture Component
Diagram](#name-captive-portal-architecture){.selfRef}
:::

In the diagram:[¶](#section-2.6-3){.pilcrow}

-   [During provisioning (e.g., DHCP), and possibly later, the User
    Equipment acquires the Captive Portal API
    URI.[¶](#section-2.6-4.1){.pilcrow}]{#section-2.6-4.1}
-   [The User Equipment queries the API to learn of its state of
    captivity. If captive, the User Equipment presents the portal user
    interface from the User Portal to the
    user.[¶](#section-2.6-4.2){.pilcrow}]{#section-2.6-4.2}
-   [Based on user interaction, the User Portal directs the Enforcement
    Device to either allow or deny external network access for the User
    Equipment.[¶](#section-2.6-4.3){.pilcrow}]{#section-2.6-4.3}
-   [The User Equipment attempts to communicate to the external network
    through the Enforcement
    Device.[¶](#section-2.6-4.4){.pilcrow}]{#section-2.6-4.4}
-   [The Enforcement Device either allows the User Equipment\'s packets
    to the external network or blocks the packets. If blocking traffic
    and a signal has been implemented, it may respond with a Captive
    Portal Signal.[¶](#section-2.6-4.5){.pilcrow}]{#section-2.6-4.5}

The Provisioning Service, API Server, and User Portal are described as
discrete functions. An implementation might provide the multiple
functions within a single entity. Furthermore, these functions, combined
or not, as well as the Enforcement Device, could be replicated for
redundancy or scale.[¶](#section-2.6-5){.pilcrow}
:::
:::

::: {#ue_identity}
::: {#section-3 .section}
## [3.](#section-3){.section-number .selfRef} [User Equipment Identity](#name-user-equipment-identity){.section-name .selfRef} {#name-user-equipment-identity}

Multiple components in the architecture interact with both the User
Equipment and each other. Since the User Equipment is the focus of these
interactions, the components must be able to both identify the User
Equipment from their interactions with it and agree on the identity of
the User Equipment when interacting with each
other.[¶](#section-3-1){.pilcrow}

The methods by which the components interact restrict the type of
information that may be used as an identifying characteristic. This
section discusses the identifying
characteristics.[¶](#section-3-2){.pilcrow}

::: {#id_identifiers}
::: {#section-3.1 .section}
### [3.1.](#section-3.1){.section-number .selfRef} [Identifiers](#name-identifiers){.section-name .selfRef} {#name-identifiers}

An identifier is a characteristic of the User Equipment used by the
components of a Captive Portal to uniquely determine which specific User
Equipment instance is interacting with them. An identifier can be a
field contained in packets sent by the User Equipment to the external
network. Or, an identifier can be an ephemeral property not contained in
packets destined for the external network, but instead correlated with
such information through knowledge available to the different
components.[¶](#section-3.1-1){.pilcrow}
:::
:::

::: {#id_recommended_props}
::: {#section-3.2 .section}
### [3.2.](#section-3.2){.section-number .selfRef} [Recommended Properties](#name-recommended-properties){.section-name .selfRef} {#name-recommended-properties}

The set of possible identifiers is quite large. However, in order to be
considered a good identifier, an identifier [SHOULD]{.bcp14} meet the
following criteria. Note that the optimal identifier will likely change
depending on the position of the components in the network as well as
the information available to them. An identifier
[SHOULD]{.bcp14}:[¶](#section-3.2-1){.pilcrow}

-   [uniquely identify the User
    Equipment[¶](#section-3.2-2.1){.pilcrow}]{#section-3.2-2.1}
-   [be hard to spoof[¶](#section-3.2-2.2){.pilcrow}]{#section-3.2-2.2}
-   [be visible to the API
    Server[¶](#section-3.2-2.3){.pilcrow}]{#section-3.2-2.3}
-   [be visible to the Enforcement
    Device[¶](#section-3.2-2.4){.pilcrow}]{#section-3.2-2.4}

An identifier might only apply to the current point of network
attachment. If the device moves to a different network location, its
identity could change.[¶](#section-3.2-3){.pilcrow}

::: {#id_recommended_unique}
::: {#section-3.2.1 .section}
#### [3.2.1.](#section-3.2.1){.section-number .selfRef} [Uniquely Identify User Equipment](#name-uniquely-identify-user-equi){.section-name .selfRef} {#name-uniquely-identify-user-equi}

The Captive Portal [MUST]{.bcp14} associate the User Equipment with an
identifier that is unique among all of the User Equipment interacting
with the Captive Portal at that time.[¶](#section-3.2.1-1){.pilcrow}

Over time, the User Equipment assigned to an identifier value
[MAY]{.bcp14} change. Allowing the identified device to change over time
ensures that the space of possible identifying values need not be overly
large.[¶](#section-3.2.1-2){.pilcrow}

Independent Captive Portals [MAY]{.bcp14} use the same identifying value
to identify different User Equipment instances. Allowing independent
captive portals to reuse identifying values allows the identifier to be
a property of the local network, expanding the space of possible
identifiers.[¶](#section-3.2.1-3){.pilcrow}
:::
:::

::: {#id_recommended_hard}
::: {#section-3.2.2 .section}
#### [3.2.2.](#section-3.2.2){.section-number .selfRef} [Hard to Spoof](#name-hard-to-spoof){.section-name .selfRef} {#name-hard-to-spoof}

A good identifier does not lend itself to being easily spoofed. At no
time should it be simple or straightforward for one User Equipment
instance to pretend to be another User Equipment instance, regardless of
whether both are active at the same time. This property is particularly
important when the User Equipment identifier is referenced externally by
devices such as billing systems or when the identity of the User
Equipment could imply liability.[¶](#section-3.2.2-1){.pilcrow}
:::
:::

::: {#id_recommended_visible_api}
::: {#section-3.2.3 .section}
#### [3.2.3.](#section-3.2.3){.section-number .selfRef} [Visible to the API Server](#name-visible-to-the-api-server){.section-name .selfRef} {#name-visible-to-the-api-server}

Since the API Server will need to perform operations that rely on the
identity of the User Equipment, such as answering a query about whether
the User Equipment is captive, the API Server needs to be able to relate
a request to the User Equipment making the
request.[¶](#section-3.2.3-1){.pilcrow}
:::
:::

::: {#id_recommended_visible_ed}
::: {#section-3.2.4 .section}
#### [3.2.4.](#section-3.2.4){.section-number .selfRef} [Visible to the Enforcement Device](#name-visible-to-the-enforcement-){.section-name .selfRef} {#name-visible-to-the-enforcement-}

The Enforcement Device will decide on a per-packet basis whether the
packet should be forwarded to the external network. Since this decision
depends on which User Equipment instance sent the packet, the
Enforcement Device requires that it be able to map the packet to its
concept of the User Equipment.[¶](#section-3.2.4-1){.pilcrow}
:::
:::
:::
:::

::: {#id_evaluating}
::: {#section-3.3 .section}
### [3.3.](#section-3.3){.section-number .selfRef} [Evaluating Types of Identifiers](#name-evaluating-types-of-identif){.section-name .selfRef} {#name-evaluating-types-of-identif}

To evaluate whether a type of identifier is appropriate, one should
consider every recommended property from the perspective of interactions
among the components in the architecture. When comparing identifier
types, choose the one that best satisfies all of the recommended
properties. The architecture does not provide an exact measure of how
well an identifier type satisfies a given property; care should be taken
in performing the evaluation.[¶](#section-3.3-1){.pilcrow}
:::
:::

::: {#id_examples}
::: {#section-3.4 .section}
### [3.4.](#section-3.4){.section-number .selfRef} [Example Identifier Types](#name-example-identifier-types){.section-name .selfRef} {#name-example-identifier-types}

This section provides some example identifier types, along with some
evaluation of whether they are suitable types. The list of identifier
types is not exhaustive; other types may be used. An important point to
note is that whether a given identifier type is suitable depends heavily
on the capabilities of the components and where in the network the
components exist.[¶](#section-3.4-1){.pilcrow}

::: {#id_example_interface}
::: {#section-3.4.1 .section}
#### [3.4.1.](#section-3.4.1){.section-number .selfRef} [Physical Interface](#name-physical-interface){.section-name .selfRef} {#name-physical-interface}

The physical interface by which the User Equipment is attached to the
network can be used to identify the User Equipment. This identifier type
has the property of being extremely difficult to spoof: the User
Equipment is unaware of the property; one User Equipment instance cannot
manipulate its interactions to appear as though it is
another.[¶](#section-3.4.1-1){.pilcrow}

Further, if only a single User Equipment instance is attached to a given
physical interface, then the identifier will be unique. If multiple User
Equipment instances are attached to the network on the same physical
interface, then this type is not
appropriate.[¶](#section-3.4.1-2){.pilcrow}

Another consideration related to uniqueness of the User Equipment is
that if the attached User Equipment changes, both the API Server and the
Enforcement Device [MUST]{.bcp14} invalidate their state related to the
User Equipment.[¶](#section-3.4.1-3){.pilcrow}

The Enforcement Device needs to be aware of the physical interface,
which constrains the environment; it must either be part of the device
providing physical access (e.g., implemented in firmware), or packets
traversing the network must be extended to include information about the
source physical interface (e.g., a
tunnel).[¶](#section-3.4.1-4){.pilcrow}

The API Server faces a similar problem, implying that it should co-exist
with the Enforcement Device or that the Enforcement Device should extend
requests to it with the identifying
information.[¶](#section-3.4.1-5){.pilcrow}
:::
:::

::: {#id_example_IP_address}
::: {#section-3.4.2 .section}
#### [3.4.2.](#section-3.4.2){.section-number .selfRef} [IP Address](#name-ip-address){.section-name .selfRef} {#name-ip-address}

A natural identifier type to consider is the IP address of the User
Equipment. At any given time, no device on the network can have the same
IP address without causing the network to malfunction, so it is
appropriate from the perspective of
uniqueness.[¶](#section-3.4.2-1){.pilcrow}

However, it may be possible to spoof the IP address, particularly for
malicious reasons where proper functioning of the network is not
necessary for the malicious actor. Consequently, any solution using the
IP address [SHOULD]{.bcp14} proactively try to prevent spoofing of the
IP address. Similarly, if the mapping of IP address to User Equipment is
changed, the components of the architecture [MUST]{.bcp14} remove or
update their mapping to prevent spoofing. Demonstrations of return
routability, such as that required for TCP connection establishment,
might be sufficient defense against spoofing, though this might not be
sufficient in networks that use broadcast media (such as some wireless
networks).[¶](#section-3.4.2-2){.pilcrow}

Since the IP address may traverse multiple segments of the network, more
flexibility is afforded to the Enforcement Device and the API Server;
they simply must exist on a segment of the network where the IP address
is still unique. However, consider that a NAT may be deployed between
the User Equipment and the Enforcement Device. In such cases, it is
possible for the components to still uniquely identify the device if
they are aware of the port mapping.[¶](#section-3.4.2-3){.pilcrow}

In some situations, the User Equipment may have multiple IP addresses
(either IPv4, IPv6, or a dual-stack \[[RFC4213](#RFC4213){.xref}\]
combination) while still satisfying all of the recommended properties.
This raises some challenges to the components of the network. For
example, if the User Equipment tries to access the network with multiple
IP addresses, should the Enforcement Device and API Server treat each IP
address as a unique User Equipment instance, or should it tie the
multiple addresses together into one view of the subscriber? An
implementation [MAY]{.bcp14} do either. Attention should be paid to IPv6
and the fact that it is expected for a device to have multiple IPv6
addresses on a single link. In such cases, identification could be
performed by subnet, such as the /64 to which the IP
belongs.[¶](#section-3.4.2-4){.pilcrow}
:::
:::

::: {#id_example_mac_address}
::: {#section-3.4.3 .section}
#### [3.4.3.](#section-3.4.3){.section-number .selfRef} [Media Access Control (MAC) Address](#name-media-access-control-mac-ad){.section-name .selfRef} {#name-media-access-control-mac-ad}

The MAC address of a device is often used as an identifier in existing
implementations. This document does not discuss the use of MAC addresses
within a captive portal system, but they can be used as an identifier
type, subject to the criteria in [Section
3.2](#id_recommended_props){.xref}.[¶](#section-3.4.3-1){.pilcrow}
:::
:::
:::
:::

::: {#context_free_uri}
::: {#section-3.5 .section}
### [3.5.](#section-3.5){.section-number .selfRef} [Context-Free URI](#name-context-free-uri){.section-name .selfRef} {#name-context-free-uri}

A Captive Portal API needs to present information to clients that is
unique to that client. To do this, some systems use information from the
context of a request, such as the source address, to identify the User
Equipment.[¶](#section-3.5-1){.pilcrow}

Using information from context rather than information from the URI
allows the same URI to be used for different clients. However, it also
means that the resource is unable to provide relevant information if the
User Equipment makes a request using a different network path. This
might happen when User Equipment has multiple network interfaces. It
might also happen if the address of the API provided by DNS depends on
where the query originates (as in split DNS
\[[RFC8499](#RFC8499){.xref}\]).[¶](#section-3.5-2){.pilcrow}

Accessing the API [MAY]{.bcp14} depend on contextual information.
However, the URIs provided in the API [SHOULD]{.bcp14} be unique to the
User Equipment and not dependent on contextual information to function
correctly.[¶](#section-3.5-3){.pilcrow}

Though a URI might still correctly resolve when the User Equipment makes
the request from a different network, it is possible that some functions
could be limited to when the User Equipment makes requests using the
Captive Portal. For example, payment options could be absent or a
warning could be displayed to indicate the payment is not for the
current connection.[¶](#section-3.5-4){.pilcrow}

URIs could include some means of identifying the User Equipment in the
URIs. However, including unauthenticated User Equipment identifiers in
the URI may expose the service to spoofing or replay
attacks.[¶](#section-3.5-5){.pilcrow}
:::
:::
:::
:::

::: {#section_workflow}
::: {#section-4 .section}
## [4.](#section-4){.section-number .selfRef} [Solution Workflow](#name-solution-workflow){.section-name .selfRef} {#name-solution-workflow}

This section aims to improve understanding by describing a possible
workflow of solutions adhering to the architecture. Note that the
section is not normative; it describes only a subset of possible
implementations.[¶](#section-4-1){.pilcrow}

::: {#section-4.1 .section}
### [4.1.](#section-4.1){.section-number .selfRef} [Initial Connection](#name-initial-connection){.section-name .selfRef} {#name-initial-connection}

This section describes a possible workflow when User Equipment initially
joins a Captive Portal.[¶](#section-4.1-1){.pilcrow}

1.  [The User Equipment joins the Captive Portal by acquiring a DHCP
    lease, RA, or similar, acquiring provisioning
    information.[¶](#section-4.1-2.1){.pilcrow}]{#section-4.1-2.1}
2.  [The User Equipment learns the URI for the Captive Portal API from
    the provisioning information (e.g.,
    \[[RFC8910](#RFC8910){.xref}\]).[¶](#section-4.1-2.2){.pilcrow}]{#section-4.1-2.2}
3.  [The User Equipment accesses the Captive Portal API to receive
    parameters of the Captive Portal, including the User Portal URI.
    (This step replaces the clear-text query to a canary
    URI.)[¶](#section-4.1-2.3){.pilcrow}]{#section-4.1-2.3}
4.  [If necessary, the user navigates to the User Portal to gain access
    to the external
    network.[¶](#section-4.1-2.4){.pilcrow}]{#section-4.1-2.4}
5.  [If the user interacted with the User Portal to gain access to the
    external network in the previous step, the User Portal indicates to
    the Enforcement Device that the User Equipment is allowed to access
    the external
    network.[¶](#section-4.1-2.5){.pilcrow}]{#section-4.1-2.5}
6.  [The User Equipment attempts a connection outside the Captive
    Portal.[¶](#section-4.1-2.6){.pilcrow}]{#section-4.1-2.6}
7.  [If the requirements have been satisfied, the access is permitted;
    otherwise, the \"Expired\" behavior
    occurs.[¶](#section-4.1-2.7){.pilcrow}]{#section-4.1-2.7}
8.  [The User Equipment accesses the network until conditions
    expire.[¶](#section-4.1-2.8){.pilcrow}]{#section-4.1-2.8}
:::

::: {#section-4.2 .section}
### [4.2.](#section-4.2){.section-number .selfRef} [Conditions about to Expire](#name-conditions-about-to-expire){.section-name .selfRef} {#name-conditions-about-to-expire}

This section describes a possible workflow when access is about to
expire.[¶](#section-4.2-1){.pilcrow}

1.  [Precondition: the API has provided the User Equipment with a
    duration over which its access is
    valid.[¶](#section-4.2-2.1){.pilcrow}]{#section-4.2-2.1}
2.  [The User Equipment is communicating with the outside
    network.[¶](#section-4.2-2.2){.pilcrow}]{#section-4.2-2.2}
3.  [The User Equipment detects that the length of time left for its
    access has fallen below a threshold by comparing its stored expiry
    time with the current
    time.[¶](#section-4.2-2.3){.pilcrow}]{#section-4.2-2.3}
4.  [The User Equipment visits the API again to validate the expiry
    time.[¶](#section-4.2-2.4){.pilcrow}]{#section-4.2-2.4}
5.  [If expiry is still imminent, the User Equipment prompts the user to
    access the User Portal URI
    again.[¶](#section-4.2-2.5){.pilcrow}]{#section-4.2-2.5}
6.  [The user accepts the prompt displayed by the User
    Equipment.[¶](#section-4.2-2.6){.pilcrow}]{#section-4.2-2.6}
7.  [The user extends their access through the User Portal via the User
    Equipment\'s user
    interface.[¶](#section-4.2-2.7){.pilcrow}]{#section-4.2-2.7}
8.  [The User Equipment\'s access to the outside network continues
    uninterrupted.[¶](#section-4.2-2.8){.pilcrow}]{#section-4.2-2.8}
:::

::: {#section-4.3 .section}
### [4.3.](#section-4.3){.section-number .selfRef} [Handling of Changes in Portal URI](#name-handling-of-changes-in-port){.section-name .selfRef} {#name-handling-of-changes-in-port}

A different Captive Portal API URI could be returned in the following
cases:[¶](#section-4.3-1){.pilcrow}

-   [If DHCP is used, a lease renewal/rebind may return a different
    Captive Portal API
    URI.[¶](#section-4.3-2.1){.pilcrow}]{#section-4.3-2.1}
-   [If RA is used, a new Captive Portal API URI may be specified in a
    new RA message received by end User
    Equipment.[¶](#section-4.3-2.2){.pilcrow}]{#section-4.3-2.2}

When the Provisioning Service updates the Captive Portal API URI, the
User Equipment can retrieve updated state from the URI immediately, or
it can wait as it normally would until the expiry conditions it
retrieved from the old URI are about to
expire.[¶](#section-4.3-3){.pilcrow}
:::
:::
:::

::: {#IANA}
::: {#section-5 .section}
## [5.](#section-5){.section-number .selfRef} [IANA Considerations](#name-iana-considerations){.section-name .selfRef} {#name-iana-considerations}

This document has no IANA actions.[¶](#section-5-1){.pilcrow}
:::
:::

::: {#Security}
::: {#section-6 .section}
## [6.](#section-6){.section-number .selfRef} [Security Considerations](#name-security-considerations){.section-name .selfRef} {#name-security-considerations}

::: {#section-6.1 .section}
### [6.1.](#section-6.1){.section-number .selfRef} [Trusting the Network](#name-trusting-the-network){.section-name .selfRef} {#name-trusting-the-network}

When joining a network, some trust is placed in the network operator.
This is usually considered to be a decision by a user on the basis of
the reputation of an organization. However, once a user makes such a
decision, protocols can support authenticating that a network is
operated by who claims to be operating it. The Provisioning Domain
Architecture \[[RFC7556](#RFC7556){.xref}\] provides some discussion on
authenticating an operator.[¶](#section-6.1-1){.pilcrow}

The user makes an informed choice to visit and trust the Captive Portal
URI. Since the network provides the Captive Portal URI to the User
Equipment, the network [SHOULD]{.bcp14} do so securely so that the
user\'s trust in the network can extend to their trust of the Captive
Portal URI. For example, the DHCPv6 AUTH option can sign this
information.[¶](#section-6.1-2){.pilcrow}

If a user decides to incorrectly trust an attacking network, they might
be convinced to visit an attacking web page and unwittingly provide
credentials to an attacker. Browsers can authenticate servers but cannot
detect cleverly misspelled domains, for
example.[¶](#section-6.1-3){.pilcrow}

Further, the possibility of an on-path attacker in an attacking network
introduces some risks. The attacker could redirect traffic to arbitrary
destinations. The attacker could analyze the user\'s traffic leading to
loss of confidentiality, or the attacker could modify the traffic
inline.[¶](#section-6.1-4){.pilcrow}
:::

::: {#section-6.2 .section}
### [6.2.](#section-6.2){.section-number .selfRef} [Authenticated APIs](#name-authenticated-apis){.section-name .selfRef} {#name-authenticated-apis}

The solution described here requires that when the User Equipment needs
to access the API Server, the User Equipment authenticates the server;
see [Section 2.1](#section_client){.xref}.[¶](#section-6.2-1){.pilcrow}

The Captive Portal API URI might change during the Captive Portal
Session. The User Equipment can apply the same trust mechanisms to the
new URI as it did to the URI it received initially from the Provisioning
Service.[¶](#section-6.2-2){.pilcrow}
:::

::: {#section-6.3 .section}
### [6.3.](#section-6.3){.section-number .selfRef} [Secure APIs](#name-secure-apis){.section-name .selfRef} {#name-secure-apis}

The solution described here requires that the API be secured using TLS.
This is required to allow the User Equipment and API Server to exchange
secrets that can be used to validate future interactions. The API
[MUST]{.bcp14} ensure the integrity of this information, as well as its
confidentiality.[¶](#section-6.3-1){.pilcrow}

An attacker with access to this information might be able to masquerade
as a specific User Equipment instance when interacting with the API,
which could then allow them to masquerade as that User Equipment
instance when interacting with the User Portal. This could give them the
ability to determine whether the User Equipment has accessed the portal,
deny the User Equipment service by ending their Session using mechanisms
provided by the User Portal, or consume that User Equipment\'s quota. An
attacker with the ability to modify the information could deny service
to the User Equipment or cause them to appear as different User
Equipment instances.[¶](#section-6.3-2){.pilcrow}
:::

::: {#section_signal_risks}
::: {#section-6.4 .section}
### [6.4.](#section-6.4){.section-number .selfRef} [Risks Associated with the Signaling Protocol](#name-risks-associated-with-the-s){.section-name .selfRef} {#name-risks-associated-with-the-s}

If a Signaling Protocol is implemented, it may be possible for any user
on the Internet to send signals in an attempt to cause the receiving
equipment to communicate with the Captive Portal API. This has been
considered, and implementations may address it in the following
ways:[¶](#section-6.4-1){.pilcrow}

-   [The signal only signals to the User Equipment to query the API. It
    does not carry any information that may mislead or misdirect the
    User Equipment.[¶](#section-6.4-2.1){.pilcrow}]{#section-6.4-2.1}
-   [Even when responding to the signal, the User Equipment securely
    authenticates with API
    Servers.[¶](#section-6.4-2.2){.pilcrow}]{#section-6.4-2.2}
-   [The User Equipment limits the rate at which it accesses the API,
    reducing the impact of an attack attempting to generate excessive
    load on either the User Equipment or API. Note that because there is
    only one type of signal and one type of API request in response to
    the signal, this rate-limiting will not cause loss of signaling
    information.[¶](#section-6.4-2.3){.pilcrow}]{#section-6.4-2.3}
:::
:::

::: {#section-6.5 .section}
### [6.5.](#section-6.5){.section-number .selfRef} [User Options](#name-user-options){.section-name .selfRef} {#name-user-options}

The Captive Portal Signal could signal to the User Equipment that it is
being held captive. There is no requirement that the User Equipment do
something about this. Devices [MAY]{.bcp14} permit users to disable
automatic reaction to Captive Portal Signal indications for privacy
reasons. However, there would be the trade-off that the user doesn\'t
get notified when network access is restricted. Hence, end-user devices
[MAY]{.bcp14} allow users to manually control captive portal
interactions, possibly on the granularity of Provisioning
Domains.[¶](#section-6.5-1){.pilcrow}
:::

::: {#section-6.6 .section}
### [6.6.](#section-6.6){.section-number .selfRef} [Privacy](#name-privacy){.section-name .selfRef} {#name-privacy}

[Section 3](#ue_identity){.xref} describes a mechanism by which all
components within the Captive Portal are designed to use the same
identifier to uniquely identify the User Equipment. This identifier
could be abused to track the user. Implementers and designers of Captive
Portals should take care to ensure that identifiers, if stored, are
stored securely. Likewise, if any component communicates the identifier
over the network, it should ensure the confidentiality of the identifier
on the wire by using encryption such as
TLS.[¶](#section-6.6-1){.pilcrow}

There are benefits to choosing mutable anonymous identifiers. For
example, User Equipment could cycle through multiple identifiers to help
prevent long-term tracking. However, if the components of the network
use an internal mapping to map the identity to a stable, long-term value
in order to deal with changing identifiers, they need to treat that
value as sensitive information; an attacker could use it to tie traffic
back to the originating User Equipment, despite the User Equipment
having changed identifiers.[¶](#section-6.6-2){.pilcrow}
:::
:::
:::

::: {#section-7 .section}
## [7.](#section-7){.section-number .selfRef} [References](#name-references){.section-name .selfRef} {#name-references}

::: {#section-7.1 .section}
### [7.1.](#section-7.1){.section-number .selfRef} [Normative References](#name-normative-references){.section-name .selfRef} {#name-normative-references}

\[RFC2119\]
:   [Bradner, S.]{.refAuthor}, [\"Key words for use in RFCs to Indicate
    Requirement Levels\"]{.refTitle}, [BCP 14]{.seriesInfo}, [RFC
    2119]{.seriesInfo}, [DOI 10.17487/RFC2119]{.seriesInfo}, March 1997,
    \<<https://www.rfc-editor.org/info/rfc2119>\>.
:   

\[RFC2818\]
:   [Rescorla, E.]{.refAuthor}, [\"HTTP Over TLS\"]{.refTitle}, [RFC
    2818]{.seriesInfo}, [DOI 10.17487/RFC2818]{.seriesInfo}, May 2000,
    \<<https://www.rfc-editor.org/info/rfc2818>\>.
:   

\[RFC6125\]
:   [Saint-Andre, P.]{.refAuthor}[ and J. Hodges]{.refAuthor},
    [\"Representation and Verification of Domain-Based Application
    Service Identity within Internet Public Key Infrastructure Using
    X.509 (PKIX) Certificates in the Context of Transport Layer Security
    (TLS)\"]{.refTitle}, [RFC 6125]{.seriesInfo}, [DOI
    10.17487/RFC6125]{.seriesInfo}, March 2011,
    \<<https://www.rfc-editor.org/info/rfc6125>\>.
:   

\[RFC7556\]
:   [Anipko, D., Ed.]{.refAuthor}, [\"Multiple Provisioning Domain
    Architecture\"]{.refTitle}, [RFC 7556]{.seriesInfo}, [DOI
    10.17487/RFC7556]{.seriesInfo}, June 2015,
    \<<https://www.rfc-editor.org/info/rfc7556>\>.
:   

\[RFC8174\]
:   [Leiba, B.]{.refAuthor}, [\"Ambiguity of Uppercase vs Lowercase in
    RFC 2119 Key Words\"]{.refTitle}, [BCP 14]{.seriesInfo}, [RFC
    8174]{.seriesInfo}, [DOI 10.17487/RFC8174]{.seriesInfo}, May 2017,
    \<<https://www.rfc-editor.org/info/rfc8174>\>.
:   

\[RFC8910\]
:   [Kumari, W.]{.refAuthor}[ and E. Kline]{.refAuthor},
    [\"Captive-Portal Identification in DHCP and Router Advertisements
    (RAs)\"]{.refTitle}, [RFC 8910]{.seriesInfo}, [DOI
    10.17487/RFC8910]{.seriesInfo}, September 2020,
    \<<https://www.rfc-editor.org/info/rfc8910>\>.
:   
:::

::: {#section-7.2 .section}
### [7.2.](#section-7.2){.section-number .selfRef} [Informative References](#name-informative-references){.section-name .selfRef} {#name-informative-references}

\[CAPPORT-PVD\]
:   [Pfister, P.]{.refAuthor}[ and T. Pauly]{.refAuthor}, [\"Using
    Provisioning Domains for Captive Portal Discovery\"]{.refTitle},
    [Work in Progress]{.refContent}, [Internet-Draft,
    draft-pfister-capport-pvd-00]{.seriesInfo}, 30 June 2018,
    \<<https://tools.ietf.org/html/draft-pfister-capport-pvd-00>\>.
:   

\[RFC3986\]
:   [Berners-Lee, T.]{.refAuthor}[, Fielding, R.]{.refAuthor}[, and L.
    Masinter]{.refAuthor}, [\"Uniform Resource Identifier (URI): Generic
    Syntax\"]{.refTitle}, [STD 66]{.seriesInfo}, [RFC
    3986]{.seriesInfo}, [DOI 10.17487/RFC3986]{.seriesInfo}, January
    2005, \<<https://www.rfc-editor.org/info/rfc3986>\>.
:   

\[RFC4213\]
:   [Nordmark, E.]{.refAuthor}[ and R. Gilligan]{.refAuthor}, [\"Basic
    Transition Mechanisms for IPv6 Hosts and Routers\"]{.refTitle}, [RFC
    4213]{.seriesInfo}, [DOI 10.17487/RFC4213]{.seriesInfo}, October
    2005, \<<https://www.rfc-editor.org/info/rfc4213>\>.
:   

\[RFC8499\]
:   [Hoffman, P.]{.refAuthor}[, Sullivan, A.]{.refAuthor}[, and K.
    Fujiwara]{.refAuthor}, [\"DNS Terminology\"]{.refTitle}, [BCP
    219]{.seriesInfo}, [RFC 8499]{.seriesInfo}, [DOI
    10.17487/RFC8499]{.seriesInfo}, January 2019,
    \<<https://www.rfc-editor.org/info/rfc8499>\>.
:   

\[RFC8908\]
:   [Pauly, T., Ed.]{.refAuthor}[ and D. Thakore, Ed.]{.refAuthor},
    [\"Captive Portal API\"]{.refTitle}, [RFC 8908]{.seriesInfo}, [DOI
    10.17487/RFC8908]{.seriesInfo}, September 2020,
    \<<https://www.rfc-editor.org/info/rfc8908>\>.
:   
:::
:::

::: {#app-additional}
::: {#section-appendix.a .section}
## [Appendix A.](#section-appendix.a){.section-number .selfRef} [Existing Captive Portal Detection Implementations](#name-existing-captive-portal-det){.section-name .selfRef} {#name-existing-captive-portal-det}

Operating systems and user applications may perform various tests when
network connectivity is established to determine if the device is
attached to a network with a captive portal present. A common method is
to attempt to make an HTTP request to a known, vendor-hosted endpoint
with a fixed response. Any other response is interpreted as a signal
that a captive portal is present. This check is typically not secured
with TLS, as a network with a captive portal may intercept the
connection, leading to a host name mismatch. This has been referred to
as a \"canary\" request because, like the canary in the coal mine, it
can be the first sign that something is
wrong.[¶](#section-appendix.a-1){.pilcrow}

Another test that can be performed is a DNS lookup to a known address
with an expected answer. If the answer differs from the expected answer,
the equipment detects that a captive portal is present. DNS queries over
TCP or HTTPS are less likely to be modified than DNS queries over UDP
due to the complexity of
implementation.[¶](#section-appendix.a-2){.pilcrow}

The different tests may produce different conclusions, varying by
whether or not the implementation treats both TCP and UDP traffic and by
which types of DNS are intercepted.[¶](#section-appendix.a-3){.pilcrow}

Malicious or misconfigured networks with a captive portal present may
not intercept these canary requests and choose to pass them through or
decide to impersonate, leading to the device having a false
negative.[¶](#section-appendix.a-4){.pilcrow}
:::
:::

::: {#Acknowledgments}
::: {#section-appendix.b .section}
## [Acknowledgments](#name-acknowledgments){.section-name .selfRef} {#name-acknowledgments}

The authors thank [Lorenzo Colitti]{.contact-name} for providing the
majority of the content for the Captive Portal Signal
requirements.[¶](#section-appendix.b-1){.pilcrow}

The authors thank [Benjamin Kaduk]{.contact-name} for providing the
content related to TLS certificate validation of the API
Server.[¶](#section-appendix.b-2){.pilcrow}

The authors thank [Michael Richardson]{.contact-name} for providing
wording requiring DNSSEC and TLS to operate without the user adding
exceptions.[¶](#section-appendix.b-3){.pilcrow}

The authors thank various individuals for their feedback on the mailing
list and during the IETF 98 hackathon: [David Bird]{.contact-name},
[Erik Kline]{.contact-name}, [Alexis La Goulette]{.contact-name}, [Alex
Roscoe]{.contact-name}, [Darshak Thakore]{.contact-name}, and [Vincent
van Dam]{.contact-name}.[¶](#section-appendix.b-4){.pilcrow}
:::
:::

::: {#authors-addresses}
::: {#section-appendix.c .section}
## [Authors\' Addresses](#name-authors-addresses){.section-name .selfRef} {#name-authors-addresses}

::: {.left dir="auto"}
[Kyle Larose]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Agilicus]{.org}
:::

::: email
Email: <kyle@agilicus.com>
:::

::: {.left dir="auto"}
[David Dolson]{.fn .nameRole}
:::

::: email
Email: <ddolson@acm.org>
:::

::: {.left dir="auto"}
[Heng Liu]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Google]{.org}
:::

::: email
Email: <liucougar@google.com>
:::
:::
:::
