  RFC 9250          DNS over Dedicated QUIC   May 2022
  ----------------- ------------------------- ----------
  Huitema, et al.   Standards Track           \[Page\]

::: {#external-metadata .document-information}
:::

::: {#internal-metadata .document-information}

Stream:
:   Internet Engineering Task Force (IETF)

RFC:
:   [9250](https://www.rfc-editor.org/rfc/rfc9250){.eref}

Category:
:   Standards Track

Published:
:   May 2022

ISSN:
:   2070-1721

Authors:

:   ::: author
    ::: author-name
    C. Huitema
    :::

    ::: org
    Private Octopus Inc.
    :::
    :::

    ::: author
    ::: author-name
    S. Dickinson
    :::

    ::: org
    Sinodun IT
    :::
    :::

    ::: author
    ::: author-name
    A. Mankin
    :::

    ::: org
    Salesforce
    :::
    :::
:::

# RFC 9250 {#rfcnum}

# DNS over Dedicated QUIC Connections {#title}

::: {#section-abstract .section}
## [Abstract](#abstract){.selfRef}

This document describes the use of QUIC to provide transport
confidentiality for DNS. The encryption provided by QUIC has similar
properties to those provided by TLS, while QUIC transport eliminates the
head-of-line blocking issues inherent with TCP and provides more
efficient packet-loss recovery than UDP. DNS over QUIC (DoQ) has privacy
properties similar to DNS over TLS (DoT) specified in RFC 7858, and
latency characteristics similar to classic DNS over UDP. This
specification describes the use of DoQ as a general-purpose transport
for DNS and includes the use of DoQ for stub to recursive, recursive to
authoritative, and zone transfer
scenarios.[¶](#section-abstract-1){.pilcrow}
:::

::: {#status-of-memo}
::: {#section-boilerplate.1 .section}
## [Status of This Memo](#name-status-of-this-memo){.section-name .selfRef} {#name-status-of-this-memo}

This is an Internet Standards Track
document.[¶](#section-boilerplate.1-1){.pilcrow}

This document is a product of the Internet Engineering Task Force
(IETF). It represents the consensus of the IETF community. It has
received public review and has been approved for publication by the
Internet Engineering Steering Group (IESG). Further information on
Internet Standards is available in Section 2 of RFC
7841.[¶](#section-boilerplate.1-2){.pilcrow}

Information about the current status of this document, any errata, and
how to provide feedback on it may be obtained at
<https://www.rfc-editor.org/info/rfc9250>.[¶](#section-boilerplate.1-3){.pilcrow}
:::
:::

::: {#copyright}
::: {#section-boilerplate.2 .section}
## [Copyright Notice](#name-copyright-notice){.section-name .selfRef} {#name-copyright-notice}

Copyright (c) 2022 IETF Trust and the persons identified as the document
authors. All rights reserved.[¶](#section-boilerplate.2-1){.pilcrow}

This document is subject to BCP 78 and the IETF Trust\'s Legal
Provisions Relating to IETF Documents
(<https://trustee.ietf.org/license-info>) in effect on the date of
publication of this document. Please review these documents carefully,
as they describe your rights and restrictions with respect to this
document. Code Components extracted from this document must include
Revised BSD License text as described in Section 4.e of the Trust Legal
Provisions and are provided without warranty as described in the Revised
BSD License.[¶](#section-boilerplate.2-2){.pilcrow}
:::
:::

::: {#toc}
::: {#section-toc.1 .section}
[▲](#){.toplink}

## [Table of Contents](#name-table-of-contents){.section-name .selfRef} {#name-table-of-contents}

-   ::: {#section-toc.1-1.1}
    [1](#section-1){.xref}.  [Introduction](#name-introduction){.xref}
    :::

-   ::: {#section-toc.1-1.2}
    [2](#section-2){.xref}.  [Key Words](#name-key-words){.xref}
    :::

-   ::: {#section-toc.1-1.3}
    [3](#section-3){.xref}.  [Design
    Considerations](#name-design-considerations){.xref}

    -   ::: {#section-toc.1-1.3.2.1}
        [3.1](#section-3.1){.xref}.  [Provide DNS
        Privacy](#name-provide-dns-privacy){.xref}
        :::

    -   ::: {#section-toc.1-1.3.2.2}
        [3.2](#section-3.2){.xref}.  [Design for Minimum
        Latency](#name-design-for-minimum-latency){.xref}
        :::

    -   ::: {#section-toc.1-1.3.2.3}
        [3.3](#section-3.3){.xref}.  [Middlebox
        Considerations](#name-middlebox-considerations){.xref}
        :::

    -   ::: {#section-toc.1-1.3.2.4}
        [3.4](#section-3.4){.xref}.  [No Server-Initiated
        Transactions](#name-no-server-initiated-transac){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.4}
    [4](#section-4){.xref}.  [Specifications](#name-specifications){.xref}

    -   ::: {#section-toc.1-1.4.2.1}
        [4.1](#section-4.1){.xref}.  [Connection
        Establishment](#name-connection-establishment){.xref}

        -   ::: {#section-toc.1-1.4.2.1.2.1}
            [4.1.1](#section-4.1.1){.xref}.  [Port
            Selection](#name-port-selection){.xref}
            :::
        :::

    -   ::: {#section-toc.1-1.4.2.2}
        [4.2](#section-4.2){.xref}.  [Stream Mapping and
        Usage](#name-stream-mapping-and-usage){.xref}

        -   ::: {#section-toc.1-1.4.2.2.2.1}
            [4.2.1](#section-4.2.1){.xref}.  [DNS Message
            IDs](#name-dns-message-ids){.xref}
            :::
        :::

    -   ::: {#section-toc.1-1.4.2.3}
        [4.3](#section-4.3){.xref}.  [DoQ Error
        Codes](#name-doq-error-codes){.xref}

        -   ::: {#section-toc.1-1.4.2.3.2.1}
            [4.3.1](#section-4.3.1){.xref}.  [Transaction
            Cancellation](#name-transaction-cancellation){.xref}
            :::

        -   ::: {#section-toc.1-1.4.2.3.2.2}
            [4.3.2](#section-4.3.2){.xref}.  [Transaction
            Errors](#name-transaction-errors){.xref}
            :::

        -   ::: {#section-toc.1-1.4.2.3.2.3}
            [4.3.3](#section-4.3.3){.xref}.  [Protocol
            Errors](#name-protocol-errors){.xref}
            :::

        -   ::: {#section-toc.1-1.4.2.3.2.4}
            [4.3.4](#section-4.3.4){.xref}.  [Alternative Error
            Codes](#name-alternative-error-codes){.xref}
            :::
        :::

    -   ::: {#section-toc.1-1.4.2.4}
        [4.4](#section-4.4){.xref}.  [Connection
        Management](#name-connection-management){.xref}
        :::

    -   ::: {#section-toc.1-1.4.2.5}
        [4.5](#section-4.5){.xref}.  [Session Resumption and
        0-RTT](#name-session-resumption-and-0-rt){.xref}
        :::

    -   ::: {#section-toc.1-1.4.2.6}
        [4.6](#section-4.6){.xref}.  [Message
        Sizes](#name-message-sizes){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.5}
    [5](#section-5){.xref}.  [Implementation
    Requirements](#name-implementation-requirements){.xref}

    -   ::: {#section-toc.1-1.5.2.1}
        [5.1](#section-5.1){.xref}.  [Authentication](#name-authentication){.xref}
        :::

    -   ::: {#section-toc.1-1.5.2.2}
        [5.2](#section-5.2){.xref}.  [Fallback to Other Protocols on
        Connection Failure](#name-fallback-to-other-protocols){.xref}
        :::

    -   ::: {#section-toc.1-1.5.2.3}
        [5.3](#section-5.3){.xref}.  [Address
        Validation](#name-address-validation){.xref}
        :::

    -   ::: {#section-toc.1-1.5.2.4}
        [5.4](#section-5.4){.xref}.  [Padding](#name-padding){.xref}
        :::

    -   ::: {#section-toc.1-1.5.2.5}
        [5.5](#section-5.5){.xref}.  [Connection
        Handling](#name-connection-handling){.xref}

        -   ::: {#section-toc.1-1.5.2.5.2.1}
            [5.5.1](#section-5.5.1){.xref}.  [Connection
            Reuse](#name-connection-reuse){.xref}
            :::

        -   ::: {#section-toc.1-1.5.2.5.2.2}
            [5.5.2](#section-5.5.2){.xref}.  [Resource
            Management](#name-resource-management){.xref}
            :::

        -   ::: {#section-toc.1-1.5.2.5.2.3}
            [5.5.3](#section-5.5.3){.xref}.  [Using 0-RTT and Session
            Resumption](#name-using-0-rtt-and-session-res){.xref}
            :::

        -   ::: {#section-toc.1-1.5.2.5.2.4}
            [5.5.4](#section-5.5.4){.xref}.  [Controlling Connection
            Migration for
            Privacy](#name-controlling-connection-migr){.xref}
            :::
        :::

    -   ::: {#section-toc.1-1.5.2.6}
        [5.6](#section-5.6){.xref}.  [Processing Queries in
        Parallel](#name-processing-queries-in-paral){.xref}
        :::

    -   ::: {#section-toc.1-1.5.2.7}
        [5.7](#section-5.7){.xref}.  [Zone
        Transfer](#name-zone-transfer){.xref}
        :::

    -   ::: {#section-toc.1-1.5.2.8}
        [5.8](#section-5.8){.xref}.  [Flow Control
        Mechanisms](#name-flow-control-mechanisms){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.6}
    [6](#section-6){.xref}.  [Security
    Considerations](#name-security-considerations){.xref}
    :::

-   ::: {#section-toc.1-1.7}
    [7](#section-7){.xref}.  [Privacy
    Considerations](#name-privacy-considerations){.xref}

    -   ::: {#section-toc.1-1.7.2.1}
        [7.1](#section-7.1){.xref}.  [Privacy Issues with 0-RTT
        data](#name-privacy-issues-with-0-rtt-d){.xref}
        :::

    -   ::: {#section-toc.1-1.7.2.2}
        [7.2](#section-7.2){.xref}.  [Privacy Issues with Session
        Resumption](#name-privacy-issues-with-session){.xref}
        :::

    -   ::: {#section-toc.1-1.7.2.3}
        [7.3](#section-7.3){.xref}.  [Privacy Issues with Address
        Validation Tokens](#name-privacy-issues-with-address){.xref}
        :::

    -   ::: {#section-toc.1-1.7.2.4}
        [7.4](#section-7.4){.xref}.  [Privacy Issues with Long Duration
        Sessions](#name-privacy-issues-with-long-du){.xref}
        :::

    -   ::: {#section-toc.1-1.7.2.5}
        [7.5](#section-7.5){.xref}.  [Traffic
        Analysis](#name-traffic-analysis){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.8}
    [8](#section-8){.xref}.  [IANA
    Considerations](#name-iana-considerations){.xref}

    -   ::: {#section-toc.1-1.8.2.1}
        [8.1](#section-8.1){.xref}.  [Registration of a DoQ
        Identification String](#name-registration-of-a-doq-ident){.xref}
        :::

    -   ::: {#section-toc.1-1.8.2.2}
        [8.2](#section-8.2){.xref}.  [Reservation of a Dedicated
        Port](#name-reservation-of-a-dedicated-){.xref}
        :::

    -   ::: {#section-toc.1-1.8.2.3}
        [8.3](#section-8.3){.xref}.  [Reservation of an Extended DNS
        Error Code: Too Early](#name-reservation-of-an-extended-){.xref}
        :::

    -   ::: {#section-toc.1-1.8.2.4}
        [8.4](#section-8.4){.xref}.  [DNS-over-QUIC Error Codes
        Registry](#name-dns-over-quic-error-codes-r){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.9}
    [9](#section-9){.xref}.  [References](#name-references){.xref}

    -   ::: {#section-toc.1-1.9.2.1}
        [9.1](#section-9.1){.xref}.  [Normative
        References](#name-normative-references){.xref}
        :::

    -   ::: {#section-toc.1-1.9.2.2}
        [9.2](#section-9.2){.xref}.  [Informative
        References](#name-informative-references){.xref}
        :::
    :::

-   ::: {#section-toc.1-1.10}
    [Appendix A](#appendix-A){.xref}.  [The NOTIFY
    Service](#name-the-notify-service){.xref}
    :::

-   ::: {#section-toc.1-1.11}
    [](#appendix-B){.xref}[Acknowledgements](#name-acknowledgements){.xref}
    :::

-   ::: {#section-toc.1-1.12}
    [](#appendix-C){.xref}[Authors\'
    Addresses](#name-authors-addresses){.xref}
    :::
:::
:::

::: {#introduction}
::: {#section-1 .section}
## [1.](#section-1){.section-number .selfRef} [Introduction](#name-introduction){.section-name .selfRef} {#name-introduction}

Domain Name System (DNS) concepts are specified in \"Domain names -
concepts and facilities\" \[[RFC1034](#RFC1034){.xref}\]. The
transmission of DNS queries and responses over UDP and TCP is specified
in \"Domain names - implementation and specification\"
\[[RFC1035](#RFC1035){.xref}\].[¶](#section-1-1){.pilcrow}

This document presents a mapping of the DNS protocol over the QUIC
transport \[[RFC9000](#RFC9000){.xref}\] \[[RFC9001](#RFC9001){.xref}\].
DNS over QUIC is referred to here as DoQ, in line with \"DNS
Terminology\"
\[[DNS-TERMS](#I-D.ietf-dnsop-rfc8499bis){.xref}\].[¶](#section-1-2){.pilcrow}

The goals of the DoQ mapping are:[¶](#section-1-3){.pilcrow}

1.  [Provide the same DNS privacy protection as DoT
    \[[RFC7858](#RFC7858){.xref}\]. This includes an option for the
    client to authenticate the server by means of an authentication
    domain name as specified in \"Usage Profiles for DNS over TLS and
    DNS over DTLS\"
    \[[RFC8310](#RFC8310){.xref}\].[¶](#section-1-4.1){.pilcrow}]{#section-1-4.1}
2.  [Provide an improved level of source address validation for DNS
    servers compared to classic DNS over
    UDP.[¶](#section-1-4.2){.pilcrow}]{#section-1-4.2}
3.  [Provide a transport that does not impose path MTU limitations on
    the size of DNS responses it can
    send.[¶](#section-1-4.3){.pilcrow}]{#section-1-4.3}

In order to achieve these goals, and to support ongoing work on
encryption of DNS, the scope of this document
includes:[¶](#section-1-5){.pilcrow}

-   [the \"stub to recursive resolver\" scenario (also called the \"stub
    to recursive\" scenario in this
    document)[¶](#section-1-6.1){.pilcrow}]{#section-1-6.1}
-   [the \"recursive resolver to authoritative nameserver\" scenario
    (also called the \"recursive to authoritative\" scenario in this
    document), and[¶](#section-1-6.2){.pilcrow}]{#section-1-6.2}
-   [the \"nameserver to nameserver\" scenario (mainly used for zone
    transfers (XFR) \[[RFC1995](#RFC1995){.xref}\]
    \[[RFC5936](#RFC5936){.xref}\]).[¶](#section-1-6.3){.pilcrow}]{#section-1-6.3}

In other words, this document specifies QUIC as a general-purpose
transport for DNS.[¶](#section-1-7){.pilcrow}

The specific non-goals of this document are:[¶](#section-1-8){.pilcrow}

1.  [No attempt is made to evade potential blocking of DoQ traffic by
    middleboxes.[¶](#section-1-9.1){.pilcrow}]{#section-1-9.1}
2.  [No attempt to support server-initiated transactions, which are used
    only in DNS Stateful Operations (DSO)
    \[[RFC8490](#RFC8490){.xref}\].[¶](#section-1-9.2){.pilcrow}]{#section-1-9.2}

Specifying the transmission of an application over QUIC requires
specifying how the application\'s messages are mapped to QUIC streams,
and generally how the application will use QUIC. This is done for HTTP
in \"Hypertext Transfer Protocol Version 3 (HTTP/3)\"
\[[HTTP/3](#I-D.ietf-quic-http){.xref}\]. The purpose of this document
is to define the way DNS messages can be transmitted over
QUIC.[¶](#section-1-10){.pilcrow}

DNS over HTTPS (DoH) \[[RFC8484](#RFC8484){.xref}\] can be used with
HTTP/3 to get some of the benefits of QUIC. However, a lightweight
direct mapping for DoQ can be regarded as a more natural fit for both
the recursive to authoritative and zone transfer scenarios, which rarely
involve intermediaries. In these scenarios, the additional overhead of
HTTP is not offset by, for example, benefits of HTTP proxying and
caching behavior.[¶](#section-1-11){.pilcrow}

In this document, [Section 3](#design-considerations){.xref} presents
the reasoning that guided the proposed design. [Section
4](#specifications){.xref} specifies the actual mapping of DoQ. [Section
5](#implementation-requirements){.xref} presents guidelines on the
implementation, usage, and deployment of
DoQ.[¶](#section-1-12){.pilcrow}
:::
:::

::: {#key-words}
::: {#section-2 .section}
## [2.](#section-2){.section-number .selfRef} [Key Words](#name-key-words){.section-name .selfRef} {#name-key-words}

The key words \"[MUST]{.bcp14}\", \"[MUST NOT]{.bcp14}\",
\"[REQUIRED]{.bcp14}\", \"[SHALL]{.bcp14}\", \"[SHALL NOT]{.bcp14}\",
\"[SHOULD]{.bcp14}\", \"[SHOULD NOT]{.bcp14}\",
\"[RECOMMENDED]{.bcp14}\", \"[NOT RECOMMENDED]{.bcp14}\",
\"[MAY]{.bcp14}\", and \"[OPTIONAL]{.bcp14}\" in this document are to be
interpreted as described in BCP 14 \[[RFC2119](#RFC2119){.xref}\]
\[[RFC8174](#RFC8174){.xref}\] when, and only when, they appear in all
capitals, as shown here.[¶](#section-2-1){.pilcrow}
:::
:::

::: {#design-considerations}
::: {#section-3 .section}
## [3.](#section-3){.section-number .selfRef} [Design Considerations](#name-design-considerations){.section-name .selfRef} {#name-design-considerations}

This section and its subsections present the design guidelines that were
used for DoQ. While all other sections in this document are normative,
this section is informative in nature.[¶](#section-3-1){.pilcrow}

::: {#provide-dns-privacy}
::: {#section-3.1 .section}
### [3.1.](#section-3.1){.section-number .selfRef} [Provide DNS Privacy](#name-provide-dns-privacy){.section-name .selfRef} {#name-provide-dns-privacy}

DoT \[[RFC7858](#RFC7858){.xref}\] defines how to mitigate some of the
issues described in \"DNS Privacy Considerations\"
\[[RFC9076](#RFC9076){.xref}\] by specifying how to transmit DNS
messages over TLS. The \"Usage Profiles for DNS over TLS and DNS over
DTLS\" \[[RFC8310](#RFC8310){.xref}\] specify Strict and Opportunistic
usage profiles for DoT including how stub resolvers can authenticate
recursive resolvers.[¶](#section-3.1-1){.pilcrow}

QUIC connection setup includes the negotiation of security parameters
using TLS, as specified in \"Using TLS to Secure QUIC\"
\[[RFC9001](#RFC9001){.xref}\], enabling encryption of the QUIC
transport. Transmitting DNS messages over QUIC will provide essentially
the same privacy protections as DoT \[[RFC7858](#RFC7858){.xref}\]
including Strict and Opportunistic usage profiles
\[[RFC8310](#RFC8310){.xref}\]. Further discussion on this is provided
in [Section
7](#privacy-considerations){.xref}.[¶](#section-3.1-2){.pilcrow}
:::
:::

::: {#design-for-minimum-latency}
::: {#section-3.2 .section}
### [3.2.](#section-3.2){.section-number .selfRef} [Design for Minimum Latency](#name-design-for-minimum-latency){.section-name .selfRef} {#name-design-for-minimum-latency}

QUIC is specifically designed to reduce protocol-induced delays, with
features such as:[¶](#section-3.2-1){.pilcrow}

1.  [Support for 0-RTT data during session
    resumption.[¶](#section-3.2-2.1){.pilcrow}]{#section-3.2-2.1}
2.  [Support for advanced packet-loss recovery procedures as specified
    in \"QUIC Loss Detection and Congestion Control\"
    \[[RFC9002](#RFC9002){.xref}\].[¶](#section-3.2-2.2){.pilcrow}]{#section-3.2-2.2}
3.  [Mitigation of head-of-line blocking by allowing parallel delivery
    of data on multiple
    streams.[¶](#section-3.2-2.3){.pilcrow}]{#section-3.2-2.3}

This mapping of DNS to QUIC will take advantage of these features in
three ways:[¶](#section-3.2-3){.pilcrow}

1.  [Optional support for sending 0-RTT data during session resumption
    (the security and privacy implications of this are discussed in
    later sections).[¶](#section-3.2-4.1){.pilcrow}]{#section-3.2-4.1}
2.  [Long-lived QUIC connections over which multiple DNS transactions
    are performed, generating the sustained traffic required to benefit
    from advanced recovery
    features.[¶](#section-3.2-4.2){.pilcrow}]{#section-3.2-4.2}
3.  [Mapping of each DNS Query/Response transaction to a separate
    stream, to mitigate head-of-line blocking. This enables servers to
    respond to queries \"out of order\". It also enables clients to
    process responses as soon as they arrive, without having to wait for
    in-order delivery of responses previously posted by the
    server.[¶](#section-3.2-4.3){.pilcrow}]{#section-3.2-4.3}

These considerations are reflected in the mapping of DNS traffic to QUIC
streams in [Section
4.2](#stream-mapping-and-usage){.xref}.[¶](#section-3.2-5){.pilcrow}
:::
:::

::: {#middlebox-considerations}
::: {#section-3.3 .section}
### [3.3.](#section-3.3){.section-number .selfRef} [Middlebox Considerations](#name-middlebox-considerations){.section-name .selfRef} {#name-middlebox-considerations}

Using QUIC might allow a protocol to disguise its purpose from devices
on the network path using encryption and traffic analysis resistance
techniques like padding, traffic pacing, and traffic shaping. This
specification does not include any measures that are designed to avoid
such classification; the padding mechanisms defined in [Section
5.4](#padding){.xref} are intended to obfuscate the specific records
contained in DNS queries and responses, but not the fact that this is
DNS traffic. Consequently, firewalls and other middleboxes might be able
to distinguish DoQ from other protocols that use QUIC, like HTTP, and
apply different treatment.[¶](#section-3.3-1){.pilcrow}

The lack of measures in this specification to avoid protocol
classification is not an endorsement of such
practices.[¶](#section-3.3-2){.pilcrow}
:::
:::

::: {#no-server-initiated-transactions}
::: {#section-3.4 .section}
### [3.4.](#section-3.4){.section-number .selfRef} [No Server-Initiated Transactions](#name-no-server-initiated-transac){.section-name .selfRef} {#name-no-server-initiated-transac}

As stated in [Section 1](#introduction){.xref}, this document does not
specify support for server-initiated transactions within established DoQ
connections. That is, only the initiator of the DoQ connection may send
queries over the connection.[¶](#section-3.4-1){.pilcrow}

DSO does support server-initiated transactions within existing
connections. However, DoQ as defined here does not meet the criteria for
an applicable transport for DSO because it does not guarantee in-order
delivery of messages; see [Section
4.2](https://www.rfc-editor.org/rfc/rfc8490#section-4.2){.relref} of
\[[RFC8490](#RFC8490){.xref}\].[¶](#section-3.4-2){.pilcrow}
:::
:::
:::
:::

::: {#specifications}
::: {#section-4 .section}
## [4.](#section-4){.section-number .selfRef} [Specifications](#name-specifications){.section-name .selfRef} {#name-specifications}

::: {#connection-establishment}
::: {#section-4.1 .section}
### [4.1.](#section-4.1){.section-number .selfRef} [Connection Establishment](#name-connection-establishment){.section-name .selfRef} {#name-connection-establishment}

DoQ connections are established as described in the QUIC transport
specification \[[RFC9000](#RFC9000){.xref}\]. During connection
establishment, DoQ support is indicated by selecting the
Application-Layer Protocol Negotiation (ALPN) token \"doq\" in the
crypto handshake.[¶](#section-4.1-1){.pilcrow}

::: {#port-selection}
::: {#section-4.1.1 .section}
#### [4.1.1.](#section-4.1.1){.section-number .selfRef} [Port Selection](#name-port-selection){.section-name .selfRef} {#name-port-selection}

By default, a DNS server that supports DoQ [MUST]{.bcp14} listen for and
accept QUIC connections on the dedicated UDP port 853 ([Section
8](#iana-considerations){.xref}), unless there is a mutual agreement to
use another port.[¶](#section-4.1.1-1){.pilcrow}

By default, a DNS client desiring to use DoQ with a particular server
[MUST]{.bcp14} establish a QUIC connection to UDP port 853 on the
server, unless there is a mutual agreement to use another
port.[¶](#section-4.1.1-2){.pilcrow}

DoQ connections [MUST NOT]{.bcp14} use UDP port 53. This recommendation
against use of port 53 for DoQ is to avoid confusion between DoQ and the
use of DNS over UDP \[[RFC1035](#RFC1035){.xref}\]. The risk of
confusion exists even if two parties agreed on port 53, as other parties
without knowledge of that agreement might still try to use that
port.[¶](#section-4.1.1-3){.pilcrow}

In the stub to recursive scenario, the use of port 443 as a mutually
agreed alternative port can be operationally beneficial, since port 443
is used by many services using QUIC and HTTP-3 and is thus less likely
to be blocked than other ports. Several mechanisms for stubs to discover
recursives offering encrypted transports, including the use of custom
ports, are the subject of ongoing work.[¶](#section-4.1.1-4){.pilcrow}
:::
:::
:::
:::

::: {#stream-mapping-and-usage}
::: {#section-4.2 .section}
### [4.2.](#section-4.2){.section-number .selfRef} [Stream Mapping and Usage](#name-stream-mapping-and-usage){.section-name .selfRef} {#name-stream-mapping-and-usage}

The mapping of DNS traffic over QUIC streams takes advantage of the QUIC
stream features detailed in [Section
2](https://www.rfc-editor.org/rfc/rfc9000#section-2){.relref} of
\[[RFC9000](#RFC9000){.xref}\], the QUIC transport
specification.[¶](#section-4.2-1){.pilcrow}

DNS query/response traffic \[[RFC1034](#RFC1034){.xref}\]
\[[RFC1035](#RFC1035){.xref}\] follows a simple pattern in which the
client sends a query, and the server provides one or more responses
(multiple responses can occur in zone
transfers).[¶](#section-4.2-2){.pilcrow}

The mapping specified here requires that the client select a separate
QUIC stream for each query. The server then uses the same stream to
provide all the response messages for that query. In order for multiple
responses to be parsed, a 2-octet length field is used in exactly the
same way as the 2-octet length field defined for DNS over TCP
\[[RFC1035](#RFC1035){.xref}\]. The practical result of this is that the
content of each QUIC stream is exactly the same as the content of a TCP
connection that would manage exactly one
query.[¶](#section-4.2-3){.pilcrow}

All DNS messages (queries and responses) sent over DoQ connections
[MUST]{.bcp14} be encoded as a 2-octet length field followed by the
message content as specified in
\[[RFC1035](#RFC1035){.xref}\].[¶](#section-4.2-4){.pilcrow}

The client [MUST]{.bcp14} select the next available client-initiated
bidirectional stream for each subsequent query on a QUIC connection, in
conformance with the QUIC transport specification
\[[RFC9000](#RFC9000){.xref}\]. Packet losses and other network events
might cause queries to arrive in a different order. Servers
[SHOULD]{.bcp14} process queries as they arrive, as not doing so would
cause unnecessary delays.[¶](#section-4.2-5){.pilcrow}

The client [MUST]{.bcp14} send the DNS query over the selected stream
and [MUST]{.bcp14} indicate through the STREAM FIN mechanism that no
further data will be sent on that stream.[¶](#section-4.2-6){.pilcrow}

The server [MUST]{.bcp14} send the response(s) on the same stream and
[MUST]{.bcp14} indicate, after the last response, through the STREAM FIN
mechanism that no further data will be sent on that
stream.[¶](#section-4.2-7){.pilcrow}

Therefore, a single DNS transaction consumes a single bidirectional
client-initiated stream. This means that the client\'s first query
occurs on QUIC stream 0, the second on 4, and so on (see [Section
2.1](https://www.rfc-editor.org/rfc/rfc9000#section-2.1){.relref} of
\[[RFC9000](#RFC9000){.xref}\]).[¶](#section-4.2-8){.pilcrow}

Servers [MAY]{.bcp14} defer processing of a query until the STREAM FIN
has been indicated on the stream selected by the
client.[¶](#section-4.2-9){.pilcrow}

Servers and clients [MAY]{.bcp14} monitor the number of \"dangling\"
streams. These are open streams where the following events have not
occurred after implementation-defined
timeouts:[¶](#section-4.2-10){.pilcrow}

-   [the expected queries or responses have not been received
    or,[¶](#section-4.2-11.1){.pilcrow}]{#section-4.2-11.1}
-   [the expected queries or responses have been received but not the
    STREAM FIN[¶](#section-4.2-11.2){.pilcrow}]{#section-4.2-11.2}

Implementations [MAY]{.bcp14} impose a limit on the number of such
dangling streams. If limits are encountered, implementations
[MAY]{.bcp14} close the connection.[¶](#section-4.2-12){.pilcrow}

::: {#dns-message-ids}
::: {#section-4.2.1 .section}
#### [4.2.1.](#section-4.2.1){.section-number .selfRef} [DNS Message IDs](#name-dns-message-ids){.section-name .selfRef} {#name-dns-message-ids}

When sending queries over a QUIC connection, the DNS Message ID
[MUST]{.bcp14} be set to 0. The stream mapping for DoQ allows for
unambiguous correlation of queries and responses, so the Message ID
field is not required.[¶](#section-4.2.1-1){.pilcrow}

This has implications for proxying DoQ messages to and from other
transports. For example, proxies may have to manage the fact that DoQ
can support a larger number of outstanding queries on a single
connection than, for example, DNS over TCP, because DoQ is not limited
by the Message ID space. This issue already exists for DoH, where a
Message ID of 0 is recommended.[¶](#section-4.2.1-2){.pilcrow}

When forwarding a DNS message from DoQ over another transport, a DNS
Message ID [MUST]{.bcp14} be generated according to the rules of the
protocol that is in use. When forwarding a DNS message from another
transport over DoQ, the Message ID [MUST]{.bcp14} be set to
0.[¶](#section-4.2.1-3){.pilcrow}
:::
:::
:::
:::

::: {#doq-error-codes}
::: {#section-4.3 .section}
### [4.3.](#section-4.3){.section-number .selfRef} [DoQ Error Codes](#name-doq-error-codes){.section-name .selfRef} {#name-doq-error-codes}

The following error codes are defined for use when abruptly terminating
streams, for use as application protocol error codes when aborting
reading of streams, or for immediately closing
connections:[¶](#section-4.3-1){.pilcrow}

[]{.break}

DOQ_NO_ERROR (0x0):

:   No error. This is used when the connection or stream needs to be
    closed, but there is no error to
    signal.[¶](#section-4.3-2.2.1){.pilcrow}

:   

DOQ_INTERNAL_ERROR (0x1):

:   The DoQ implementation encountered an internal error and is
    incapable of pursuing the transaction or the
    connection.[¶](#section-4.3-2.4.1){.pilcrow}

:   

DOQ_PROTOCOL_ERROR (0x2):

:   The DoQ implementation encountered a protocol error and is forcibly
    aborting the connection.[¶](#section-4.3-2.6.1){.pilcrow}

:   

DOQ_REQUEST_CANCELLED (0x3):

:   A DoQ client uses this to signal that it wants to cancel an
    outstanding transaction.[¶](#section-4.3-2.8.1){.pilcrow}

:   

DOQ_EXCESSIVE_LOAD (0x4):

:   A DoQ implementation uses this to signal when closing a connection
    due to excessive load.[¶](#section-4.3-2.10.1){.pilcrow}

:   

DOQ_UNSPECIFIED_ERROR (0x5):

:   A DoQ implementation uses this in the absence of a more specific
    error code.[¶](#section-4.3-2.12.1){.pilcrow}

:   

DOQ_ERROR_RESERVED (0xd098ea5e):

:   An alternative error code used for
    tests.[¶](#section-4.3-2.14.1){.pilcrow}

:   

See [Section 8.4](#iana-error-codes){.xref} for details on registering
new error codes.[¶](#section-4.3-3){.pilcrow}

::: {#transaction-cancellation}
::: {#section-4.3.1 .section}
#### [4.3.1.](#section-4.3.1){.section-number .selfRef} [Transaction Cancellation](#name-transaction-cancellation){.section-name .selfRef} {#name-transaction-cancellation}

In QUIC, sending STOP_SENDING requests that a peer cease transmission on
a stream. If a DoQ client wishes to cancel an outstanding request, it
[MUST]{.bcp14} issue a QUIC STOP_SENDING, and it [SHOULD]{.bcp14} use
the error code DOQ_REQUEST_CANCELLED. It [MAY]{.bcp14} use a more
specific error code registered according to [Section
8.4](#iana-error-codes){.xref}. The STOP_SENDING request may be sent at
any time but will have no effect if the server response has already been
sent, in which case the client will simply discard the incoming
response. The corresponding DNS transaction [MUST]{.bcp14} be
abandoned.[¶](#section-4.3.1-1){.pilcrow}

Servers that receive STOP_SENDING act in accordance with [Section
3.5](https://www.rfc-editor.org/rfc/rfc9000#section-3.5){.relref} of
\[[RFC9000](#RFC9000){.xref}\]. Servers [SHOULD NOT]{.bcp14} continue
processing a DNS transaction if they receive a
STOP_SENDING.[¶](#section-4.3.1-2){.pilcrow}

Servers [MAY]{.bcp14} impose implementation limits on the total number
or rate of cancellation requests. If limits are encountered, servers
[MAY]{.bcp14} close the connection. In this case, servers wanting to
help client debugging [MAY]{.bcp14} use the error code
DOQ_EXCESSIVE_LOAD. There is always a trade-off between helping good
faith clients debug issues and allowing denial-of-service attackers to
test server defenses; depending on circumstances servers might very well
choose to send different error codes.[¶](#section-4.3.1-3){.pilcrow}

Note that this mechanism provides a way for secondaries to cancel a
single zone transfer occurring on a given stream without having to close
the QUIC connection.[¶](#section-4.3.1-4){.pilcrow}

Servers [MUST NOT]{.bcp14} continue processing a DNS transaction if they
receive a RESET_STREAM request from the client before the client
indicates the STREAM FIN. The server [MUST]{.bcp14} issue a RESET_STREAM
to indicate that the transaction is abandoned
unless:[¶](#section-4.3.1-5){.pilcrow}

-   [it has already done so for another reason
    or[¶](#section-4.3.1-6.1){.pilcrow}]{#section-4.3.1-6.1}
-   [it has already both sent the response and indicated the STREAM
    FIN.[¶](#section-4.3.1-6.2){.pilcrow}]{#section-4.3.1-6.2}
:::
:::

::: {#transaction-errors}
::: {#section-4.3.2 .section}
#### [4.3.2.](#section-4.3.2){.section-number .selfRef} [Transaction Errors](#name-transaction-errors){.section-name .selfRef} {#name-transaction-errors}

Servers normally complete transactions by sending a DNS response (or
responses) on the transaction\'s stream, including cases where the DNS
response indicates a DNS error. For example, a client [SHOULD]{.bcp14}
be notified of a Server Failure (SERVFAIL,
\[[RFC1035](#RFC1035){.xref}\]) through a response with the Response
Code set to SERVFAIL.[¶](#section-4.3.2-1){.pilcrow}

If a server is incapable of sending a DNS response due to an internal
error, it [SHOULD]{.bcp14} issue a QUIC RESET_STREAM frame. The error
code [SHOULD]{.bcp14} be set to DOQ_INTERNAL_ERROR. The corresponding
DNS transaction [MUST]{.bcp14} be abandoned. Clients [MAY]{.bcp14} limit
the number of unsolicited QUIC RESET_STREAM frames received on a
connection before choosing to close the
connection.[¶](#section-4.3.2-2){.pilcrow}

Note that this mechanism provides a way for primaries to abort a single
zone transfer occurring on a given stream without having to close the
QUIC connection.[¶](#section-4.3.2-3){.pilcrow}
:::
:::

::: {#protocol-errors}
::: {#section-4.3.3 .section}
#### [4.3.3.](#section-4.3.3){.section-number .selfRef} [Protocol Errors](#name-protocol-errors){.section-name .selfRef} {#name-protocol-errors}

Other error scenarios can occur due to malformed, incomplete, or
unexpected messages during a transaction. These include (but are not
limited to):[¶](#section-4.3.3-1){.pilcrow}

-   [a client or server receives a message with a non-zero Message
    ID[¶](#section-4.3.3-2.1){.pilcrow}]{#section-4.3.3-2.1}
-   [a client or server receives a STREAM FIN before receiving all the
    bytes for a message indicated in the 2-octet length
    field[¶](#section-4.3.3-2.2){.pilcrow}]{#section-4.3.3-2.2}
-   [a client receives a STREAM FIN before receiving all the expected
    responses[¶](#section-4.3.3-2.3){.pilcrow}]{#section-4.3.3-2.3}
-   [a server receives more than one query on a
    stream[¶](#section-4.3.3-2.4){.pilcrow}]{#section-4.3.3-2.4}
-   [a client receives a different number of responses on a stream than
    expected (e.g., multiple responses to a query for an A
    record)[¶](#section-4.3.3-2.5){.pilcrow}]{#section-4.3.3-2.5}
-   [a client receives a STOP_SENDING
    request[¶](#section-4.3.3-2.6){.pilcrow}]{#section-4.3.3-2.6}
-   [the client or server does not indicate the expected STREAM FIN
    after sending requests or responses (see [Section
    4.2](#stream-mapping-and-usage){.xref})[¶](#section-4.3.3-2.7){.pilcrow}]{#section-4.3.3-2.7}
-   [an implementation receives a message containing the
    edns-tcp-keepalive EDNS(0) Option \[[RFC7828](#RFC7828){.xref}\]
    (see [Section
    5.5.2](#resource-management){.xref})[¶](#section-4.3.3-2.8){.pilcrow}]{#section-4.3.3-2.8}
-   [a client or a server attempts to open a unidirectional QUIC
    stream[¶](#section-4.3.3-2.9){.pilcrow}]{#section-4.3.3-2.9}
-   [a server attempts to open a server-initiated bidirectional QUIC
    stream[¶](#section-4.3.3-2.10){.pilcrow}]{#section-4.3.3-2.10}
-   [a server receives a \"replayable\" transaction in 0-RTT data (for
    servers not willing to handle this case, see [Section
    4.5](#session-resumption-and-0-rtt){.xref})[¶](#section-4.3.3-2.11){.pilcrow}]{#section-4.3.3-2.11}

If a peer encounters such an error condition, it is considered a fatal
error. It [SHOULD]{.bcp14} forcibly abort the connection using QUIC\'s
CONNECTION_CLOSE mechanism and [SHOULD]{.bcp14} use the DoQ error code
DOQ_PROTOCOL_ERROR. In some cases, it [MAY]{.bcp14} instead silently
abandon the connection, which uses fewer of the local resources but
makes debugging at the offending node more
difficult.[¶](#section-4.3.3-3){.pilcrow}

It is noted that the restrictions on use of the above EDNS(0) option has
implications for proxying messages from TCP/DoT/DoH over
DoQ.[¶](#section-4.3.3-4){.pilcrow}
:::
:::

::: {#alternative-error-codes}
::: {#section-4.3.4 .section}
#### [4.3.4.](#section-4.3.4){.section-number .selfRef} [Alternative Error Codes](#name-alternative-error-codes){.section-name .selfRef} {#name-alternative-error-codes}

This specification describes specific error codes in Sections
[4.3.1](#transaction-cancellation){.xref},
[4.3.2](#transaction-errors){.xref}, and
[4.3.3](#protocol-errors){.xref}. These error codes are meant to
facilitate investigation of failures and other incidents. New error
codes may be defined in future versions of DoQ or registered as
specified in [Section
8.4](#iana-error-codes){.xref}.[¶](#section-4.3.4-1){.pilcrow}

Because new error codes can be defined without negotiation, use of an
error code in an unexpected context or receipt of an unknown error code
[MUST]{.bcp14} be treated as equivalent to
DOQ_UNSPECIFIED_ERROR.[¶](#section-4.3.4-2){.pilcrow}

Implementations [MAY]{.bcp14} wish to test the support for the error
code extension mechanism by using error codes not listed in this
document, or they [MAY]{.bcp14} use
DOQ_ERROR_RESERVED.[¶](#section-4.3.4-3){.pilcrow}
:::
:::
:::
:::

::: {#connection-management}
::: {#section-4.4 .section}
### [4.4.](#section-4.4){.section-number .selfRef} [Connection Management](#name-connection-management){.section-name .selfRef} {#name-connection-management}

[Section 10](https://www.rfc-editor.org/rfc/rfc9000#section-10){.relref}
of \[[RFC9000](#RFC9000){.xref}\], the QUIC transport specification,
specifies that connections can be closed in three
ways:[¶](#section-4.4-1){.pilcrow}

-   [idle timeout[¶](#section-4.4-2.1){.pilcrow}]{#section-4.4-2.1}
-   [immediate close[¶](#section-4.4-2.2){.pilcrow}]{#section-4.4-2.2}
-   [stateless reset[¶](#section-4.4-2.3){.pilcrow}]{#section-4.4-2.3}

Clients and servers implementing DoQ [SHOULD]{.bcp14} negotiate use of
the idle timeout. Closing on idle timeout is done without any packet
exchange, which minimizes protocol overhead. Per [Section
10.1](https://www.rfc-editor.org/rfc/rfc9000#section-10.1){.relref} of
\[[RFC9000](#RFC9000){.xref}\], the QUIC transport specification, the
effective value of the idle timeout is computed as the minimum of the
values advertised by the two endpoints. Practical considerations on
setting the idle timeout are discussed in [Section
5.5.2](#resource-management){.xref}.[¶](#section-4.4-3){.pilcrow}

Clients [SHOULD]{.bcp14} monitor the idle time incurred on their
connection to the server, defined by the time spent since the last
packet from the server has been received. When a client prepares to send
a new DNS query to the server, it [SHOULD]{.bcp14} check whether the
idle time is sufficiently lower than the idle timer. If it is, the
client [SHOULD]{.bcp14} send the DNS query over the existing connection.
If not, the client [SHOULD]{.bcp14} establish a new connection and send
the query over that connection.[¶](#section-4.4-4){.pilcrow}

Clients [MAY]{.bcp14} discard their connections to the server before the
idle timeout expires. A client that has outstanding queries
[SHOULD]{.bcp14} close the connection explicitly using QUIC\'s
CONNECTION_CLOSE mechanism and the DoQ error code
DOQ_NO_ERROR.[¶](#section-4.4-5){.pilcrow}

Clients and servers [MAY]{.bcp14} close the connection for a variety of
other reasons, indicated using QUIC\'s CONNECTION_CLOSE. Client and
servers that send packets over a connection discarded by their peer
might receive a stateless reset indication. If a connection fails, all
the in-progress transactions on that connection [MUST]{.bcp14} be
abandoned.[¶](#section-4.4-6){.pilcrow}
:::
:::

::: {#session-resumption-and-0-rtt}
::: {#section-4.5 .section}
### [4.5.](#section-4.5){.section-number .selfRef} [Session Resumption and 0-RTT](#name-session-resumption-and-0-rt){.section-name .selfRef} {#name-session-resumption-and-0-rt}

A client [MAY]{.bcp14} take advantage of the session resumption and
0-RTT mechanisms supported by QUIC transport
\[[RFC9000](#RFC9000){.xref}\] and QUIC TLS
\[[RFC9001](#RFC9001){.xref}\] if the server supports them. Clients
[SHOULD]{.bcp14} consider potential privacy issues associated with
session resumption before deciding to use this mechanism and
specifically evaluate the trade-offs presented in the various sections
of this document. The privacy issues are detailed in Sections
[7.1](#privacy-issues-with-0-rtt-data){.xref} and
[7.2](#privacy-issues-with-session-resumption){.xref}, and the
implementation considerations are discussed in [Section
5.5.3](#using-0-rtt-and-session-resumption){.xref}.[¶](#section-4.5-1){.pilcrow}

The 0-RTT mechanism [MUST NOT]{.bcp14} be used to send DNS requests that
are not \"replayable\" transactions. In this specification, only
transactions that have an OPCODE of QUERY or NOTIFY are considered
replayable; therefore, other OPCODES [MUST NOT]{.bcp14} be sent in 0-RTT
data. See [Appendix A](#the-notify-service){.xref} for a detailed
discussion of why NOTIFY is included here.[¶](#section-4.5-2){.pilcrow}

Servers [MAY]{.bcp14} support session resumption, and [MAY]{.bcp14} do
that with or without supporting 0-RTT, using the mechanisms described in
[Section
4.6.1](https://www.rfc-editor.org/rfc/rfc9001#section-4.6.1){.relref} of
\[[RFC9001](#RFC9001){.xref}\]. Servers supporting 0-RTT [MUST
NOT]{.bcp14} immediately process non-replayable transactions received in
0-RTT data but instead [MUST]{.bcp14} adopt one of the following
behaviors:[¶](#section-4.5-3){.pilcrow}

-   [Queue the offending transaction and only process it after the QUIC
    handshake has been completed, as defined in [Section
    4.1.1](https://www.rfc-editor.org/rfc/rfc9001#section-4.1.1){.relref}
    of
    \[[RFC9001](#RFC9001){.xref}\].[¶](#section-4.5-4.1){.pilcrow}]{#section-4.5-4.1}
-   [Reply to the offending transaction with a response code REFUSED and
    an Extended DNS Error Code (EDE) \"Too Early\" using the extended
    RCODE mechanisms defined in \[[RFC6891](#RFC6891){.xref}\] and the
    extended DNS errors defined in \[[RFC8914](#RFC8914){.xref}\]; see
    [Section
    8.3](#reservation-of-extended-dns-error-code-too-early){.xref}.[¶](#section-4.5-4.2){.pilcrow}]{#section-4.5-4.2}
-   [Close the connection with the error code
    DOQ_PROTOCOL_ERROR.[¶](#section-4.5-4.3){.pilcrow}]{#section-4.5-4.3}
:::
:::

::: {#message-sizes}
::: {#section-4.6 .section}
### [4.6.](#section-4.6){.section-number .selfRef} [Message Sizes](#name-message-sizes){.section-name .selfRef} {#name-message-sizes}

DoQ queries and responses are sent on QUIC streams, which in theory can
carry up to 2^62^ bytes. However, DNS messages are restricted in
practice to a maximum size of 65535 bytes. This maximum size is enforced
by the use of a 2-octet message length field in DNS over TCP
\[[RFC1035](#RFC1035){.xref}\] and DoT \[[RFC7858](#RFC7858){.xref}\],
and by the definition of the \"application/dns-message\" for DoH
\[[RFC8484](#RFC8484){.xref}\]. DoQ enforces the same
restriction.[¶](#section-4.6-1){.pilcrow}

The Extension Mechanisms for DNS (EDNS(0))
\[[RFC6891](#RFC6891){.xref}\] allow peers to specify the UDP message
size. This parameter is ignored by DoQ. DoQ implementations always
assume that the maximum message size is 65535
bytes.[¶](#section-4.6-2){.pilcrow}
:::
:::
:::
:::

::: {#implementation-requirements}
::: {#section-5 .section}
## [5.](#section-5){.section-number .selfRef} [Implementation Requirements](#name-implementation-requirements){.section-name .selfRef} {#name-implementation-requirements}

::: {#authentication}
::: {#section-5.1 .section}
### [5.1.](#section-5.1){.section-number .selfRef} [Authentication](#name-authentication){.section-name .selfRef} {#name-authentication}

For the stub to recursive scenario, the authentication requirements are
the same as described in DoT \[[RFC7858](#RFC7858){.xref}\] and \"Usage
Profiles for DNS over TLS and DNS over DTLS\"
\[[RFC8310](#RFC8310){.xref}\]. \[[RFC8932](#RFC8932){.xref}\] states
that DNS privacy services [SHOULD]{.bcp14} provide credentials that
clients can use to authenticate the server. Given this, and to align
with the authentication model for DoH, DoQ stubs [SHOULD]{.bcp14} use a
Strict usage profile. Client authentication for the encrypted stub to
recursive scenario is not described in any DNS
RFC.[¶](#section-5.1-1){.pilcrow}

For zone transfer, the authentication requirements are the same as
described in
\[[RFC9103](#RFC9103){.xref}\].[¶](#section-5.1-2){.pilcrow}

For the recursive to authoritative scenario, authentication requirements
are unspecified at the time of writing and are the subject of ongoing
work in the DPRIVE WG.[¶](#section-5.1-3){.pilcrow}
:::
:::

::: {#fallback-to-other-protocols-on-connection-failure}
::: {#section-5.2 .section}
### [5.2.](#section-5.2){.section-number .selfRef} [Fallback to Other Protocols on Connection Failure](#name-fallback-to-other-protocols){.section-name .selfRef} {#name-fallback-to-other-protocols}

If the establishment of the DoQ connection fails, clients [MAY]{.bcp14}
attempt to fall back to DoT and then potentially cleartext, as specified
in DoT \[[RFC7858](#RFC7858){.xref}\] and \"Usage Profiles for DNS over
TLS and DNS over DTLS\" \[[RFC8310](#RFC8310){.xref}\], depending on
their usage profile.[¶](#section-5.2-1){.pilcrow}

DNS clients [SHOULD]{.bcp14} remember server IP addresses that don\'t
support DoQ. Mobile clients might also remember the lack of DoQ support
by given IP addresses on a per-context basis (e.g., per network or
provisioning domain).[¶](#section-5.2-2){.pilcrow}

Timeouts, connection refusals, and QUIC handshake failures are
indicators that a server does not support DoQ. Clients [SHOULD
NOT]{.bcp14} attempt DoQ queries to a server that does not support DoQ
for a reasonable period (such as one hour per server). DNS clients
following an out-of-band key-pinned usage profile
\[[RFC7858](#RFC7858){.xref}\] [MAY]{.bcp14} be more aggressive about
retrying after DoQ connection failures.[¶](#section-5.2-3){.pilcrow}
:::
:::

::: {#address-validation}
::: {#section-5.3 .section}
### [5.3.](#section-5.3){.section-number .selfRef} [Address Validation](#name-address-validation){.section-name .selfRef} {#name-address-validation}

[Section 8](https://www.rfc-editor.org/rfc/rfc9000#section-8){.relref}
of \[[RFC9000](#RFC9000){.xref}\], the QUIC transport specification,
defines Address Validation procedures to avoid servers being used in
address amplification attacks. DoQ implementations [MUST]{.bcp14}
conform to this specification, which limits the worst-case amplification
to a factor 3.[¶](#section-5.3-1){.pilcrow}

DoQ implementations [SHOULD]{.bcp14} consider configuring servers to use
the Address Validation using Retry Packets procedure defined in [Section
8.1.2](https://www.rfc-editor.org/rfc/rfc9000#section-8.1.2){.relref} of
\[[RFC9000](#RFC9000){.xref}\], the QUIC transport specification. This
procedure imposes a 1-RTT delay for verifying the return routability of
the source address of a client, similar to the DNS Cookies mechanism
\[[RFC7873](#RFC7873){.xref}\].[¶](#section-5.3-2){.pilcrow}

DoQ implementations that configure Address Validation using Retry
Packets [SHOULD]{.bcp14} implement the Address Validation for Future
Connections procedure defined in [Section
8.1.3](https://www.rfc-editor.org/rfc/rfc9000#section-8.1.3){.relref} of
\[[RFC9000](#RFC9000){.xref}\], the QUIC transport specification. This
defines how servers can send NEW_TOKEN frames to clients after the
client address is validated in order to avoid the 1-RTT penalty during
subsequent connections by the client from the same
address.[¶](#section-5.3-3){.pilcrow}
:::
:::

::: {#padding}
::: {#section-5.4 .section}
### [5.4.](#section-5.4){.section-number .selfRef} [Padding](#name-padding){.section-name .selfRef} {#name-padding}

Implementations [MUST]{.bcp14} protect against the traffic analysis
attacks described in [Section 7.5](#traffic-analysis){.xref} by the
judicious injection of padding. This could be done either by padding
individual DNS messages using the EDNS(0) Padding Option
\[[RFC7830](#RFC7830){.xref}\] or by padding QUIC packets (see [Section
19.1](https://www.rfc-editor.org/rfc/rfc9000#section-19.1){.relref} of
\[[RFC9000](#RFC9000){.xref}\]).[¶](#section-5.4-1){.pilcrow}

In theory, padding at the QUIC packet level could result in better
performance for the equivalent protection, because the amount of padding
can take into account non-DNS frames such as acknowledgements or flow
control updates, and also because QUIC packets can carry multiple DNS
messages. However, applications can only control the amount of padding
in QUIC packets if the implementation of QUIC exposes adequate APIs.
This leads to the following
recommendations:[¶](#section-5.4-2){.pilcrow}

-   [If the implementation of QUIC exposes APIs to set a padding policy,
    DoQ [SHOULD]{.bcp14} use that API to align the packet length to a
    small set of fixed
    sizes.[¶](#section-5.4-3.1){.pilcrow}]{#section-5.4-3.1}
-   [If padding at the QUIC packet level is not available or not used,
    DoQ [MUST]{.bcp14} ensure that all DNS queries and responses are
    padded to a small set of fixed sizes, using the EDNS(0) padding
    extension as specified in
    \[[RFC7830](#RFC7830){.xref}\].[¶](#section-5.4-3.2){.pilcrow}]{#section-5.4-3.2}

Implementations might choose not to use a QUIC API for padding if it is
significantly simpler to reuse existing DNS message padding logic that
is applied to other encrypted transports.[¶](#section-5.4-4){.pilcrow}

In the absence of a standard policy for padding sizes, implementations
[SHOULD]{.bcp14} follow the recommendations of the Experimental status
\"Padding Policies for Extension Mechanisms for DNS (EDNS(0))\"
\[[RFC8467](#RFC8467){.xref}\]. While Experimental, these
recommendations are referenced because they are implemented and deployed
for DoT and provide a way for implementations to be fully compliant with
this specification.[¶](#section-5.4-5){.pilcrow}
:::
:::

::: {#connection-handling}
::: {#section-5.5 .section}
### [5.5.](#section-5.5){.section-number .selfRef} [Connection Handling](#name-connection-handling){.section-name .selfRef} {#name-connection-handling}

\"DNS Transport over TCP - Implementation Requirements\"
\[[RFC7766](#RFC7766){.xref}\] provides updated guidance on DNS over
TCP, some of which is applicable to DoQ. This section provides similar
advice on connection handling for DoQ.[¶](#section-5.5-1){.pilcrow}

::: {#connection-reuse}
::: {#section-5.5.1 .section}
#### [5.5.1.](#section-5.5.1){.section-number .selfRef} [Connection Reuse](#name-connection-reuse){.section-name .selfRef} {#name-connection-reuse}

Historic implementations of DNS clients are known to open and close TCP
connections for each DNS query. To amortize connection setup costs, both
clients and servers [SHOULD]{.bcp14} support connection reuse by sending
multiple queries and responses over a single persistent QUIC
connection.[¶](#section-5.5.1-1){.pilcrow}

In order to achieve performance on par with UDP, DNS clients
[SHOULD]{.bcp14} send their queries concurrently over the QUIC streams
on a QUIC connection. That is, when a DNS client sends multiple queries
to a server over a QUIC connection, it [SHOULD NOT]{.bcp14} wait for an
outstanding reply before sending the next
query.[¶](#section-5.5.1-2){.pilcrow}
:::
:::

::: {#resource-management}
::: {#section-5.5.2 .section}
#### [5.5.2.](#section-5.5.2){.section-number .selfRef} [Resource Management](#name-resource-management){.section-name .selfRef} {#name-resource-management}

Proper management of established and idle connections is important to
the healthy operation of a DNS server.[¶](#section-5.5.2-1){.pilcrow}

An implementation of DoQ [SHOULD]{.bcp14} follow best practices similar
to those specified for DNS over TCP \[[RFC7766](#RFC7766){.xref}\], in
particular with regard to:[¶](#section-5.5.2-2){.pilcrow}

-   [Concurrent Connections ([Section
    6.2.2](https://www.rfc-editor.org/rfc/rfc7766#section-6.2.2){.relref}
    of \[[RFC7766](#RFC7766){.xref}\], updated by [Section
    6.4](https://www.rfc-editor.org/rfc/rfc9103#section-6.4){.relref} of
    \[[RFC9103](#RFC9103){.xref}\])[¶](#section-5.5.2-3.1){.pilcrow}]{#section-5.5.2-3.1}
-   [Security Considerations ([Section
    10](https://www.rfc-editor.org/rfc/rfc7766#section-10){.relref} of
    \[[RFC7766](#RFC7766){.xref}\])[¶](#section-5.5.2-3.2){.pilcrow}]{#section-5.5.2-3.2}

Failure to do so may lead to resource exhaustion and denial of
service.[¶](#section-5.5.2-4){.pilcrow}

Clients that want to maintain long duration DoQ connections
[SHOULD]{.bcp14} use the idle timeout mechanisms defined in [Section
10.1](https://www.rfc-editor.org/rfc/rfc9000#section-10.1){.relref} of
\[[RFC9000](#RFC9000){.xref}\], the QUIC transport specification.
Clients and servers [MUST NOT]{.bcp14} send the edns-tcp-keepalive
EDNS(0) Option \[[RFC7828](#RFC7828){.xref}\] in any messages sent on a
DoQ connection (because it is specific to the use of TCP/TLS as a
transport).[¶](#section-5.5.2-5){.pilcrow}

This document does not make specific recommendations for timeout values
on idle connections. Clients and servers should reuse and/or close
connections depending on the level of available resources. Timeouts may
be longer during periods of low activity and shorter during periods of
high activity.[¶](#section-5.5.2-6){.pilcrow}
:::
:::

::: {#using-0-rtt-and-session-resumption}
::: {#section-5.5.3 .section}
#### [5.5.3.](#section-5.5.3){.section-number .selfRef} [Using 0-RTT and Session Resumption](#name-using-0-rtt-and-session-res){.section-name .selfRef} {#name-using-0-rtt-and-session-res}

Using 0-RTT for DoQ has many compelling advantages. Clients can
establish connections and send queries without incurring a connection
delay. Servers can thus negotiate low values of the connection timers,
which reduces the total number of connections that they need to manage.
They can do that because the clients that use 0-RTT will not incur
latency penalties if new connections are required for a
query.[¶](#section-5.5.3-1){.pilcrow}

Session resumption and 0-RTT data transmission create privacy risks
detailed in Sections [7.1](#privacy-issues-with-0-rtt-data){.xref} and
[7.2](#privacy-issues-with-session-resumption){.xref}. The following
recommendations are meant to reduce the privacy risks while enjoying the
performance benefits of 0-RTT data, subject to the restrictions
specified in [Section
4.5](#session-resumption-and-0-rtt){.xref}.[¶](#section-5.5.3-2){.pilcrow}

Clients [SHOULD]{.bcp14} use resumption tickets only once, as specified
in [Appendix
C.4](https://www.rfc-editor.org/rfc/rfc8446#appendix-C.4){.relref} of
\[[RFC8446](#RFC8446){.xref}\]. By default, clients [SHOULD NOT]{.bcp14}
use session resumption if the client\'s connectivity has
changed.[¶](#section-5.5.3-3){.pilcrow}

Clients could receive address validation tokens from the server using
the NEW_TOKEN mechanism; see [Section
8](https://www.rfc-editor.org/rfc/rfc9000#section-8){.relref} of
\[[RFC9000](#RFC9000){.xref}\]. The associated tracking risks are
mentioned in [Section
7.3](#privacy-issues-with-address-validation-tokens){.xref}. Clients
[SHOULD]{.bcp14} only use the address validation tokens when they are
also using session resumption thus avoiding additional tracking
risks.[¶](#section-5.5.3-4){.pilcrow}

Servers [SHOULD]{.bcp14} issue session resumption tickets with a
sufficiently long lifetime (e.g., 6 hours), so that clients are not
tempted to either keep the connection alive or frequently poll the
server to renew session resumption tickets. Servers [SHOULD]{.bcp14}
implement the anti-replay mechanisms specified in [Section
8](https://www.rfc-editor.org/rfc/rfc8446#section-8){.relref} of
\[[RFC8446](#RFC8446){.xref}\].[¶](#section-5.5.3-5){.pilcrow}
:::
:::

::: {#controlling-connection-migration-for-privacy}
::: {#section-5.5.4 .section}
#### [5.5.4.](#section-5.5.4){.section-number .selfRef} [Controlling Connection Migration for Privacy](#name-controlling-connection-migr){.section-name .selfRef} {#name-controlling-connection-migr}

DoQ implementations might consider using the connection migration
features defined in [Section
9](https://www.rfc-editor.org/rfc/rfc9000#section-9){.relref} of
\[[RFC9000](#RFC9000){.xref}\]. These features enable connections to
continue operating as the client\'s connectivity changes. As detailed in
[Section 7.4](#privacy-issues-with-long-duration-sessions){.xref}, these
features trade off privacy for latency. By default, clients
[SHOULD]{.bcp14} be configured to prioritize privacy and start new
sessions if their connectivity changes.[¶](#section-5.5.4-1){.pilcrow}
:::
:::
:::
:::

::: {#processing-queries-in-parallel}
::: {#section-5.6 .section}
### [5.6.](#section-5.6){.section-number .selfRef} [Processing Queries in Parallel](#name-processing-queries-in-paral){.section-name .selfRef} {#name-processing-queries-in-paral}

As specified in [Section
7](https://www.rfc-editor.org/rfc/rfc7766#section-7){.relref} of
\[[RFC7766](#RFC7766){.xref}\] \"DNS Transport over TCP - Implementation
Requirements\", resolvers are [RECOMMENDED]{.bcp14} to support the
preparing of responses in parallel and sending them out of order. In
DoQ, they do that by sending responses on their specific stream as soon
as possible, without waiting for availability of responses for
previously opened streams.[¶](#section-5.6-1){.pilcrow}
:::
:::

::: {#zone-transfer}
::: {#section-5.7 .section}
### [5.7.](#section-5.7){.section-number .selfRef} [Zone Transfer](#name-zone-transfer){.section-name .selfRef} {#name-zone-transfer}

\[[RFC9103](#RFC9103){.xref}\] specifies zone transfer over TLS (XoT)
and includes updates to \[[RFC1995](#RFC1995){.xref}\] (IXFR),
\[[RFC5936](#RFC5936){.xref}\] (AXFR), and
\[[RFC7766](#RFC7766){.xref}\]. Considerations relating to the reuse of
XoT connections described there apply analogously to zone transfers
performed using DoQ connections. One reason for reiterating such
specific guidance is the lack of effective connection reuse in existing
TCP/TLS zone transfer implementations today. The following
recommendations apply:[¶](#section-5.7-1){.pilcrow}

-   [DoQ servers [MUST]{.bcp14} be able to handle multiple concurrent
    IXFR requests on a single QUIC
    connection.[¶](#section-5.7-2.1){.pilcrow}]{#section-5.7-2.1}

-   [DoQ servers [MUST]{.bcp14} be able to handle multiple concurrent
    AXFR requests on a single QUIC
    connection.[¶](#section-5.7-2.2){.pilcrow}]{#section-5.7-2.2}

-   ::: {#section-5.7-2.3}
    DoQ implementations
    [SHOULD]{.bcp14}[¶](#section-5.7-2.3.1){.pilcrow}

    -   [use the same QUIC connection for both AXFR and IXFR requests to
        the same
        primary[¶](#section-5.7-2.3.2.1){.pilcrow}]{#section-5.7-2.3.2.1}
    -   [send those requests in parallel as soon as they are queued,
        i.e., do not wait for a response before sending the next query
        on the connection (this is analogous to pipelining requests on a
        TCP/TLS
        connection)[¶](#section-5.7-2.3.2.2){.pilcrow}]{#section-5.7-2.3.2.2}
    -   [send the response(s) for each request as soon as they are
        available, i.e., response streams [MAY]{.bcp14} be sent
        intermingled[¶](#section-5.7-2.3.2.3){.pilcrow}]{#section-5.7-2.3.2.3}
    :::
:::
:::

::: {#flow-control-mechanisms}
::: {#section-5.8 .section}
### [5.8.](#section-5.8){.section-number .selfRef} [Flow Control Mechanisms](#name-flow-control-mechanisms){.section-name .selfRef} {#name-flow-control-mechanisms}

Servers and clients manage flow control using the mechanisms defined in
[Section 4](https://www.rfc-editor.org/rfc/rfc9000#section-4){.relref}
of \[[RFC9000](#RFC9000){.xref}\]. These mechanisms allow clients and
servers to specify how many streams can be created, how much data can be
sent on a stream, and how much data can be sent on the union of all
streams. For DoQ, controlling how many streams are created allows
servers to control how many new requests the client can send on a given
connection.[¶](#section-5.8-1){.pilcrow}

Flow control exists to protect endpoint resources. For servers, global
and per-stream flow control limits control how much data can be sent by
clients. The same mechanisms allow clients to control how much data can
be sent by servers. Values that are too small will unnecessarily limit
performance. Values that are too large might expose endpoints to
overload or memory exhaustion. Implementations or deployments will need
to adjust flow control limits to balance these concerns. In particular,
zone transfer implementations will need to control these limits
carefully to ensure both large and concurrent zone transfers are well
managed.[¶](#section-5.8-2){.pilcrow}

Initial values of parameters control how many requests and how much data
can be sent by clients and servers at the beginning of the connection.
These values are specified in transport parameters exchanged during the
connection handshake. The parameter values received in the initial
connection also control how many requests and how much data can be sent
by clients using 0-RTT data in a resumed connection. Using too small
values of these initial parameters would restrict the usefulness of
allowing 0-RTT data.[¶](#section-5.8-3){.pilcrow}
:::
:::
:::
:::

::: {#security-considerations}
::: {#section-6 .section}
## [6.](#section-6){.section-number .selfRef} [Security Considerations](#name-security-considerations){.section-name .selfRef} {#name-security-considerations}

A Threat Analysis of the Domain Name System is found in
\[[RFC3833](#RFC3833){.xref}\]. This analysis was written before the
development of DoT, DoH, and DoQ, and probably needs to be
updated.[¶](#section-6-1){.pilcrow}

The security considerations of DoQ should be comparable to those of DoT
\[[RFC7858](#RFC7858){.xref}\]. DoT as specified in
\[[RFC7858](#RFC7858){.xref}\] only addresses the stub to recursive
scenario, but the considerations about person-in-the-middle attacks,
middleboxes, and caching of data from cleartext connections also apply
for DoQ to the resolver to authoritative server scenario. As stated in
[Section 5.1](#authentication){.xref}, the authentication requirements
for securing zone transfer using DoQ are the same as those for zone
transfer over DoT; therefore, the general security considerations are
entirely analogous to those described in
\[[RFC9103](#RFC9103){.xref}\].[¶](#section-6-2){.pilcrow}

DoQ relies on QUIC, which itself relies on TLS 1.3 and thus supports by
default the protections against downgrade attacks described in
\[[BCP195](#BCP195){.xref}\]. QUIC-specific issues and their mitigations
are described in [Section
21](https://www.rfc-editor.org/rfc/rfc9000#section-21){.relref} of
\[[RFC9000](#RFC9000){.xref}\].[¶](#section-6-3){.pilcrow}
:::
:::

::: {#privacy-considerations}
::: {#section-7 .section}
## [7.](#section-7){.section-number .selfRef} [Privacy Considerations](#name-privacy-considerations){.section-name .selfRef} {#name-privacy-considerations}

The general considerations of encrypted transports provided in \"DNS
Privacy Considerations\" \[[RFC9076](#RFC9076){.xref}\] apply to DoQ.
The specific considerations provided there do not differ between DoT and
DoQ, and they are not discussed further here. Similarly,
\"Recommendations for DNS Privacy Service Operators\"
\[[RFC8932](#RFC8932){.xref}\] (which covers operational, policy, and
security considerations for DNS privacy services) is also applicable to
DoQ services.[¶](#section-7-1){.pilcrow}

QUIC incorporates the mechanisms of TLS 1.3
\[[RFC8446](#RFC8446){.xref}\], and this enables QUIC transmission of
\"0-RTT\" data. This can provide interesting latency gains, but it
raises two concerns:[¶](#section-7-2){.pilcrow}

1.  [Adversaries could replay the 0-RTT data and infer its content from
    the behavior of the receiving
    server.[¶](#section-7-3.1){.pilcrow}]{#section-7-3.1}
2.  [The 0-RTT mechanism relies on TLS session resumption, which can
    provide linkability between successive client
    sessions.[¶](#section-7-3.2){.pilcrow}]{#section-7-3.2}

These issues are developed in Sections
[7.1](#privacy-issues-with-0-rtt-data){.xref} and
[7.2](#privacy-issues-with-session-resumption){.xref}.[¶](#section-7-4){.pilcrow}

::: {#privacy-issues-with-0-rtt-data}
::: {#section-7.1 .section}
### [7.1.](#section-7.1){.section-number .selfRef} [Privacy Issues with 0-RTT data](#name-privacy-issues-with-0-rtt-d){.section-name .selfRef} {#name-privacy-issues-with-0-rtt-d}

The 0-RTT data can be replayed by adversaries. That data may trigger
queries by a recursive resolver to authoritative resolvers. Adversaries
may be able to pick a time at which the recursive resolver outgoing
traffic is observable and thus find out what name was queried for in the
0-RTT data.[¶](#section-7.1-1){.pilcrow}

This risk is in fact a subset of the general problem of observing the
behavior of the recursive resolver discussed in \"DNS Privacy
Considerations\" \[[RFC9076](#RFC9076){.xref}\]. The attack is partially
mitigated by reducing the observability of this traffic. The mandatory
replay protection mechanisms in TLS 1.3 \[[RFC8446](#RFC8446){.xref}\]
limit but do not eliminate the risk of replay. 0-RTT packets can only be
replayed within a narrow window, which is only wide enough to account
for variations in clock skew and network
transmission.[¶](#section-7.1-2){.pilcrow}

The recommendation for TLS 1.3 \[[RFC8446](#RFC8446){.xref}\] is that
the capability to use 0-RTT data should be turned off by default and
only enabled if the user clearly understands the associated risks. In
the case of DoQ, allowing 0-RTT data provides significant performance
gains, and there is a concern that a recommendation to not use it would
simply be ignored. Instead, a set of practical recommendations is
provided in Sections [4.5](#session-resumption-and-0-rtt){.xref} and
[5.5.3](#using-0-rtt-and-session-resumption){.xref}.[¶](#section-7.1-3){.pilcrow}

The specifications in [Section
4.5](#session-resumption-and-0-rtt){.xref} block the most obvious risks
of replay attacks, as they only allow for transactions that will not
change the long-term state of the server.[¶](#section-7.1-4){.pilcrow}

The attacks described above apply to the stub resolver to recursive
resolver scenario, but similar attacks might be envisaged in the
recursive resolver to authoritative resolver scenario, and the same
mitigations apply.[¶](#section-7.1-5){.pilcrow}
:::
:::

::: {#privacy-issues-with-session-resumption}
::: {#section-7.2 .section}
### [7.2.](#section-7.2){.section-number .selfRef} [Privacy Issues with Session Resumption](#name-privacy-issues-with-session){.section-name .selfRef} {#name-privacy-issues-with-session}

The QUIC session resumption mechanism reduces the cost of
re-establishing sessions and enables 0-RTT data. There is a linkability
issue associated with session resumption, if the same resumption token
is used several times. Attackers on path between client and server could
observe repeated usage of the token and use that to track the client
over time or over multiple locations.[¶](#section-7.2-1){.pilcrow}

The session resumption mechanism allows servers to correlate the resumed
sessions with the initial sessions and thus to track the client. This
creates a virtual long duration session. The series of queries in that
session can be used by the server to identify the client. Servers can
most probably do that already if the client address remains constant,
but session resumption tickets also enable tracking after changes of the
client\'s address.[¶](#section-7.2-2){.pilcrow}

The recommendations in [Section
5.5.3](#using-0-rtt-and-session-resumption){.xref} are designed to
mitigate these risks. Using session tickets only once mitigates the risk
of tracking by third parties. Refusing to resume a session if addresses
change mitigates the incremental risk of tracking by the server (but the
risk of tracking by IP address remains).[¶](#section-7.2-3){.pilcrow}

The privacy trade-offs here may be context specific. Stub resolvers will
have a strong motivation to prefer privacy over latency since they often
change location. However, recursive resolvers that use a small set of
static IP addresses are more likely to prefer the reduced latency
provided by session resumption and may consider this a valid reason to
use resumption tickets even if the IP address changed between
sessions.[¶](#section-7.2-4){.pilcrow}

Encrypted zone transfer (\[[RFC9103](#RFC9103){.xref}\]) explicitly does
not attempt to hide the identity of the parties involved in the
transfer; at the same time, such transfers are not particularly latency
sensitive. This means that applications supporting zone transfers may
decide to apply the same protections as stub to recursive
applications.[¶](#section-7.2-5){.pilcrow}
:::
:::

::: {#privacy-issues-with-address-validation-tokens}
::: {#section-7.3 .section}
### [7.3.](#section-7.3){.section-number .selfRef} [Privacy Issues with Address Validation Tokens](#name-privacy-issues-with-address){.section-name .selfRef} {#name-privacy-issues-with-address}

QUIC specifies address validation mechanisms in [Section
8](https://www.rfc-editor.org/rfc/rfc9000#section-8){.relref} of
\[[RFC9000](#RFC9000){.xref}\]. Use of an address validation token
allows QUIC servers to avoid an extra RTT for new connections. Address
validation tokens are typically tied to an IP address. QUIC clients
normally only use these tokens when setting up a new connection from a
previously used address. However, clients are not always aware that they
are using a new address. This could be due to NAT, or because the client
does not have an API available to check if the IP address has changed
(which can be quite often for IPv6). There is a linkability risk if
clients mistakenly use address validation tokens after unknowingly
moving to a new location.[¶](#section-7.3-1){.pilcrow}

The recommendations in [Section
5.5.3](#using-0-rtt-and-session-resumption){.xref} mitigates this risk
by tying the usage of the NEW_TOKEN to that of session resumption,
though this recommendation does not cover the case where the client is
unaware of the address change.[¶](#section-7.3-2){.pilcrow}
:::
:::

::: {#privacy-issues-with-long-duration-sessions}
::: {#section-7.4 .section}
### [7.4.](#section-7.4){.section-number .selfRef} [Privacy Issues with Long Duration Sessions](#name-privacy-issues-with-long-du){.section-name .selfRef} {#name-privacy-issues-with-long-du}

A potential alternative to session resumption is the use of long
duration sessions: if a session remains open for a long time, new
queries can be sent without incurring connection establishment delays.
It is worth pointing out that the two solutions have similar privacy
characteristics. Session resumption may allow servers to keep track of
the IP addresses of clients, but long duration sessions have the same
effect.[¶](#section-7.4-1){.pilcrow}

In particular, a DoQ implementation might take advantage of the
connection migration features of QUIC to maintain a session even if the
client\'s connectivity changes, for example, if the client migrates from
a Wi-Fi connection to a cellular network connection and then to another
Wi-Fi connection. The server would be able to track the client location
by monitoring the succession of IP addresses used by the long duration
connection.[¶](#section-7.4-2){.pilcrow}

The recommendation in [Section
5.5.4](#controlling-connection-migration-for-privacy){.xref} mitigates
the privacy concerns related to long duration sessions using multiple
client addresses.[¶](#section-7.4-3){.pilcrow}
:::
:::

::: {#traffic-analysis}
::: {#section-7.5 .section}
### [7.5.](#section-7.5){.section-number .selfRef} [Traffic Analysis](#name-traffic-analysis){.section-name .selfRef} {#name-traffic-analysis}

Even though QUIC packets are encrypted, adversaries can gain information
from observing packet lengths, in both queries and responses, as well as
packet timing. Many DNS requests are emitted by web browsers. Loading a
specific web page may require resolving dozens of DNS names. If an
application adopts a simple mapping of one query or response per packet,
or \"one QUIC STREAM frame per packet\", then the succession of packet
lengths may provide enough information to identify the requested
site.[¶](#section-7.5-1){.pilcrow}

Implementations [SHOULD]{.bcp14} use the mechanisms defined in [Section
5.4](#padding){.xref} to mitigate this
attack.[¶](#section-7.5-2){.pilcrow}
:::
:::
:::
:::

::: {#iana-considerations}
::: {#section-8 .section}
## [8.](#section-8){.section-number .selfRef} [IANA Considerations](#name-iana-considerations){.section-name .selfRef} {#name-iana-considerations}

::: {#registration-of-doq-identification-string}
::: {#section-8.1 .section}
### [8.1.](#section-8.1){.section-number .selfRef} [Registration of a DoQ Identification String](#name-registration-of-a-doq-ident){.section-name .selfRef} {#name-registration-of-a-doq-ident}

This document creates a new registration for the identification of DoQ
in the \"TLS Application-Layer Protocol Negotiation (ALPN) Protocol
IDs\" registry
\[[RFC7301](#RFC7301){.xref}\].[¶](#section-8.1-1){.pilcrow}

The \"doq\" string identifies DoQ:[¶](#section-8.1-2){.pilcrow}

[]{.break}

Protocol:

:   DoQ[¶](#section-8.1-3.2.1){.pilcrow}

:   

Identification Sequence:

:   0x64 0x6F 0x71 (\"doq\")[¶](#section-8.1-3.4.1){.pilcrow}

:   

Specification:

:   This document[¶](#section-8.1-3.6.1){.pilcrow}

:   
:::
:::

::: {#reservation-of-dedicated-port}
::: {#section-8.2 .section}
### [8.2.](#section-8.2){.section-number .selfRef} [Reservation of a Dedicated Port](#name-reservation-of-a-dedicated-){.section-name .selfRef} {#name-reservation-of-a-dedicated-}

For both TCP and UDP, port 853 is currently reserved for \"DNS
query-response protocol run over TLS/DTLS\"
\[[RFC7858](#RFC7858){.xref}\].[¶](#section-8.2-1){.pilcrow}

However, the specification for DNS over DTLS (DoD)
\[[RFC8094](#RFC8094){.xref}\] is experimental, limited to stub to
resolver, and no implementations or deployments currently exist to the
authors\' knowledge (even though several years have passed since the
specification was published).[¶](#section-8.2-2){.pilcrow}

This specification additionally reserves the use of UDP port 853 for
DoQ. QUIC version 1 was designed to be able to coexist with other
protocols on the same port, including DTLS; see [Section
17.2](https://www.rfc-editor.org/rfc/rfc9000#section-17.2){.relref} of
\[[RFC9000](#RFC9000){.xref}\]. This means that deployments that serve
DoD and DoQ (QUIC version 1) on the same port will be able to
demultiplex the two due to the second most significant bit in each UDP
payload. Such deployments ought to check the signatures of future
versions or extensions (e.g.,
\[[GREASING-QUIC](#I-D.ietf-quic-bit-grease){.xref}\]) of QUIC and DTLS
before deploying them to serve DNS on the same
port.[¶](#section-8.2-3){.pilcrow}

IANA has updated the following value in the \"Service Name and Transport
Protocol Port Number Registry\" in the System range. The registry for
that range requires IETF Review or IESG Approval
\[[RFC6335](#RFC6335){.xref}\].[¶](#section-8.2-4){.pilcrow}

[]{.break}

Service Name:

:   domain-s[¶](#section-8.2-5.2.1){.pilcrow}

:   

Port Number:

:   853[¶](#section-8.2-5.4.1){.pilcrow}

:   

Transport Protocol(s):

:   UDP[¶](#section-8.2-5.6.1){.pilcrow}

:   

Assignee:

:   IESG[¶](#section-8.2-5.8.1){.pilcrow}

:   

Contact:

:   IETF Chair[¶](#section-8.2-5.10.1){.pilcrow}

:   

Description:

:   DNS query-response protocol run over DTLS or
    QUIC[¶](#section-8.2-5.12.1){.pilcrow}

:   

Reference:

:   \[[RFC7858](#RFC7858){.xref}\]\[[RFC8094](#RFC8094){.xref}\] This
    document[¶](#section-8.2-5.14.1){.pilcrow}

:   

Additionally, IANA has updated the Description field for the
corresponding TCP port 853 allocation to be \"DNS query-response
protocol run over TLS\" and removed \[[RFC8094](#RFC8094){.xref}\] from
the TCP allocation\'s Reference field for consistency and
clarity.[¶](#section-8.2-6){.pilcrow}
:::
:::

::: {#reservation-of-extended-dns-error-code-too-early}
::: {#section-8.3 .section}
### [8.3.](#section-8.3){.section-number .selfRef} [Reservation of an Extended DNS Error Code: Too Early](#name-reservation-of-an-extended-){.section-name .selfRef} {#name-reservation-of-an-extended-}

IANA has registered the following value in the \"Extended DNS Error
Codes\" registry
\[[RFC8914](#RFC8914){.xref}\]:[¶](#section-8.3-1){.pilcrow}

[]{.break}

INFO-CODE:

:   26[¶](#section-8.3-2.2.1){.pilcrow}

:   

Purpose:

:   Too Early[¶](#section-8.3-2.4.1){.pilcrow}

:   

Reference:

:   This document[¶](#section-8.3-2.6.1){.pilcrow}

:   
:::
:::

::: {#iana-error-codes}
::: {#section-8.4 .section}
### [8.4.](#section-8.4){.section-number .selfRef} [DNS-over-QUIC Error Codes Registry](#name-dns-over-quic-error-codes-r){.section-name .selfRef} {#name-dns-over-quic-error-codes-r}

IANA has added a registry for \"DNS-over-QUIC Error Codes\" on the
\"Domain Name System (DNS) Parameters\" web
page.[¶](#section-8.4-1){.pilcrow}

The \"DNS-over-QUIC Error Codes\" registry governs a 62-bit space. This
space is split into three regions that are governed by different
policies:[¶](#section-8.4-2){.pilcrow}

-   [Permanent registrations for values between 0x00 and 0x3f (in
    hexadecimal; inclusive), which are assigned using Standards Action
    or IESG Approval as defined in Sections
    [4.9](https://www.rfc-editor.org/rfc/rfc8126#section-4.9){.relref}
    and
    [4.10](https://www.rfc-editor.org/rfc/rfc8126#section-4.10){.relref}
    of
    \[[RFC8126](#RFC8126){.xref}\][¶](#section-8.4-3.1){.pilcrow}]{#section-8.4-3.1}
-   [Permanent registrations for values larger than 0x3f, which are
    assigned using the Specification Required policy
    (\[[RFC8126](#RFC8126){.xref}\])[¶](#section-8.4-3.2){.pilcrow}]{#section-8.4-3.2}
-   [Provisional registrations for values larger than 0x3f, which
    require Expert Review, as defined in [Section
    4.5](https://www.rfc-editor.org/rfc/rfc8126#section-4.5){.relref} of
    \[[RFC8126](#RFC8126){.xref}\].[¶](#section-8.4-3.3){.pilcrow}]{#section-8.4-3.3}

Provisional reservations share the range of values larger than 0x3f with
some permanent registrations. This is by design to enable conversion of
provisional registrations into permanent registrations without requiring
changes in deployed systems. (This design is aligned with the principles
set in [Section
22](https://www.rfc-editor.org/rfc/rfc9000#section-22){.relref} of
\[[RFC9000](#RFC9000){.xref}\].)[¶](#section-8.4-4){.pilcrow}

Registrations in this registry [MUST]{.bcp14} include the following
fields:[¶](#section-8.4-5){.pilcrow}

[]{.break}

Value:

:   The assigned codepoint[¶](#section-8.4-6.2.1){.pilcrow}

:   

Status:

:   \"Permanent\" or \"Provisional\"[¶](#section-8.4-6.4.1){.pilcrow}

:   

Contact:

:   Contact details for the registrant[¶](#section-8.4-6.6.1){.pilcrow}

:   

In addition, permanent registrations [MUST]{.bcp14}
include:[¶](#section-8.4-7){.pilcrow}

[]{.break}

Error:

:   A short mnemonic for the parameter[¶](#section-8.4-8.2.1){.pilcrow}

:   

Specification:

:   A reference to a publicly available specification for the value
    (optional for provisional
    registrations)[¶](#section-8.4-8.4.1){.pilcrow}

:   

Description:

:   A brief description of the error code semantics, which [MAY]{.bcp14}
    be a summary if a specification reference is
    provided[¶](#section-8.4-8.6.1){.pilcrow}

:   

Provisional registrations of codepoints are intended to allow for
private use and experimentation with extensions to DoQ. However,
provisional registrations could be reclaimed and reassigned for other
purposes. In addition to the parameters listed above, provisional
registrations [MUST]{.bcp14} include:[¶](#section-8.4-9){.pilcrow}

[]{.break}

Date:

:   The date of last update to the
    registration[¶](#section-8.4-10.2.1){.pilcrow}

:   

A request to update the date on any provisional registration can be made
without review from the designated
expert(s).[¶](#section-8.4-11){.pilcrow}

The initial content of this registry is shown in [Table
1](#iana-error-table){.xref} and all entries share the following
fields:[¶](#section-8.4-12){.pilcrow}

[]{.break}

Status:

:   Permanent[¶](#section-8.4-13.2.1){.pilcrow}

:   

Contact:

:   DPRIVE WG[¶](#section-8.4-13.4.1){.pilcrow}

:   

Specification:

:   [Section
    4.3](#doq-error-codes){.xref}[¶](#section-8.4-13.6.1){.pilcrow}

:   

[]{#name-initial-dns-over-quic-error}

::: {#iana-error-table}
  Value        Error                   Description
  ------------ ----------------------- -----------------------------------------
  0x0          DOQ_NO_ERROR            No error
  0x1          DOQ_INTERNAL_ERROR      Implementation error
  0x2          DOQ_PROTOCOL_ERROR      Generic protocol violation
  0x3          DOQ_REQUEST_CANCELLED   Request cancelled by client
  0x4          DOQ_EXCESSIVE_LOAD      Closing a connection for excessive load
  0x5          DOQ_UNSPECIFIED_ERROR   No error reason specified
  0xd098ea5e   DOQ_ERROR_RESERVED      Alternative error code used for tests

  : [Table 1](#table-1){.selfRef}: [Initial DNS-over-QUIC Error Codes
  Entries](#name-initial-dns-over-quic-error){.selfRef}
:::
:::
:::
:::
:::

::: {#section-9 .section}
## [9.](#section-9){.section-number .selfRef} [References](#name-references){.section-name .selfRef} {#name-references}

::: {#section-9.1 .section}
### [9.1.](#section-9.1){.section-number .selfRef} [Normative References](#name-normative-references){.section-name .selfRef} {#name-normative-references}

\[RFC1034\]
:   [Mockapetris, P.]{.refAuthor}, [\"Domain names - concepts and
    facilities\"]{.refTitle}, [STD 13]{.seriesInfo}, [RFC
    1034]{.seriesInfo}, [DOI 10.17487/RFC1034]{.seriesInfo}, November
    1987, \<<https://www.rfc-editor.org/info/rfc1034>\>.
:   

\[RFC1035\]
:   [Mockapetris, P.]{.refAuthor}, [\"Domain names - implementation and
    specification\"]{.refTitle}, [STD 13]{.seriesInfo}, [RFC
    1035]{.seriesInfo}, [DOI 10.17487/RFC1035]{.seriesInfo}, November
    1987, \<<https://www.rfc-editor.org/info/rfc1035>\>.
:   

\[RFC1995\]
:   [Ohta, M.]{.refAuthor}, [\"Incremental Zone Transfer in
    DNS\"]{.refTitle}, [RFC 1995]{.seriesInfo}, [DOI
    10.17487/RFC1995]{.seriesInfo}, August 1996,
    \<<https://www.rfc-editor.org/info/rfc1995>\>.
:   

\[RFC2119\]
:   [Bradner, S.]{.refAuthor}, [\"Key words for use in RFCs to Indicate
    Requirement Levels\"]{.refTitle}, [BCP 14]{.seriesInfo}, [RFC
    2119]{.seriesInfo}, [DOI 10.17487/RFC2119]{.seriesInfo}, March 1997,
    \<<https://www.rfc-editor.org/info/rfc2119>\>.
:   

\[RFC5936\]
:   [Lewis, E.]{.refAuthor} and [A. Hoenes, Ed.]{.refAuthor}, [\"DNS
    Zone Transfer Protocol (AXFR)\"]{.refTitle}, [RFC
    5936]{.seriesInfo}, [DOI 10.17487/RFC5936]{.seriesInfo}, June 2010,
    \<<https://www.rfc-editor.org/info/rfc5936>\>.
:   

\[RFC6891\]
:   [Damas, J.]{.refAuthor}, [Graff, M.]{.refAuthor}, and [P.
    Vixie]{.refAuthor}, [\"Extension Mechanisms for DNS
    (EDNS(0))\"]{.refTitle}, [STD 75]{.seriesInfo}, [RFC
    6891]{.seriesInfo}, [DOI 10.17487/RFC6891]{.seriesInfo}, April 2013,
    \<<https://www.rfc-editor.org/info/rfc6891>\>.
:   

\[RFC7301\]
:   [Friedl, S.]{.refAuthor}, [Popov, A.]{.refAuthor},
    [Langley, A.]{.refAuthor}, and [E. Stephan]{.refAuthor},
    [\"Transport Layer Security (TLS) Application-Layer Protocol
    Negotiation Extension\"]{.refTitle}, [RFC 7301]{.seriesInfo}, [DOI
    10.17487/RFC7301]{.seriesInfo}, July 2014,
    \<<https://www.rfc-editor.org/info/rfc7301>\>.
:   

\[RFC7766\]
:   [Dickinson, J.]{.refAuthor}, [Dickinson, S.]{.refAuthor},
    [Bellis, R.]{.refAuthor}, [Mankin, A.]{.refAuthor}, and [D.
    Wessels]{.refAuthor}, [\"DNS Transport over TCP - Implementation
    Requirements\"]{.refTitle}, [RFC 7766]{.seriesInfo}, [DOI
    10.17487/RFC7766]{.seriesInfo}, March 2016,
    \<<https://www.rfc-editor.org/info/rfc7766>\>.
:   

\[RFC7830\]
:   [Mayrhofer, A.]{.refAuthor}, [\"The EDNS(0) Padding
    Option\"]{.refTitle}, [RFC 7830]{.seriesInfo}, [DOI
    10.17487/RFC7830]{.seriesInfo}, May 2016,
    \<<https://www.rfc-editor.org/info/rfc7830>\>.
:   

\[RFC7858\]
:   [Hu, Z.]{.refAuthor}, [Zhu, L.]{.refAuthor},
    [Heidemann, J.]{.refAuthor}, [Mankin, A.]{.refAuthor},
    [Wessels, D.]{.refAuthor}, and [P. Hoffman]{.refAuthor},
    [\"Specification for DNS over Transport Layer Security
    (TLS)\"]{.refTitle}, [RFC 7858]{.seriesInfo}, [DOI
    10.17487/RFC7858]{.seriesInfo}, May 2016,
    \<<https://www.rfc-editor.org/info/rfc7858>\>.
:   

\[RFC8126\]
:   [Cotton, M.]{.refAuthor}, [Leiba, B.]{.refAuthor}, and [T.
    Narten]{.refAuthor}, [\"Guidelines for Writing an IANA
    Considerations Section in RFCs\"]{.refTitle}, [BCP 26]{.seriesInfo},
    [RFC 8126]{.seriesInfo}, [DOI 10.17487/RFC8126]{.seriesInfo}, June
    2017, \<<https://www.rfc-editor.org/info/rfc8126>\>.
:   

\[RFC8174\]
:   [Leiba, B.]{.refAuthor}, [\"Ambiguity of Uppercase vs Lowercase in
    RFC 2119 Key Words\"]{.refTitle}, [BCP 14]{.seriesInfo}, [RFC
    8174]{.seriesInfo}, [DOI 10.17487/RFC8174]{.seriesInfo}, May 2017,
    \<<https://www.rfc-editor.org/info/rfc8174>\>.
:   

\[RFC8310\]
:   [Dickinson, S.]{.refAuthor}, [Gillmor, D.]{.refAuthor}, and [T.
    Reddy]{.refAuthor}, [\"Usage Profiles for DNS over TLS and DNS over
    DTLS\"]{.refTitle}, [RFC 8310]{.seriesInfo}, [DOI
    10.17487/RFC8310]{.seriesInfo}, March 2018,
    \<<https://www.rfc-editor.org/info/rfc8310>\>.
:   

\[RFC8446\]
:   [Rescorla, E.]{.refAuthor}, [\"The Transport Layer Security (TLS)
    Protocol Version 1.3\"]{.refTitle}, [RFC 8446]{.seriesInfo}, [DOI
    10.17487/RFC8446]{.seriesInfo}, August 2018,
    \<<https://www.rfc-editor.org/info/rfc8446>\>.
:   

\[RFC8467\]
:   [Mayrhofer, A.]{.refAuthor}, [\"Padding Policies for Extension
    Mechanisms for DNS (EDNS(0))\"]{.refTitle}, [RFC 8467]{.seriesInfo},
    [DOI 10.17487/RFC8467]{.seriesInfo}, October 2018,
    \<<https://www.rfc-editor.org/info/rfc8467>\>.
:   

\[RFC8914\]
:   [Kumari, W.]{.refAuthor}, [Hunt, E.]{.refAuthor},
    [Arends, R.]{.refAuthor}, [Hardaker, W.]{.refAuthor}, and [D.
    Lawrence]{.refAuthor}, [\"Extended DNS Errors\"]{.refTitle}, [RFC
    8914]{.seriesInfo}, [DOI 10.17487/RFC8914]{.seriesInfo}, October
    2020, \<<https://www.rfc-editor.org/info/rfc8914>\>.
:   

\[RFC9000\]
:   [Iyengar, J., Ed.]{.refAuthor} and [M. Thomson, Ed.]{.refAuthor},
    [\"QUIC: A UDP-Based Multiplexed and Secure Transport\"]{.refTitle},
    [RFC 9000]{.seriesInfo}, [DOI 10.17487/RFC9000]{.seriesInfo}, May
    2021, \<<https://www.rfc-editor.org/info/rfc9000>\>.
:   

\[RFC9001\]
:   [Thomson, M., Ed.]{.refAuthor} and [S. Turner, Ed.]{.refAuthor},
    [\"Using TLS to Secure QUIC\"]{.refTitle}, [RFC 9001]{.seriesInfo},
    [DOI 10.17487/RFC9001]{.seriesInfo}, May 2021,
    \<<https://www.rfc-editor.org/info/rfc9001>\>.
:   

\[RFC9103\]
:   [Toorop, W.]{.refAuthor}, [Dickinson, S.]{.refAuthor},
    [Sahib, S.]{.refAuthor}, [Aras, P.]{.refAuthor}, and [A.
    Mankin]{.refAuthor}, [\"DNS Zone Transfer over TLS\"]{.refTitle},
    [RFC 9103]{.seriesInfo}, [DOI 10.17487/RFC9103]{.seriesInfo}, August
    2021, \<<https://www.rfc-editor.org/info/rfc9103>\>.
:   
:::

::: {#section-9.2 .section}
### [9.2.](#section-9.2){.section-number .selfRef} [Informative References](#name-informative-references){.section-name .selfRef} {#name-informative-references}

\[BCP195\]

:   ::: {#RFC7525 .refInstance}
    [Sheffer, Y.]{.refAuthor}, [Holz, R.]{.refAuthor}, and [P.
    Saint-Andre]{.refAuthor}, [\"Recommendations for Secure Use of
    Transport Layer Security (TLS) and Datagram Transport Layer Security
    (DTLS)\"]{.refTitle}, [BCP 195]{.seriesInfo}, [RFC
    7525]{.seriesInfo}, May 2015.
    :::

    ::: {#RFC8996 .refInstance}
    [Moriarty, K.]{.refAuthor} and [S. Farrell]{.refAuthor},
    [\"Deprecating TLS 1.0 and TLS 1.1\"]{.refTitle}, [BCP
    195]{.seriesInfo}, [RFC 8996]{.seriesInfo}, March 2021.
    :::

    \<<https://www.rfc-editor.org/info/bcp195>\>

:   

\[DNS-TERMS\]
:   [Hoffman, P.]{.refAuthor} and [K. Fujiwara]{.refAuthor}, [\"DNS
    Terminology\"]{.refTitle}, [Work in Progress]{.refContent},
    [Internet-Draft, draft-ietf-dnsop-rfc8499bis-03]{.seriesInfo}, 28
    September 2021,
    \<<https://datatracker.ietf.org/doc/html/draft-ietf-dnsop-rfc8499bis-03>\>.
:   

\[DNS0RTT\]
:   [Kahn Gillmor, D.]{.refAuthor}, [\"DNS + 0-RTT\"]{.refTitle},
    [Message to DNS-Privacy WG mailing list]{.seriesInfo}, 6 April 2016,
    \<<https://www.ietf.org/mail-archive/web/dns-privacy/current/msg01276.html>\>.
:   

\[GREASING-QUIC\]
:   [Thomson, M.]{.refAuthor}, [\"Greasing the QUIC Bit\"]{.refTitle},
    [Work in Progress]{.refContent}, [Internet-Draft,
    draft-ietf-quic-bit-grease-02]{.seriesInfo}, 10 November 2021,
    \<<https://datatracker.ietf.org/doc/html/draft-ietf-quic-bit-grease-02>\>.
:   

\[HTTP/3\]
:   [Bishop, M., Ed.]{.refAuthor}, [\"Hypertext Transfer Protocol
    Version 3 (HTTP/3)\"]{.refTitle}, [Work in Progress]{.refContent},
    [Internet-Draft, draft-ietf-quic-http-34]{.seriesInfo}, 2 February
    2021,
    \<<https://datatracker.ietf.org/doc/html/draft-ietf-quic-http-34>\>.
:   

\[RFC1996\]
:   [Vixie, P.]{.refAuthor}, [\"A Mechanism for Prompt Notification of
    Zone Changes (DNS NOTIFY)\"]{.refTitle}, [RFC 1996]{.seriesInfo},
    [DOI 10.17487/RFC1996]{.seriesInfo}, August 1996,
    \<<https://www.rfc-editor.org/info/rfc1996>\>.
:   

\[RFC3833\]
:   [Atkins, D.]{.refAuthor} and [R. Austein]{.refAuthor}, [\"Threat
    Analysis of the Domain Name System (DNS)\"]{.refTitle}, [RFC
    3833]{.seriesInfo}, [DOI 10.17487/RFC3833]{.seriesInfo}, August
    2004, \<<https://www.rfc-editor.org/info/rfc3833>\>.
:   

\[RFC6335\]
:   [Cotton, M.]{.refAuthor}, [Eggert, L.]{.refAuthor},
    [Touch, J.]{.refAuthor}, [Westerlund, M.]{.refAuthor}, and [S.
    Cheshire]{.refAuthor}, [\"Internet Assigned Numbers Authority (IANA)
    Procedures for the Management of the Service Name and Transport
    Protocol Port Number Registry\"]{.refTitle}, [BCP 165]{.seriesInfo},
    [RFC 6335]{.seriesInfo}, [DOI 10.17487/RFC6335]{.seriesInfo}, August
    2011, \<<https://www.rfc-editor.org/info/rfc6335>\>.
:   

\[RFC7828\]
:   [Wouters, P.]{.refAuthor}, [Abley, J.]{.refAuthor},
    [Dickinson, S.]{.refAuthor}, and [R. Bellis]{.refAuthor}, [\"The
    edns-tcp-keepalive EDNS0 Option\"]{.refTitle}, [RFC
    7828]{.seriesInfo}, [DOI 10.17487/RFC7828]{.seriesInfo}, April 2016,
    \<<https://www.rfc-editor.org/info/rfc7828>\>.
:   

\[RFC7873\]
:   [Eastlake 3rd, D.]{.refAuthor} and [M. Andrews]{.refAuthor},
    [\"Domain Name System (DNS) Cookies\"]{.refTitle}, [RFC
    7873]{.seriesInfo}, [DOI 10.17487/RFC7873]{.seriesInfo}, May 2016,
    \<<https://www.rfc-editor.org/info/rfc7873>\>.
:   

\[RFC8094\]
:   [Reddy, T.]{.refAuthor}, [Wing, D.]{.refAuthor}, and [P.
    Patil]{.refAuthor}, [\"DNS over Datagram Transport Layer Security
    (DTLS)\"]{.refTitle}, [RFC 8094]{.seriesInfo}, [DOI
    10.17487/RFC8094]{.seriesInfo}, February 2017,
    \<<https://www.rfc-editor.org/info/rfc8094>\>.
:   

\[RFC8484\]
:   [Hoffman, P.]{.refAuthor} and [P. McManus]{.refAuthor}, [\"DNS
    Queries over HTTPS (DoH)\"]{.refTitle}, [RFC 8484]{.seriesInfo},
    [DOI 10.17487/RFC8484]{.seriesInfo}, October 2018,
    \<<https://www.rfc-editor.org/info/rfc8484>\>.
:   

\[RFC8490\]
:   [Bellis, R.]{.refAuthor}, [Cheshire, S.]{.refAuthor},
    [Dickinson, J.]{.refAuthor}, [Dickinson, S.]{.refAuthor},
    [Lemon, T.]{.refAuthor}, and [T. Pusateri]{.refAuthor}, [\"DNS
    Stateful Operations\"]{.refTitle}, [RFC 8490]{.seriesInfo}, [DOI
    10.17487/RFC8490]{.seriesInfo}, March 2019,
    \<<https://www.rfc-editor.org/info/rfc8490>\>.
:   

\[RFC8932\]
:   [Dickinson, S.]{.refAuthor}, [Overeinder, B.]{.refAuthor}, [van
    Rijswijk-Deij, R.]{.refAuthor}, and [A. Mankin]{.refAuthor},
    [\"Recommendations for DNS Privacy Service Operators\"]{.refTitle},
    [BCP 232]{.seriesInfo}, [RFC 8932]{.seriesInfo}, [DOI
    10.17487/RFC8932]{.seriesInfo}, October 2020,
    \<<https://www.rfc-editor.org/info/rfc8932>\>.
:   

\[RFC9002\]
:   [Iyengar, J., Ed.]{.refAuthor} and [I. Swett, Ed.]{.refAuthor},
    [\"QUIC Loss Detection and Congestion Control\"]{.refTitle}, [RFC
    9002]{.seriesInfo}, [DOI 10.17487/RFC9002]{.seriesInfo}, May 2021,
    \<<https://www.rfc-editor.org/info/rfc9002>\>.
:   

\[RFC9076\]
:   [Wicinski, T., Ed.]{.refAuthor}, [\"DNS Privacy
    Considerations\"]{.refTitle}, [RFC 9076]{.seriesInfo}, [DOI
    10.17487/RFC9076]{.seriesInfo}, July 2021,
    \<<https://www.rfc-editor.org/info/rfc9076>\>.
:   
:::
:::

::: {#the-notify-service}
::: {#appendix-A .section}
## [Appendix A.](#appendix-A){.section-number .selfRef} [The NOTIFY Service](#name-the-notify-service){.section-name .selfRef} {#name-the-notify-service}

This appendix discusses why it is considered acceptable to send NOTIFY
(see \[[RFC1996](#RFC1996){.xref}\]) in 0-RTT
data.[¶](#appendix-A-1){.pilcrow}

[Section 4.5](#session-resumption-and-0-rtt){.xref} says \"The 0-RTT
mechanism [MUST NOT]{.bcp14} be used to send DNS requests that are not
\"replayable\" transactions\". This specification supports sending a
NOTIFY in 0-RTT data because although a NOTIFY technically changes the
state of the receiving server, the effect of replaying NOTIFYs has
negligible impact in practice.[¶](#appendix-A-2){.pilcrow}

NOTIFY messages prompt a secondary to either send an SOA query or an XFR
request to the primary on the basis that a newer version of the zone is
available. It has long been recognized that NOTIFYs can be forged and,
in theory, used to cause a secondary to send repeated unnecessary
requests to the primary. For this reason, most implementations have some
form of throttling of the SOA/XFR queries triggered by the receipt of
one or more NOTIFYs.[¶](#appendix-A-3){.pilcrow}

\[[RFC9103](#RFC9103){.xref}\] describes the privacy risks associated
with both NOTIFY and SOA queries and does not include addressing those
risks within the scope of encrypting zone transfers. Given this, the
privacy benefit of using DoQ for NOTIFY is not clear, but for the same
reason, sending NOTIFY as 0-RTT data has no privacy risk above that of
sending it using cleartext DNS.[¶](#appendix-A-4){.pilcrow}
:::
:::

::: {#acknowledgements}
::: {#appendix-B .section}
## [Acknowledgements](#name-acknowledgements){.section-name .selfRef} {#name-acknowledgements}

This document liberally borrows text from the HTTP/3 specification
\[[HTTP/3](#I-D.ietf-quic-http){.xref}\] edited by [Mike
Bishop]{.contact-name} and from the DoT specification
\[[RFC7858](#RFC7858){.xref}\] authored by [Zi Hu]{.contact-name},
[Liang Zhu]{.contact-name}, [John Heidemann]{.contact-name}, [Allison
Mankin]{.contact-name}, [Duane Wessels]{.contact-name}, and [Paul
Hoffman]{.contact-name}.[¶](#appendix-B-1){.pilcrow}

The privacy issue with 0-RTT data and session resumption was analyzed by
[Daniel Kahn Gillmor]{.contact-name} (DKG) in a message to the IETF
DPRIVE Working Group
\[[DNS0RTT](#DNS0RTT){.xref}\].[¶](#appendix-B-2){.pilcrow}

Thanks to [Tony Finch]{.contact-name} for an extensive review of the
initial draft version of this document, and to [Robert
Evans]{.contact-name} for the discussion of 0-RTT privacy issues. Early
reviews by [Paul Hoffman]{.contact-name} and [Martin
Thomson]{.contact-name} and interoperability tests conducted by Stephane
Bortzmeyer helped improve the definition of the
protocol.[¶](#appendix-B-3){.pilcrow}

Thanks also to [Martin Thomson]{.contact-name} and [Martin
Duke]{.contact-name} for their later reviews focusing on the low-level
QUIC details, which helped clarify several aspects of DoQ. Thanks to
[Andrey Meshkov]{.contact-name}, [Loganaden Velvindron]{.contact-name},
[Lucas Pardue]{.contact-name}, [Matt Joras]{.contact-name}, [Mirja
Kuelewind]{.contact-name}, [Brian Trammell]{.contact-name}, and [Phillip
Hallam-Baker]{.contact-name} for their reviews and
contributions.[¶](#appendix-B-4){.pilcrow}
:::
:::

::: {#authors-addresses}
::: {#appendix-C .section}
## [Authors\' Addresses](#name-authors-addresses){.section-name .selfRef} {#name-authors-addresses}

::: {.left dir="auto"}
[Christian Huitema]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Private Octopus Inc.]{.org}
:::

::: {.left dir="auto"}
[427 Golfcourse Rd]{.street-address}
:::

::: {.left dir="auto"}
[Friday Harbor]{.locality}, [WA 98250]{.postal-code}
:::

::: {.left dir="auto"}
[United States of America]{.country-name}
:::

::: email
Email: <huitema@huitema.net>
:::

::: {.left dir="auto"}
[Sara Dickinson]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Sinodun IT]{.org}
:::

::: {.left dir="auto"}
[Oxford Science Park]{.street-address}
:::

::: {.left dir="auto"}
[Oxford]{.locality}
:::

::: {.left dir="auto"}
[OX4 4GA]{.postal-code}
:::

::: {.left dir="auto"}
[United Kingdom]{.country-name}
:::

::: email
Email: <sara@sinodun.com>
:::

::: {.left dir="auto"}
[Allison Mankin]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Salesforce]{.org}
:::

::: email
Email: <allison.mankin@gmail.com>
:::
:::
:::
