  RFC 8956        IPv6 Flow Specification   December 2020
  --------------- ------------------------- ---------------
  Loibl, et al.   Standards Track           \[Page\]

::: {#external-metadata .document-information}
:::

::: {#internal-metadata .document-information}

Stream:
:   Internet Engineering Task Force (IETF)

RFC:
:   [8956](https://www.rfc-editor.org/rfc/rfc8956){.eref}

Updates:
:   [8955](https://www.rfc-editor.org/rfc/rfc8955){.eref}

Category:
:   Standards Track

Published:
:   December 2020

ISSN:
:   2070-1721

Authors:

:   ::: author
    ::: author-name
    C. Loibl, [Ed.]{.editor}
    :::

    ::: org
    next layer Telekom GmbH
    :::
    :::

    ::: author
    ::: author-name
    R. Raszuk, [Ed.]{.editor}
    :::

    ::: org
    NTT Network Innovations
    :::
    :::

    ::: author
    ::: author-name
    S. Hares, [Ed.]{.editor}
    :::

    ::: org
    Huawei
    :::
    :::
:::

# RFC 8956 {#rfcnum}

# Dissemination of Flow Specification Rules for IPv6 {#title}

::: {#section-abstract .section}
## [Abstract](#abstract){.selfRef}

\"Dissemination of Flow Specification Rules\" (RFC 8955) provides a
Border Gateway Protocol (BGP) extension for the propagation of traffic
flow information for the purpose of rate limiting or filtering IPv4
protocol data packets.[¶](#section-abstract-1){.pilcrow}

This document extends RFC 8955 with IPv6 functionality. It also updates
RFC 8955 by changing the IANA Flow Spec Component Types
registry.[¶](#section-abstract-2){.pilcrow}
:::

::: {#status-of-memo}
::: {#section-boilerplate.1 .section}
## [Status of This Memo](#name-status-of-this-memo){.section-name .selfRef} {#name-status-of-this-memo}

This is an Internet Standards Track
document.[¶](#section-boilerplate.1-1){.pilcrow}

This document is a product of the Internet Engineering Task Force
(IETF). It represents the consensus of the IETF community. It has
received public review and has been approved for publication by the
Internet Engineering Steering Group (IESG). Further information on
Internet Standards is available in Section 2 of RFC
7841.[¶](#section-boilerplate.1-2){.pilcrow}

Information about the current status of this document, any errata, and
how to provide feedback on it may be obtained at
<https://www.rfc-editor.org/info/rfc8956>.[¶](#section-boilerplate.1-3){.pilcrow}
:::
:::

::: {#copyright}
::: {#section-boilerplate.2 .section}
## [Copyright Notice](#name-copyright-notice){.section-name .selfRef} {#name-copyright-notice}

Copyright (c) 2020 IETF Trust and the persons identified as the document
authors. All rights reserved.[¶](#section-boilerplate.2-1){.pilcrow}

This document is subject to BCP 78 and the IETF Trust\'s Legal
Provisions Relating to IETF Documents
(<https://trustee.ietf.org/license-info>) in effect on the date of
publication of this document. Please review these documents carefully,
as they describe your rights and restrictions with respect to this
document. Code Components extracted from this document must include
Simplified BSD License text as described in Section 4.e of the Trust
Legal Provisions and are provided without warranty as described in the
Simplified BSD License.[¶](#section-boilerplate.2-2){.pilcrow}
:::
:::

::: {#toc}
::: {#section-toc.1 .section}
[▲](#){.toplink}

## [Table of Contents](#name-table-of-contents){.section-name .selfRef} {#name-table-of-contents}

-   ::: {#section-toc.1-1.1}
    [1](#section-1){.xref}.  [Introduction](#name-introduction){.xref}[¶](#section-toc.1-1.1.1){.pilcrow}

    -   ::: {#section-toc.1-1.1.2.1}
        [1.1](#section-1.1){.xref}.  [Definitions of Terms Used in This
        Memo](#name-definitions-of-terms-used-i){.xref}[¶](#section-toc.1-1.1.2.1.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.2}
    [2](#section-2){.xref}.  [IPv6 Flow Specification Encoding in
    BGP](#name-ipv6-flow-specification-enc){.xref}[¶](#section-toc.1-1.2.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.3}
    [3](#section-3){.xref}.  [IPv6 Flow Specification
    Components](#name-ipv6-flow-specification-com){.xref}[¶](#section-toc.1-1.3.1){.pilcrow}

    -   ::: {#section-toc.1-1.3.2.1}
        [3.1](#section-3.1){.xref}.  [Type 1 - Destination IPv6
        Prefix](#name-type-1-destination-ipv6-pre){.xref}[¶](#section-toc.1-1.3.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.2}
        [3.2](#section-3.2){.xref}.  [Type 2 - Source IPv6
        Prefix](#name-type-2-source-ipv6-prefix){.xref}[¶](#section-toc.1-1.3.2.2.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.3}
        [3.3](#section-3.3){.xref}.  [Type 3 - Upper-Layer
        Protocol](#name-type-3-upper-layer-protocol){.xref}[¶](#section-toc.1-1.3.2.3.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.4}
        [3.4](#section-3.4){.xref}.  [Type 7 - ICMPv6
        Type](#name-type-7-icmpv6-type){.xref}[¶](#section-toc.1-1.3.2.4.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.5}
        [3.5](#section-3.5){.xref}.  [Type 8 - ICMPv6
        Code](#name-type-8-icmpv6-code){.xref}[¶](#section-toc.1-1.3.2.5.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.6}
        [3.6](#section-3.6){.xref}.  [Type 12 -
        Fragment](#name-type-12-fragment){.xref}[¶](#section-toc.1-1.3.2.6.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.7}
        [3.7](#section-3.7){.xref}.  [Type 13 - Flow Label
        (new)](#name-type-13-flow-label-new){.xref}[¶](#section-toc.1-1.3.2.7.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.8}
        [3.8](#section-3.8){.xref}.  [Encoding
        Examples](#name-encoding-examples){.xref}[¶](#section-toc.1-1.3.2.8.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.4}
    [4](#section-4){.xref}.  [Ordering of Flow
    Specifications](#name-ordering-of-flow-specificat){.xref}[¶](#section-toc.1-1.4.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.5}
    [5](#section-5){.xref}.  [Validation
    Procedure](#name-validation-procedure){.xref}[¶](#section-toc.1-1.5.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.6}
    [6](#section-6){.xref}.  [IPv6 Traffic Filtering Action
    Changes](#name-ipv6-traffic-filtering-acti){.xref}[¶](#section-toc.1-1.6.1){.pilcrow}

    -   ::: {#section-toc.1-1.6.2.1}
        [6.1](#section-6.1){.xref}.  [Redirect IPv6 (rt-redirect-ipv6)
        Type
        0x000d](#name-redirect-ipv6-rt-redirect-i){.xref}[¶](#section-toc.1-1.6.2.1.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.7}
    [7](#section-7){.xref}.  [Security
    Considerations](#name-security-considerations){.xref}[¶](#section-toc.1-1.7.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.8}
    [8](#section-8){.xref}.  [IANA
    Considerations](#name-iana-considerations){.xref}[¶](#section-toc.1-1.8.1){.pilcrow}

    -   ::: {#section-toc.1-1.8.2.1}
        [8.1](#section-8.1){.xref}.  [Flow Spec IPv6 Component
        Types](#name-flow-spec-ipv6-component-ty){.xref}[¶](#section-toc.1-1.8.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.8.2.2}
        [8.2](#section-8.2){.xref}.  [IPv6-Address-Specific Extended
        Community Flow Spec IPv6
        Actions](#name-ipv6-address-specific-exten){.xref}[¶](#section-toc.1-1.8.2.2.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.9}
    [9](#section-9){.xref}.  [Normative
    References](#name-normative-references){.xref}[¶](#section-toc.1-1.9.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.10}
    [Appendix A](#section-appendix.a){.xref}.  [Example Python Code:
    flow_rule_cmp_v6](#name-example-python-code-flow_ru){.xref}[¶](#section-toc.1-1.10.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.11}
    [](#section-appendix.b){.xref}[Acknowledgments](#name-acknowledgments){.xref}[¶](#section-toc.1-1.11.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.12}
    [](#section-appendix.c){.xref}[Contributors](#name-contributors){.xref}[¶](#section-toc.1-1.12.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.13}
    [](#section-appendix.d){.xref}[Authors\'
    Addresses](#name-authors-addresses){.xref}[¶](#section-toc.1-1.13.1){.pilcrow}
    :::
:::
:::

::: {#intro}
::: {#section-1 .section}
## [1.](#section-1){.section-number .selfRef} [Introduction](#name-introduction){.section-name .selfRef} {#name-introduction}

The growing amount of IPv6 traffic in private and public networks
requires the extension of tools used in IPv4-only networks to also
support IPv6 data packets.[¶](#section-1-1){.pilcrow}

This document analyzes the differences between describing IPv6
\[[RFC8200](#RFC8200){.xref}\] flows and those of IPv4 packets. It
specifies new Border Gateway Protocol \[[RFC4271](#RFC4271){.xref}\]
encoding formats to enable \"Dissemination of Flow Specification Rules\"
\[[RFC8955](#RFC8955){.xref}\] for IPv6.[¶](#section-1-2){.pilcrow}

This specification is an extension of the base established in
\[[RFC8955](#RFC8955){.xref}\]. It only defines the delta changes
required to support IPv6, while all other definitions and operation
mechanisms of \"Dissemination of Flow Specification Rules\" will remain
in the main specification and will not be repeated
here.[¶](#section-1-3){.pilcrow}

::: {#section-1.1 .section}
### [1.1.](#section-1.1){.section-number .selfRef} [Definitions of Terms Used in This Memo](#name-definitions-of-terms-used-i){.section-name .selfRef} {#name-definitions-of-terms-used-i}

[]{.break}

AFI:
:   Address Family Identifier[¶](#section-1.1-1.2){.pilcrow}
:   

AS:
:   Autonomous System[¶](#section-1.1-1.4){.pilcrow}
:   

NLRI:
:   Network Layer Reachability
    Information[¶](#section-1.1-1.6){.pilcrow}
:   

SAFI:
:   Subsequent Address Family Identifier[¶](#section-1.1-1.8){.pilcrow}
:   

VRF:
:   Virtual Routing and Forwarding[¶](#section-1.1-1.10){.pilcrow}
:   

The key words \"[MUST]{.bcp14}\", \"[MUST NOT]{.bcp14}\",
\"[REQUIRED]{.bcp14}\", \"[SHALL]{.bcp14}\", \"[SHALL NOT]{.bcp14}\",
\"[SHOULD]{.bcp14}\", \"[SHOULD NOT]{.bcp14}\",
\"[RECOMMENDED]{.bcp14}\", \"[NOT RECOMMENDED]{.bcp14}\",
\"[MAY]{.bcp14}\", and \"[OPTIONAL]{.bcp14}\" in this document are to be
interpreted as described in BCP 14 \[[RFC2119](#RFC2119){.xref}\]
\[[RFC8174](#RFC8174){.xref}\] when, and only when, they appear in all
capitals, as shown here.[¶](#section-1.1-2){.pilcrow}
:::
:::
:::

::: {#section-2 .section}
## [2.](#section-2){.section-number .selfRef} [IPv6 Flow Specification Encoding in BGP](#name-ipv6-flow-specification-enc){.section-name .selfRef} {#name-ipv6-flow-specification-enc}

\[[RFC8955](#RFC8955){.xref}\] defines SAFIs 133 (Dissemination of Flow
Specification rules) and 134 (L3VPN Dissemination of Flow Specification
rules) in order to carry the corresponding Flow
Specification.[¶](#section-2-1){.pilcrow}

Implementations wishing to exchange IPv6 Flow Specifications
[MUST]{.bcp14} use BGP\'s Capability Advertisement facility to exchange
the Multiprotocol Extension Capability Code (Code 1), as defined in
\[[RFC4760](#RFC4760){.xref}\]. The (AFI, SAFI) pair carried in the
Multiprotocol Extension Capability [MUST]{.bcp14} be (AFI=2, SAFI=133)
for IPv6 Flow Specification rules and (AFI=2, SAFI=134) for L3VPN
Dissemination of Flow Specification rules.[¶](#section-2-2){.pilcrow}
:::

::: {#section-3 .section}
## [3.](#section-3){.section-number .selfRef} [IPv6 Flow Specification Components](#name-ipv6-flow-specification-com){.section-name .selfRef} {#name-ipv6-flow-specification-com}

The encoding of each of the components begins with a Type field (1
octet) followed by a variable length parameter. The following sections
define component types and parameter encodings for
IPv6.[¶](#section-3-1){.pilcrow}

Types 4 (Port), 5 (Destination Port), 6 (Source Port), 9 (TCP Flags), 10
(Packet Length), and 11 (DSCP), as defined in
\[[RFC8955](#RFC8955){.xref}\], also apply to IPv6. Note that IANA has
updated the \"Flow Spec Component Types\" registry in order to contain
both IPv4 and IPv6 Flow Specification component type numbers in a single
registry ([Section 8](#IANA){.xref}).[¶](#section-3-2){.pilcrow}

::: {#type_1}
::: {#section-3.1 .section}
### [3.1.](#section-3.1){.section-number .selfRef} [Type 1 - Destination IPv6 Prefix](#name-type-1-destination-ipv6-pre){.section-name .selfRef} {#name-type-1-destination-ipv6-pre}

[]{.break}

Encoding:
:   \<type (1 octet), length (1 octet), offset (1 octet), pattern
    (variable), padding (variable) >[¶](#section-3.1-1.2){.pilcrow}
:   

This defines the destination prefix to match. The offset has been
defined to allow for flexible matching to portions of an IPv6 address
where one is required to skip over the first N bits of the address.
(These bits skipped are often indicated as \"don\'t care\" bits.) This
can be especially useful where part of the IPv6 address consists of an
embedded IPv4 address, and matching needs to happen only on the embedded
IPv4 address. The encoded pattern contains enough octets for the bits
used in matching (length minus offset
bits).[¶](#section-3.1-2){.pilcrow}

[]{.break}

length:
:   This indicates the N-th most significant bit in the address where
    bitwise pattern matching stops.[¶](#section-3.1-3.2){.pilcrow}
:   

offset:
:   This indicates the number of most significant address bits to skip
    before bitwise pattern matching
    starts.[¶](#section-3.1-3.4){.pilcrow}
:   

pattern:
:   This contains the matching pattern. The length of the pattern is
    defined by the number of bits needed for pattern matching (length
    minus offset).[¶](#section-3.1-3.6){.pilcrow}
:   

padding:
:   This contains the minimum number of bits required to pad the
    component to an octet boundary. Padding bits [MUST]{.bcp14} be 0 on
    encoding and [MUST]{.bcp14} be ignored on
    decoding.[¶](#section-3.1-3.8){.pilcrow}
:   

If length = 0 and offset = 0, this component matches every address;
otherwise, length [MUST]{.bcp14} be in the range offset \< length \< 129
or the component is malformed.[¶](#section-3.1-4){.pilcrow}

Note: This Flow Specification component can be represented by the
notation ipv6address/length if offset is 0 or ipv6address/offset-length.
The ipv6address in this notation is the textual IPv6 representation of
the pattern shifted to the right by the number of offset bits. See also
[Section 3.8](#examples){.xref}.[¶](#section-3.1-5){.pilcrow}
:::
:::

::: {#type_2}
::: {#section-3.2 .section}
### [3.2.](#section-3.2){.section-number .selfRef} [Type 2 - Source IPv6 Prefix](#name-type-2-source-ipv6-prefix){.section-name .selfRef} {#name-type-2-source-ipv6-prefix}

[]{.break}

Encoding:
:   \<type (1 octet), length (1 octet), offset (1 octet), pattern
    (variable), padding (variable) >[¶](#section-3.2-1.2){.pilcrow}
:   

This defines the source prefix to match. The length, offset, pattern,
and padding are the same as in [Section
3.1](#type_1){.xref}.[¶](#section-3.2-2){.pilcrow}
:::
:::

::: {#type_3}
::: {#section-3.3 .section}
### [3.3.](#section-3.3){.section-number .selfRef} [Type 3 - Upper-Layer Protocol](#name-type-3-upper-layer-protocol){.section-name .selfRef} {#name-type-3-upper-layer-protocol}

[]{.break}

Encoding:
:   \<type (1 octet), \[numeric_op,
    value\]+>[¶](#section-3.3-1.2){.pilcrow}
:   

This contains a list of {numeric_op, value} pairs that are used to match
the first Next Header value octet in IPv6 packets that is not an
extension header and thus indicates that the next item in the packet is
the corresponding upper-layer header (see [Section
4](https://www.rfc-editor.org/rfc/rfc8200#section-4){.relref} of
\[[RFC8200](#RFC8200){.xref}\]).[¶](#section-3.3-2){.pilcrow}

This component uses the Numeric Operator (numeric_op) described in
[Section
4.2.1.1](https://www.rfc-editor.org/rfc/rfc8955#section-4.2.1.1){.relref}
of \[[RFC8955](#RFC8955){.xref}\]. Type 3 component values
[SHOULD]{.bcp14} be encoded as a single octet (numeric_op
len=00).[¶](#section-3.3-3){.pilcrow}

Note: While IPv6 allows for more than one Next Header field in the
packet, the main goal of the Type 3 Flow Specification component is to
match on the first upper-layer IP protocol value. Therefore, the
definition is limited to match only on this specific Next Header field
in the packet.[¶](#section-3.3-4){.pilcrow}
:::
:::

::: {#type_7}
::: {#section-3.4 .section}
### [3.4.](#section-3.4){.section-number .selfRef} [Type 7 - ICMPv6 Type](#name-type-7-icmpv6-type){.section-name .selfRef} {#name-type-7-icmpv6-type}

[]{.break}

Encoding:
:   \<type (1 octet), \[numeric_op,
    value\]+>[¶](#section-3.4-1.2){.pilcrow}
:   

This defines a list of {numeric_op, value} pairs used to match the Type
field of an ICMPv6 packet (see also [Section
2.1](https://www.rfc-editor.org/rfc/rfc4443#section-2.1){.relref} of
\[[RFC4443](#RFC4443){.xref}\]).[¶](#section-3.4-2){.pilcrow}

This component uses the Numeric Operator (numeric_op) described in
[Section
4.2.1.1](https://www.rfc-editor.org/rfc/rfc8955#section-4.2.1.1){.relref}
of \[[RFC8955](#RFC8955){.xref}\]. Type 7 component values
[SHOULD]{.bcp14} be encoded as a single octet (numeric_op
len=00).[¶](#section-3.4-3){.pilcrow}

In case of the presence of the ICMPv6 type component, only ICMPv6
packets can match the entire Flow Specification. The ICMPv6 type
component, if present, never matches when the packet\'s upper-layer IP
protocol value is not 58 (ICMPv6), if the packet is fragmented and this
is not the first fragment, or if the system is unable to locate the
transport header. Different implementations may or may not be able to
decode the transport header.[¶](#section-3.4-4){.pilcrow}
:::
:::

::: {#type_8}
::: {#section-3.5 .section}
### [3.5.](#section-3.5){.section-number .selfRef} [Type 8 - ICMPv6 Code](#name-type-8-icmpv6-code){.section-name .selfRef} {#name-type-8-icmpv6-code}

[]{.break}

Encoding:
:   \<type (1 octet), \[numeric_op,
    value\]+>[¶](#section-3.5-1.2){.pilcrow}
:   

This defines a list of {numeric_op, value} pairs used to match the code
field of an ICMPv6 packet (see also [Section
2.1](https://www.rfc-editor.org/rfc/rfc4443#section-2.1){.relref} of
\[[RFC4443](#RFC4443){.xref}\]).[¶](#section-3.5-2){.pilcrow}

This component uses the Numeric Operator (numeric_op) described in
[Section
4.2.1.1](https://www.rfc-editor.org/rfc/rfc8955#section-4.2.1.1){.relref}
of \[[RFC8955](#RFC8955){.xref}\]. Type 8 component values
[SHOULD]{.bcp14} be encoded as a single octet (numeric_op
len=00).[¶](#section-3.5-3){.pilcrow}

In case of the presence of the ICMPv6 code component, only ICMPv6
packets can match the entire Flow Specification. The ICMPv6 code
component, if present, never matches when the packet\'s upper-layer IP
protocol value is not 58 (ICMPv6), if the packet is fragmented and this
is not the first fragment, or if the system is unable to locate the
transport header. Different implementations may or may not be able to
decode the transport header.[¶](#section-3.5-4){.pilcrow}
:::
:::

::: {#type_12}
::: {#section-3.6 .section}
### [3.6.](#section-3.6){.section-number .selfRef} [Type 12 - Fragment](#name-type-12-fragment){.section-name .selfRef} {#name-type-12-fragment}

[]{.break}

Encoding:
:   \<type (1 octet), \[bitmask_op,
    bitmask\]+>[¶](#section-3.6-1.2){.pilcrow}
:   

This defines a list of {bitmask_op, bitmask} pairs used to match
specific IP fragments.[¶](#section-3.6-2){.pilcrow}

This component uses the Bitmask Operator (bitmask_op) described in
[Section
4.2.1.2](https://www.rfc-editor.org/rfc/rfc8955#section-4.2.1.2){.relref}
of \[[RFC8955](#RFC8955){.xref}\]. The Type 12 component bitmask
[MUST]{.bcp14} be encoded as a single octet bitmask (bitmask_op
len=00).[¶](#section-3.6-3){.pilcrow}

[]{#name-fragment-bitmask-operand}

::: {#figure_fragment_bitmask_operand}
::: {#section-3.6-4.1 .artwork .art-text .alignLeft}
                       0   1   2   3   4   5   6   7
                     +---+---+---+---+---+---+---+---+
                     | 0 | 0 | 0 | 0 |LF |FF |IsF| 0 |
                     +---+---+---+---+---+---+---+---+
:::

[Figure 1](#figure-1){.selfRef}: [Fragment Bitmask
Operand](#name-fragment-bitmask-operand){.selfRef}
:::

Bitmask values:[¶](#section-3.6-5){.pilcrow}

[]{.break}

IsF:
:   Is a fragment other than the first \-- match if IPv6 Fragment Header
    ([Section
    4.5](https://www.rfc-editor.org/rfc/rfc8200#section-4.5){.relref} of
    \[[RFC8200](#RFC8200){.xref}\]) Fragment Offset is not
    0[¶](#section-3.6-6.2){.pilcrow}
:   

FF:
:   First fragment \-- match if IPv6 Fragment Header ([Section
    4.5](https://www.rfc-editor.org/rfc/rfc8200#section-4.5){.relref} of
    \[[RFC8200](#RFC8200){.xref}\]) Fragment Offset is 0 AND M flag is
    1[¶](#section-3.6-6.4){.pilcrow}
:   

LF:
:   Last fragment \-- match if IPv6 Fragment Header ([Section
    4.5](https://www.rfc-editor.org/rfc/rfc8200#section-4.5){.relref} of
    \[[RFC8200](#RFC8200){.xref}\]) Fragment Offset is not 0 AND M flag
    is 0[¶](#section-3.6-6.6){.pilcrow}
:   

0:
:   [MUST]{.bcp14} be set to 0 on NLRI encoding and [MUST]{.bcp14} be
    ignored during decoding[¶](#section-3.6-6.8){.pilcrow}
:   
:::
:::

::: {#type_13}
::: {#section-3.7 .section}
### [3.7.](#section-3.7){.section-number .selfRef} [Type 13 - Flow Label (new)](#name-type-13-flow-label-new){.section-name .selfRef} {#name-type-13-flow-label-new}

[]{.break}

Encoding:
:   \<type (1 octet), \[numeric_op,
    value\]+>[¶](#section-3.7-1.2){.pilcrow}
:   

This contains a list of {numeric_op, value} pairs that are used to match
the 20-bit Flow Label IPv6 header field ([Section
3](https://www.rfc-editor.org/rfc/rfc8200#section-3){.relref} of
\[[RFC8200](#RFC8200){.xref}\]).[¶](#section-3.7-2){.pilcrow}

This component uses the Numeric Operator (numeric_op) described in
[Section
4.2.1.1](https://www.rfc-editor.org/rfc/rfc8955#section-4.2.1.1){.relref}
of \[[RFC8955](#RFC8955){.xref}\]. Type 13 component values
[SHOULD]{.bcp14} be encoded as 4-octet quantities (numeric_op
len=10).[¶](#section-3.7-3){.pilcrow}
:::
:::

::: {#examples}
::: {#section-3.8 .section}
### [3.8.](#section-3.8){.section-number .selfRef} [Encoding Examples](#name-encoding-examples){.section-name .selfRef} {#name-encoding-examples}

::: {#section-3.8.1 .section}
#### [3.8.1.](#section-3.8.1){.section-number .selfRef} [Example 1](#name-example-1){.section-name .selfRef} {#name-example-1}

The following example demonstrates the prefix encoding for packets from
::1234:5678:9a00:0/64-104 to 2001:db8::/32 and upper-layer protocol
tcp.[¶](#section-3.8.1-1){.pilcrow}

::: {#example-1}
  len    destination            source                    ul-proto
  ------ ---------------------- ------------------------- ----------
  0x12   01 20 00 20 01 0d bb   02 68 40 12 34 56 78 9a   03 81 06

  : [Table 1](#table-1){.selfRef}
:::

Decoded:[¶](#section-3.8.1-3){.pilcrow}

::: {#example-1-decoded}
  Value                
  ------- ------------ ----------------------------------
  0x12    length       18 octets (if len\<240, 1 octet)
  0x01    type         Type 1 - Dest. IPv6 Prefix
  0x20    length       32 bits
  0x00    offset       0 bits
  0x20    pattern      
  0x01    pattern      
  0x0d    pattern      
  0xb8    pattern      (no padding needed)
  0x02    type         Type 2 - Source IPv6 Prefix
  0x68    length       104 bits
  0x40    offset       64 bits
  0x12    pattern      
  0x34    pattern      
  0x56    pattern      
  0x78    pattern      
  0x9a    pattern      (no padding needed)
  0x03    type         Type 3 - Upper-Layer Protocol
  0x81    numeric_op   end-of-list, value size=1, ==
  0x06    value        06

  : [Table 2](#table-2){.selfRef}
:::

This constitutes an NLRI with an NLRI length of 18
octets.[¶](#section-3.8.1-5){.pilcrow}

Padding is not needed either for the destination prefix pattern (length
- offset = 32 bits) or for the source prefix pattern (length - offset =
40 bits), as both patterns end on an octet
boundary.[¶](#section-3.8.1-6){.pilcrow}
:::

::: {#section-3.8.2 .section}
#### [3.8.2.](#section-3.8.2){.section-number .selfRef} [Example 2](#name-example-2){.section-name .selfRef} {#name-example-2}

The following example demonstrates the prefix encoding for all packets
from ::1234:5678:9a00:0/65-104 to
2001:db8::/32.[¶](#section-3.8.2-1){.pilcrow}

::: {#example-2}
  length   destination            source
  -------- ---------------------- -------------------------
  0x0f     01 20 00 20 01 0d b8   02 68 41 24 68 ac f1 34

  : [Table 3](#table-3){.selfRef}
:::

Decoded:[¶](#section-3.8.2-3){.pilcrow}

::: {#example-2-decoded}
  Value                 
  ------- ------------- ----------------------------------
  0x0f    length        15 octets (if len\<240, 1 octet)
  0x01    type          Type 1 - Dest. IPv6 Prefix
  0x20    length        32 bits
  0x00    offset        0 bits
  0x20    pattern       
  0x01    pattern       
  0x0d    pattern       
  0xb8    pattern       (no padding needed)
  0x02    type          Type 2 - Source IPv6 Prefix
  0x68    length        104 bits
  0x41    offset        65 bits
  0x24    pattern       
  0x68    pattern       
  0xac    pattern       
  0xf1    pattern       
  0x34    pattern/pad   (contains 1 bit of padding)

  : [Table 4](#table-4){.selfRef}
:::

This constitutes an NLRI with an NLRI length of 15
octets.[¶](#section-3.8.2-5){.pilcrow}

The source prefix pattern is 104 - 65 = 39 bits in length. After the
pattern, one bit of padding needs to be added so that the component ends
on an octet boundary. However, only the first 39 bits are actually used
for bitwise pattern matching, starting with a 65-bit offset from the
topmost bit of the address.[¶](#section-3.8.2-6){.pilcrow}
:::
:::
:::
:::

::: {#section-4 .section}
## [4.](#section-4){.section-number .selfRef} [Ordering of Flow Specifications](#name-ordering-of-flow-specificat){.section-name .selfRef} {#name-ordering-of-flow-specificat}

The definition for the order of traffic filtering rules from [Section
5.1](https://www.rfc-editor.org/rfc/rfc8955#section-5.1){.relref} of
\[[RFC8955](#RFC8955){.xref}\] is reused with new consideration for the
IPv6 prefix offset. As long as the offsets are equal, the comparison is
the same, retaining longest-prefix-match semantics. If the offsets are
not equal, the lowest offset has precedence, as this Flow Specification
matches the most significant bit.[¶](#section-4-1){.pilcrow}

The code in [Appendix A](#flow_rule_cmp_src){.xref} shows a Python3
implementation of the resulting comparison algorithm. The full code was
tested with Python 3.7.2 and can be obtained at
\<<https://github.com/stoffi92/draft-ietf-idr-flow-spec-v6/tree/master/flowspec-cmp>\>.[¶](#section-4-2){.pilcrow}
:::

::: {#section-5 .section}
## [5.](#section-5){.section-number .selfRef} [Validation Procedure](#name-validation-procedure){.section-name .selfRef} {#name-validation-procedure}

The validation procedure is the same as specified in [Section
6](https://www.rfc-editor.org/rfc/rfc8955#section-6){.relref} of
\[[RFC8955](#RFC8955){.xref}\] with the exception that item a) of the
validation procedure should now read as
follows:[¶](#section-5-1){.pilcrow}

> []{.break}
>
> a\)
> :   A destination prefix component with offset=0 is embedded in the
>     Flow Specification[¶](#section-5-2.1.1){.pilcrow}
> :   
:::

::: {#section-6 .section}
## [6.](#section-6){.section-number .selfRef} [IPv6 Traffic Filtering Action Changes](#name-ipv6-traffic-filtering-acti){.section-name .selfRef} {#name-ipv6-traffic-filtering-acti}

Traffic Filtering Actions from [Section
7](https://www.rfc-editor.org/rfc/rfc8955#section-7){.relref} of
\[[RFC8955](#RFC8955){.xref}\] can also be applied to IPv6 Flow
Specifications. To allow an IPv6-Address-Specific Route-Target, a new
Traffic Filtering Action IPv6-Address-Specific Extended Community is
specified in [Section 6.1](#redirect_ipv6){.xref}
below.[¶](#section-6-1){.pilcrow}

::: {#redirect_ipv6}
::: {#section-6.1 .section}
### [6.1.](#section-6.1){.section-number .selfRef} [Redirect IPv6 (rt-redirect-ipv6) Type 0x000d](#name-redirect-ipv6-rt-redirect-i){.section-name .selfRef} {#name-redirect-ipv6-rt-redirect-i}

The redirect IPv6-Address-Specific Extended Community allows the traffic
to be redirected to a VRF routing instance that lists the specified
IPv6-Address-Specific Route-Target in its import policy. If several
local instances match this criteria, the choice between them is a local
matter (for example, the instance with the lowest Route Distinguisher
value can be elected).[¶](#section-6.1-1){.pilcrow}

This IPv6-Address-Specific Extended Community uses the same encoding as
the IPv6-Address-Specific Route-Target Extended Community ([Section
2](https://www.rfc-editor.org/rfc/rfc5701#section-2){.relref} of
\[[RFC5701](#RFC5701){.xref}\]) with the Type value always
0x000d.[¶](#section-6.1-2){.pilcrow}

The Local Administrator subfield contains a number from a numbering
space that is administered by the organization to which the IP address
carried in the Global Administrator subfield has been assigned by an
appropriate authority.[¶](#section-6.1-3){.pilcrow}

Interferes with: All BGP Flow Specification redirect Traffic Filtering
Actions (with itself and those specified in [Section
7.4](https://www.rfc-editor.org/rfc/rfc8955#section-7.4){.relref} of
\[[RFC8955](#RFC8955){.xref}\]).[¶](#section-6.1-4){.pilcrow}
:::
:::
:::

::: {#section-7 .section}
## [7.](#section-7){.section-number .selfRef} [Security Considerations](#name-security-considerations){.section-name .selfRef} {#name-security-considerations}

This document extends the functionality in
\[[RFC8955](#RFC8955){.xref}\] to be applicable to IPv6 data packets.
The same security considerations from \[[RFC8955](#RFC8955){.xref}\] now
also apply to IPv6 networks.[¶](#section-7-1){.pilcrow}

\[[RFC7112](#RFC7112){.xref}\] describes the impact of oversized IPv6
header chains when trying to match on the transport header; [Section
4.5](https://www.rfc-editor.org/rfc/rfc8200#section-4.5){.relref} of
\[[RFC8200](#RFC8200){.xref}\] also requires that the first fragment
must include the upper-layer header, but there could be wrongly
formatted packets not respecting \[[RFC8200](#RFC8200){.xref}\]. IPv6
Flow Specification component Type 3 ([Section 3.3](#type_3){.xref}) will
not be enforced for those illegal packets. Moreover, there are hardware
limitations in several routers ([Section
1](https://www.rfc-editor.org/rfc/rfc8883#section-1){.relref} of
\[[RFC8883](#RFC8883){.xref}\]) that may make it impossible to enforce a
policy signaled by a Type 3 Flow Specification component or Flow
Specification components that match on upper-layer properties of the
packet.[¶](#section-7-2){.pilcrow}
:::

::: {#IANA}
::: {#section-8 .section}
## [8.](#section-8){.section-number .selfRef} [IANA Considerations](#name-iana-considerations){.section-name .selfRef} {#name-iana-considerations}

This section complies with
\[[RFC7153](#RFC7153){.xref}\].[¶](#section-8-1){.pilcrow}

::: {#section-8.1 .section}
### [8.1.](#section-8.1){.section-number .selfRef} [Flow Spec IPv6 Component Types](#name-flow-spec-ipv6-component-ty){.section-name .selfRef} {#name-flow-spec-ipv6-component-ty}

IANA has created and maintains a registry entitled \"Flow Spec Component
Types\". IANA has added this document as a reference for that registry.
Furthermore, the registry has been updated to also contain the IPv6 Flow
Specification Component Types as described below. The registration
procedure remains unchanged.[¶](#section-8.1-1){.pilcrow}

::: {#section-8.1.1 .section}
#### [8.1.1.](#section-8.1.1){.section-number .selfRef} [Registry Template](#name-registry-template){.section-name .selfRef} {#name-registry-template}

[]{.break}

Type Value:
:   contains the assigned Flow Specification component type
    value[¶](#section-8.1.1-1.2){.pilcrow}
:   

IPv4 Name:
:   contains the associated IPv4 Flow Specification component name as
    specified in
    \[[RFC8955](#RFC8955){.xref}\][¶](#section-8.1.1-1.4){.pilcrow}
:   

IPv6 Name:
:   contains the associated IPv6 Flow Specification component name as
    specified in this document[¶](#section-8.1.1-1.6){.pilcrow}
:   

Reference:
:   contains references to the
    specifications[¶](#section-8.1.1-1.8){.pilcrow}
:   
:::

::: {#section-8.1.2 .section}
#### [8.1.2.](#section-8.1.2){.section-number .selfRef} [Registry Contents](#name-registry-contents){.section-name .selfRef} {#name-registry-contents}

[]{.break}

Type Value:
:   0[¶](#section-8.1.2-1.2){.pilcrow}
:   

IPv4 Name:
:   Reserved[¶](#section-8.1.2-1.4){.pilcrow}
:   

IPv6 Name:
:   Reserved[¶](#section-8.1.2-1.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-1.8){.pilcrow}
:   

[]{.break}

Type Value:
:   1[¶](#section-8.1.2-2.2){.pilcrow}
:   

IPv4 Name:
:   Destination Prefix[¶](#section-8.1.2-2.4){.pilcrow}
:   

IPv6 Name:
:   Destination IPv6 Prefix[¶](#section-8.1.2-2.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-2.8){.pilcrow}
:   

[]{.break}

Type Value:
:   2[¶](#section-8.1.2-3.2){.pilcrow}
:   

IPv4 Name:
:   Source Prefix[¶](#section-8.1.2-3.4){.pilcrow}
:   

IPv6 Name:
:   Source IPv6 Prefix[¶](#section-8.1.2-3.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-3.8){.pilcrow}
:   

[]{.break}

Type Value:
:   3[¶](#section-8.1.2-4.2){.pilcrow}
:   

IPv4 Name:
:   IP Protocol[¶](#section-8.1.2-4.4){.pilcrow}
:   

IPv6 Name:
:   Upper-Layer Protocol[¶](#section-8.1.2-4.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-4.8){.pilcrow}
:   

[]{.break}

Type Value:
:   4[¶](#section-8.1.2-5.2){.pilcrow}
:   

IPv4 Name:
:   Port[¶](#section-8.1.2-5.4){.pilcrow}
:   

IPv6 Name:
:   Port[¶](#section-8.1.2-5.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-5.8){.pilcrow}
:   

[]{.break}

Type Value:
:   5[¶](#section-8.1.2-6.2){.pilcrow}
:   

IPv4 Name:
:   Destination Port[¶](#section-8.1.2-6.4){.pilcrow}
:   

IPv6 Name:
:   Destination Port[¶](#section-8.1.2-6.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-6.8){.pilcrow}
:   

[]{.break}

Type Value:
:   6[¶](#section-8.1.2-7.2){.pilcrow}
:   

IPv4 Name:
:   Source Port[¶](#section-8.1.2-7.4){.pilcrow}
:   

IPv6 Name:
:   Source Port[¶](#section-8.1.2-7.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-7.8){.pilcrow}
:   

[]{.break}

Type Value:
:   7[¶](#section-8.1.2-8.2){.pilcrow}
:   

IPv4 Name:
:   ICMP Type[¶](#section-8.1.2-8.4){.pilcrow}
:   

IPv6 Name:
:   ICMPv6 Type[¶](#section-8.1.2-8.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-8.8){.pilcrow}
:   

[]{.break}

Type Value:
:   8[¶](#section-8.1.2-9.2){.pilcrow}
:   

IPv4 Name:
:   ICMP Code[¶](#section-8.1.2-9.4){.pilcrow}
:   

IPv6 Name:
:   ICMPv6 Code[¶](#section-8.1.2-9.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-9.8){.pilcrow}
:   

[]{.break}

Type Value:
:   9[¶](#section-8.1.2-10.2){.pilcrow}
:   

IPv4 Name:
:   TCP Flags[¶](#section-8.1.2-10.4){.pilcrow}
:   

IPv6 Name:
:   TCP Flags[¶](#section-8.1.2-10.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-10.8){.pilcrow}
:   

[]{.break}

Type Value:
:   10[¶](#section-8.1.2-11.2){.pilcrow}
:   

IPv4 Name:
:   Packet Length[¶](#section-8.1.2-11.4){.pilcrow}
:   

IPv6 Name:
:   Packet Length[¶](#section-8.1.2-11.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-11.8){.pilcrow}
:   

[]{.break}

Type Value:
:   11[¶](#section-8.1.2-12.2){.pilcrow}
:   

IPv4 Name:
:   DSCP[¶](#section-8.1.2-12.4){.pilcrow}
:   

IPv6 Name:
:   DSCP[¶](#section-8.1.2-12.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-12.8){.pilcrow}
:   

[]{.break}

Type Value:
:   12[¶](#section-8.1.2-13.2){.pilcrow}
:   

IPv4 Name:
:   Fragment[¶](#section-8.1.2-13.4){.pilcrow}
:   

IPv6 Name:
:   Fragment[¶](#section-8.1.2-13.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-13.8){.pilcrow}
:   

[]{.break}

Type Value:
:   13[¶](#section-8.1.2-14.2){.pilcrow}
:   

IPv4 Name:
:   Unassigned[¶](#section-8.1.2-14.4){.pilcrow}
:   

IPv6 Name:
:   Flow Label[¶](#section-8.1.2-14.6){.pilcrow}
:   

Reference:
:   RFC 8956[¶](#section-8.1.2-14.8){.pilcrow}
:   

[]{.break}

Type Value:
:   14-254[¶](#section-8.1.2-15.2){.pilcrow}
:   

IPv4 Name:
:   Unassigned[¶](#section-8.1.2-15.4){.pilcrow}
:   

IPv6 Name:
:   Unassigned[¶](#section-8.1.2-15.6){.pilcrow}
:   

[]{.break}

Type Value:
:   255[¶](#section-8.1.2-16.2){.pilcrow}
:   

IPv4 Name:
:   Reserved[¶](#section-8.1.2-16.4){.pilcrow}
:   

IPv6 Name:
:   Reserved[¶](#section-8.1.2-16.6){.pilcrow}
:   

Reference:
:   \[[RFC8955](#RFC8955){.xref}\], RFC
    8956[¶](#section-8.1.2-16.8){.pilcrow}
:   
:::
:::

::: {#section-8.2 .section}
### [8.2.](#section-8.2){.section-number .selfRef} [IPv6-Address-Specific Extended Community Flow Spec IPv6 Actions](#name-ipv6-address-specific-exten){.section-name .selfRef} {#name-ipv6-address-specific-exten}

IANA maintains a registry entitled \"Transitive IPv6-Address-Specific
Extended Community Types\". For the purpose of this work, IANA has
assigned a new value:[¶](#section-8.2-1){.pilcrow}

[]{#name-transitive-ipv6-address-spe}

::: {#iana_ext_comm_subtypes}
  Type Value   Name                                Reference
  ------------ ----------------------------------- -----------
  0x000d       Flow spec rt-redirect-ipv6 format   RFC 8956

  : [Table 5](#table-5){.selfRef}: [Transitive IPv6-Address-Specific
  Extended Community Types
  Registry](#name-transitive-ipv6-address-spe){.selfRef}
:::
:::
:::
:::

::: {#section-9 .section}
## [9.](#section-9){.section-number .selfRef} [Normative References](#name-normative-references){.section-name .selfRef} {#name-normative-references}

\[RFC2119\]
:   [Bradner, S.]{.refAuthor}, [\"Key words for use in RFCs to Indicate
    Requirement Levels\"]{.refTitle}, [BCP 14]{.seriesInfo}, [RFC
    2119]{.seriesInfo}, [DOI 10.17487/RFC2119]{.seriesInfo}, March 1997,
    \<<https://www.rfc-editor.org/info/rfc2119>\>.
:   

\[RFC4271\]
:   [Rekhter, Y., Ed.]{.refAuthor}[, Li, T., Ed.]{.refAuthor}[, and S.
    Hares, Ed.]{.refAuthor}, [\"A Border Gateway Protocol 4
    (BGP-4)\"]{.refTitle}, [RFC 4271]{.seriesInfo}, [DOI
    10.17487/RFC4271]{.seriesInfo}, January 2006,
    \<<https://www.rfc-editor.org/info/rfc4271>\>.
:   

\[RFC4443\]
:   [Conta, A.]{.refAuthor}[, Deering, S.]{.refAuthor}[, and M. Gupta,
    Ed.]{.refAuthor}, [\"Internet Control Message Protocol (ICMPv6) for
    the Internet Protocol Version 6 (IPv6) Specification\"]{.refTitle},
    [STD 89]{.seriesInfo}, [RFC 4443]{.seriesInfo}, [DOI
    10.17487/RFC4443]{.seriesInfo}, March 2006,
    \<<https://www.rfc-editor.org/info/rfc4443>\>.
:   

\[RFC4760\]
:   [Bates, T.]{.refAuthor}[, Chandra, R.]{.refAuthor}[,
    Katz, D.]{.refAuthor}[, and Y. Rekhter]{.refAuthor},
    [\"Multiprotocol Extensions for BGP-4\"]{.refTitle}, [RFC
    4760]{.seriesInfo}, [DOI 10.17487/RFC4760]{.seriesInfo}, January
    2007, \<<https://www.rfc-editor.org/info/rfc4760>\>.
:   

\[RFC5701\]
:   [Rekhter, Y.]{.refAuthor}, [\"IPv6 Address Specific BGP Extended
    Community Attribute\"]{.refTitle}, [RFC 5701]{.seriesInfo}, [DOI
    10.17487/RFC5701]{.seriesInfo}, November 2009,
    \<<https://www.rfc-editor.org/info/rfc5701>\>.
:   

\[RFC7112\]
:   [Gont, F.]{.refAuthor}[, Manral, V.]{.refAuthor}[, and R.
    Bonica]{.refAuthor}, [\"Implications of Oversized IPv6 Header
    Chains\"]{.refTitle}, [RFC 7112]{.seriesInfo}, [DOI
    10.17487/RFC7112]{.seriesInfo}, January 2014,
    \<<https://www.rfc-editor.org/info/rfc7112>\>.
:   

\[RFC7153\]
:   [Rosen, E.]{.refAuthor}[ and Y. Rekhter]{.refAuthor}, [\"IANA
    Registries for BGP Extended Communities\"]{.refTitle}, [RFC
    7153]{.seriesInfo}, [DOI 10.17487/RFC7153]{.seriesInfo}, March 2014,
    \<<https://www.rfc-editor.org/info/rfc7153>\>.
:   

\[RFC8174\]
:   [Leiba, B.]{.refAuthor}, [\"Ambiguity of Uppercase vs Lowercase in
    RFC 2119 Key Words\"]{.refTitle}, [BCP 14]{.seriesInfo}, [RFC
    8174]{.seriesInfo}, [DOI 10.17487/RFC8174]{.seriesInfo}, May 2017,
    \<<https://www.rfc-editor.org/info/rfc8174>\>.
:   

\[RFC8200\]
:   [Deering, S.]{.refAuthor}[ and R. Hinden]{.refAuthor}, [\"Internet
    Protocol, Version 6 (IPv6) Specification\"]{.refTitle}, [STD
    86]{.seriesInfo}, [RFC 8200]{.seriesInfo}, [DOI
    10.17487/RFC8200]{.seriesInfo}, July 2017,
    \<<https://www.rfc-editor.org/info/rfc8200>\>.
:   

\[RFC8883\]
:   [Herbert, T.]{.refAuthor}, [\"ICMPv6 Errors for Discarding Packets
    Due to Processing Limits\"]{.refTitle}, [RFC 8883]{.seriesInfo},
    [DOI 10.17487/RFC8883]{.seriesInfo}, September 2020,
    \<<https://www.rfc-editor.org/info/rfc8883>\>.
:   

\[RFC8955\]
:   [Loibl, C.]{.refAuthor}[, Hares, S.]{.refAuthor}[,
    Raszuk, R.]{.refAuthor}[, McPherson, D.]{.refAuthor}[, and M.
    Bacher]{.refAuthor}, [\"Dissemination of Flow Specification
    Rules\"]{.refTitle}, [RFC 8955]{.seriesInfo}, [DOI
    10.17487/RFC8955]{.seriesInfo}, December 2020,
    \<<https://www.rfc-editor.org/info/rfc8955>\>.
:   
:::

::: {#flow_rule_cmp_src}
::: {#section-appendix.a .section}
## [Appendix A.](#section-appendix.a){.section-number .selfRef} [Example Python Code: flow_rule_cmp_v6](#name-example-python-code-flow_ru){.section-name .selfRef} {#name-example-python-code-flow_ru}

::: {#section-appendix.a-1}
``` {.sourcecode .lang-python}
<CODE BEGINS>
"""
Copyright (c) 2020 IETF Trust and the persons identified as authors
of the code. All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, is permitted pursuant to, and subject to the license
terms contained in, the Simplified BSD License set forth in Section
4.c of the IETF Trust's Legal Provisions Relating to IETF Documents
(https://trustee.ietf.org/license-info).
"""

import itertools
import collections
import ipaddress


EQUAL = 0
A_HAS_PRECEDENCE = 1
B_HAS_PRECEDENCE = 2
IP_DESTINATION = 1
IP_SOURCE = 2

FS_component = collections.namedtuple('FS_component',
                                      'component_type value')


class FS_IPv6_prefix_component:
    def __init__(self, prefix, offset=0,
                 component_type=IP_DESTINATION):
        self.offset = offset
        self.component_type = component_type
        # make sure if offset != 0 that none of the
        # first offset bits are set in the prefix
        self.value = prefix
        if offset != 0:
            i = ipaddress.IPv6Interface(
                (self.value.network_address, offset))
            if i.network.network_address != \
                ipaddress.ip_address('0::0'):
                raise ValueError('Bits set in the offset')


class FS_nlri(object):
    """
    FS_nlri class implementation that allows sorting.

    By calling .sort() on an array of FS_nlri objects these
    will be sorted according to the flow_rule_cmp algorithm.

    Example:
    nlri = [ FS_nlri(components=[
             FS_component(component_type=4,
                          value=bytearray([0,1,2,3,4,5,6])),
             ]),
             FS_nlri(components=[
             FS_component(component_type=5,
                          value=bytearray([0,1,2,3,4,5,6])),
             FS_component(component_type=6,
                          value=bytearray([0,1,2,3,4,5,6])),
             ]),
           ]
    nlri.sort() # sorts the array according to the algorithm
    """
    def __init__(self, components = None):
        """
        components: list of type FS_component
        """
        self.components = components

    def __lt__(self, other):
        # use the below algorithm for sorting
        result = flow_rule_cmp_v6(self, other)
        if result == B_HAS_PRECEDENCE:
            return True
        else:
            return False


def flow_rule_cmp_v6(a, b):
    """
    Implementation of the flowspec sorting algorithm in
    RFC 8956.
    """
    for comp_a, comp_b in itertools.zip_longest(a.components,
                                           b.components):
        # If a component type does not exist in one rule
        # this rule has lower precedence
        if not comp_a:
            return B_HAS_PRECEDENCE
        if not comp_b:
            return A_HAS_PRECEDENCE
        # Higher precedence for lower component type
        if comp_a.component_type < comp_b.component_type:
            return A_HAS_PRECEDENCE
        if comp_a.component_type > comp_b.component_type:
            return B_HAS_PRECEDENCE
        # component types are equal -> type-specific comparison
        if comp_a.component_type in (IP_DESTINATION, IP_SOURCE):
            if comp_a.offset < comp_b.offset:
                return A_HAS_PRECEDENCE
            if comp_a.offset > comp_b.offset:
                return B_HAS_PRECEDENCE
            # both components have the same offset
            # assuming comp_a.value, comp_b.value of type
            # ipaddress.IPv6Network
            # and the offset bits are reset to 0 (since they are
            # not represented in the NLRI)
            if comp_a.value.overlaps(comp_b.value):
                # longest prefixlen has precedence
                if comp_a.value.prefixlen > \
                    comp_b.value.prefixlen:
                    return A_HAS_PRECEDENCE
                if comp_a.value.prefixlen < \
                    comp_b.value.prefixlen:
                    return B_HAS_PRECEDENCE
                # components equal -> continue with next
                # component
            elif comp_a.value > comp_b.value:
                return B_HAS_PRECEDENCE
            elif comp_a.value < comp_b.value:
                return A_HAS_PRECEDENCE
        else:
            # assuming comp_a.value, comp_b.value of type
            # bytearray
            if len(comp_a.value) == len(comp_b.value):
                if comp_a.value > comp_b.value:
                    return B_HAS_PRECEDENCE
                if comp_a.value < comp_b.value:
                    return A_HAS_PRECEDENCE
                # components equal -> continue with next
                # component
            else:
                common = min(len(comp_a.value),
                             len(comp_b.value))
                if comp_a.value[:common] > \
                    comp_b.value[:common]:
                    return B_HAS_PRECEDENCE
                elif comp_a.value[:common] < \
                      comp_b.value[:common]:
                    return A_HAS_PRECEDENCE
                # the first common bytes match
                elif len(comp_a.value) > len(comp_b.value):
                    return A_HAS_PRECEDENCE
                else:
                    return B_HAS_PRECEDENCE
    return EQUAL

<CODE ENDS>
```

[¶](#section-appendix.a-1){.pilcrow}
:::
:::
:::

::: {#section-appendix.b .section}
## [Acknowledgments](#name-acknowledgments){.section-name .selfRef} {#name-acknowledgments}

The authors would like to thank [Pedro Marques]{.contact-name}, [Hannes
Gredler]{.contact-name}, [Bruno Rijsman]{.contact-name}, [Brian
Carpenter]{.contact-name}, and [Thomas Mangin]{.contact-name} for their
valuable input.[¶](#section-appendix.b-1){.pilcrow}
:::

::: {#section-appendix.c .section}
## [Contributors](#name-contributors){.section-name .selfRef} {#name-contributors}

::: {.left dir="auto"}
[Danny McPherson]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Verisign, Inc.]{.org}
:::

::: email
Email: <dmcpherson@verisign.com>
:::

::: {.left dir="auto"}
[Burjiz Pithawala]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Individual]{.org}
:::

::: email
Email: <burjizp@gmail.com>
:::

::: {.left dir="auto"}
[Andy Karch]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Cisco Systems]{.org}
:::

::: {.left dir="auto"}
[170 West Tasman Drive]{.street-address}
:::

::: {.left dir="auto"}
[San Jose]{.locality}, [CA]{.region} [95134]{.postal-code}
:::

::: {.left dir="auto"}
[United States of America]{.country-name}
:::

::: email
Email: <akarch@cisco.com>
:::
:::

::: {#authors-addresses}
::: {#section-appendix.d .section}
## [Authors\' Addresses](#name-authors-addresses){.section-name .selfRef} {#name-authors-addresses}

::: {.left dir="auto"}
[Christoph Loibl ([editor]{.role})]{.fn .nameRole}
:::

::: {.left dir="auto"}
[next layer Telekom GmbH]{.org}
:::

::: {.left dir="auto"}
[Mariahilfer Guertel 37/7]{.street-address}
:::

::: {.left dir="auto"}
[1150]{.postal-code} [Vienna]{.locality}
:::

::: {.left dir="auto"}
[Austria]{.country-name}
:::

::: tel
Phone: [+43 664 1176414](tel:+43%20664%201176414){.tel}
:::

::: email
Email: <cl@tix.at>
:::

::: {.left dir="auto"}
[Robert Raszuk ([editor]{.role})]{.fn .nameRole}
:::

::: {.left dir="auto"}
[NTT Network Innovations]{.org}
:::

::: {.left dir="auto"}
[940 Stewart Dr]{.street-address}
:::

::: {.left dir="auto"}
[Sunnyvale]{.locality}, [CA]{.region} [94085]{.postal-code}
:::

::: {.left dir="auto"}
[United States of America]{.country-name}
:::

::: email
Email: <robert@raszuk.net>
:::

::: {.left dir="auto"}
[Susan Hares ([editor]{.role})]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Huawei]{.org}
:::

::: {.left dir="auto"}
[7453 Hickory Hill]{.street-address}
:::

::: {.left dir="auto"}
[Saline]{.locality}, [MI]{.region} [48176]{.postal-code}
:::

::: {.left dir="auto"}
[United States of America]{.country-name}
:::

::: email
Email: <shares@ndzh.com>
:::
:::
:::
