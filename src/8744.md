  RFC 8744   TLS-SNI Encryption Requirements   July 2020
  ---------- --------------------------------- -----------
  Huitema    Informational                     \[Page\]

::: {#external-metadata .document-information}
:::

::: {#internal-metadata .document-information}

Stream:
:   Internet Engineering Task Force (IETF)

RFC:
:   [8744](https://www.rfc-editor.org/rfc/rfc8744){.eref}

Category:
:   Informational

Published:
:   July 2020

ISSN:
:   2070-1721

Author:

:   ::: author
    ::: author-name
    C. Huitema
    :::

    ::: org
    Private Octopus Inc.
    :::
    :::
:::

# RFC 8744 {#rfcnum}

# Issues and Requirements for Server Name Identification (SNI) Encryption in TLS {#title}

::: {#section-abstract .section}
## [Abstract](#abstract){.selfRef}

This document describes the general problem of encrypting the Server
Name Identification (SNI) TLS parameter. The proposed solutions hide a
hidden service behind a fronting service, only disclosing the SNI of the
fronting service to external observers. This document lists known
attacks against SNI encryption, discusses the current \"HTTP
co-tenancy\" solution, and presents requirements for future TLS-layer
solutions.[¶](#section-abstract-1){.pilcrow}

In practice, it may well be that no solution can meet every requirement
and that practical solutions will have to make some
compromises.[¶](#section-abstract-2){.pilcrow}
:::

::: {#status-of-memo}
::: {#section-boilerplate.1 .section}
## [Status of This Memo](#name-status-of-this-memo){.section-name .selfRef} {#name-status-of-this-memo}

This document is not an Internet Standards Track specification; it is
published for informational
purposes.[¶](#section-boilerplate.1-1){.pilcrow}

This document is a product of the Internet Engineering Task Force
(IETF). It represents the consensus of the IETF community. It has
received public review and has been approved for publication by the
Internet Engineering Steering Group (IESG). Not all documents approved
by the IESG are candidates for any level of Internet Standard; see
Section 2 of RFC 7841.[¶](#section-boilerplate.1-2){.pilcrow}

Information about the current status of this document, any errata, and
how to provide feedback on it may be obtained at
<https://www.rfc-editor.org/info/rfc8744>.[¶](#section-boilerplate.1-3){.pilcrow}
:::
:::

::: {#copyright}
::: {#section-boilerplate.2 .section}
## [Copyright Notice](#name-copyright-notice){.section-name .selfRef} {#name-copyright-notice}

Copyright (c) 2020 IETF Trust and the persons identified as the document
authors. All rights reserved.[¶](#section-boilerplate.2-1){.pilcrow}

This document is subject to BCP 78 and the IETF Trust\'s Legal
Provisions Relating to IETF Documents
(<https://trustee.ietf.org/license-info>) in effect on the date of
publication of this document. Please review these documents carefully,
as they describe your rights and restrictions with respect to this
document. Code Components extracted from this document must include
Simplified BSD License text as described in Section 4.e of the Trust
Legal Provisions and are provided without warranty as described in the
Simplified BSD License.[¶](#section-boilerplate.2-2){.pilcrow}
:::
:::

::: {#toc}
::: {#section-toc.1 .section}
[▲](#){.toplink}

## [Table of Contents](#name-table-of-contents){.section-name .selfRef} {#name-table-of-contents}

-   ::: {#section-toc.1-1.1}
    [1](#section-1){.xref}.  [Introduction](#name-introduction){.xref}[¶](#section-toc.1-1.1.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.2}
    [2](#section-2){.xref}.  [History of the TLS SNI
    Extension](#name-history-of-the-tls-sni-exte){.xref}[¶](#section-toc.1-1.2.1){.pilcrow}

    -   ::: {#section-toc.1-1.2.2.1}
        [2.1](#section-2.1){.xref}.  [Unanticipated Usage of SNI
        Information](#name-unanticipated-usage-of-sni-){.xref}[¶](#section-toc.1-1.2.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.2.2.2}
        [2.2](#section-2.2){.xref}.  [SNI Encryption
        Timeliness](#name-sni-encryption-timeliness){.xref}[¶](#section-toc.1-1.2.2.2.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.2.2.3}
        [2.3](#section-2.3){.xref}.  [End-to-End
        Alternatives](#name-end-to-end-alternatives){.xref}[¶](#section-toc.1-1.2.2.3.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.3}
    [3](#section-3){.xref}.  [Security and Privacy Requirements for SNI
    Encryption](#name-security-and-privacy-requir){.xref}[¶](#section-toc.1-1.3.1){.pilcrow}

    -   ::: {#section-toc.1-1.3.2.1}
        [3.1](#section-3.1){.xref}.  [Mitigate Cut-and-Paste
        Attacks](#name-mitigate-cut-and-paste-atta){.xref}[¶](#section-toc.1-1.3.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.2}
        [3.2](#section-3.2){.xref}.  [Avoid Widely Shared
        Secrets](#name-avoid-widely-shared-secrets){.xref}[¶](#section-toc.1-1.3.2.2.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.3}
        [3.3](#section-3.3){.xref}.  [Prevent SNI-Based
        Denial-of-Service
        Attacks](#name-prevent-sni-based-denial-of){.xref}[¶](#section-toc.1-1.3.2.3.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.4}
        [3.4](#section-3.4){.xref}.  [Do Not Stick
        Out](#name-do-not-stick-out){.xref}[¶](#section-toc.1-1.3.2.4.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.5}
        [3.5](#section-3.5){.xref}.  [Maintain Forward
        Secrecy](#name-maintain-forward-secrecy){.xref}[¶](#section-toc.1-1.3.2.5.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.6}
        [3.6](#section-3.6){.xref}.  [Enable Multi-party Security
        Contexts](#name-enable-multi-party-security){.xref}[¶](#section-toc.1-1.3.2.6.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.3.2.7}
        [3.7](#section-3.7){.xref}.  [Support Multiple
        Protocols](#name-support-multiple-protocols){.xref}[¶](#section-toc.1-1.3.2.7.1){.pilcrow}

        -   ::: {#section-toc.1-1.3.2.7.2.1}
            [3.7.1](#section-3.7.1){.xref}.  [Hiding the
            Application-Layer Protocol
            Negotiation](#name-hiding-the-application-laye){.xref}[¶](#section-toc.1-1.3.2.7.2.1.1){.pilcrow}
            :::

        -   ::: {#section-toc.1-1.3.2.7.2.2}
            [3.7.2](#section-3.7.2){.xref}.  [Supporting Other
            Transports than
            TCP](#name-supporting-other-transports){.xref}[¶](#section-toc.1-1.3.2.7.2.2.1){.pilcrow}
            :::
        :::
    :::

-   ::: {#section-toc.1-1.4}
    [4](#section-4){.xref}.  [HTTP Co-tenancy
    Fronting](#name-http-co-tenancy-fronting){.xref}[¶](#section-toc.1-1.4.1){.pilcrow}

    -   ::: {#section-toc.1-1.4.2.1}
        [4.1](#section-4.1){.xref}.  [HTTPS
        Tunnels](#name-https-tunnels){.xref}[¶](#section-toc.1-1.4.2.1.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.4.2.2}
        [4.2](#section-4.2){.xref}.  [Delegation
        Control](#name-delegation-control){.xref}[¶](#section-toc.1-1.4.2.2.1){.pilcrow}
        :::

    -   ::: {#section-toc.1-1.4.2.3}
        [4.3](#section-4.3){.xref}.  [Related
        Work](#name-related-work){.xref}[¶](#section-toc.1-1.4.2.3.1){.pilcrow}
        :::
    :::

-   ::: {#section-toc.1-1.5}
    [5](#section-5){.xref}.  [Security
    Considerations](#name-security-considerations){.xref}[¶](#section-toc.1-1.5.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.6}
    [6](#section-6){.xref}.  [IANA
    Considerations](#name-iana-considerations){.xref}[¶](#section-toc.1-1.6.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.7}
    [7](#section-7){.xref}.  [Informative
    References](#name-informative-references){.xref}[¶](#section-toc.1-1.7.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.8}
    [](#section-appendix.a){.xref}[Acknowledgements](#name-acknowledgements){.xref}[¶](#section-toc.1-1.8.1){.pilcrow}
    :::

-   ::: {#section-toc.1-1.9}
    [](#section-appendix.b){.xref}[Author\'s
    Address](#name-authors-address){.xref}[¶](#section-toc.1-1.9.1){.pilcrow}
    :::
:::
:::

::: {#introduction}
::: {#section-1 .section}
## [1.](#section-1){.section-number .selfRef} [Introduction](#name-introduction){.section-name .selfRef} {#name-introduction}

Historically, adversaries have been able to monitor the use of web
services through three primary channels: looking at DNS requests,
looking at IP addresses in packet headers, and looking at the data
stream between user and services. These channels are getting
progressively closed. A growing fraction of Internet communication is
encrypted, mostly using Transport Layer Security (TLS)
\[[RFC8446](#RFC8446){.xref}\]. Progressive deployment of solutions like
DNS over TLS \[[RFC7858](#RFC7858){.xref}\] and DNS over HTTPS
\[[RFC8484](#RFC8484){.xref}\] mitigates the disclosure of DNS
information. More and more services are colocated on multiplexed
servers, loosening the relation between IP address and web service. For
example, in virtual hosting solutions, multiple services can be hosted
as co-tenants on the same server, and the IP address and port do not
uniquely identify a service. In cloud or Content Delivery Network (CDN)
solutions, a given platform hosts the services or servers of a lot of
organizations, and looking up what netblock an IP address belongs to
reveals little. However, multiplexed servers rely on the Server Name
Information (SNI) TLS extension \[[RFC6066](#RFC6066){.xref}\] to direct
connections to the appropriate service implementation. This protocol
element is transmitted in cleartext. As the other methods of monitoring
get blocked, monitoring focuses on the cleartext SNI. The purpose of SNI
encryption is to prevent that and aid
privacy.[¶](#section-1-1){.pilcrow}

Replacing cleartext SNI transmission by an encrypted variant will
improve the privacy and reliability of TLS connections, but the design
of proper SNI encryption solutions is difficult. In the past, there have
been multiple attempts at defining SNI encryption. These attempts have
generally floundered, because the simple designs fail to mitigate
several of the attacks listed in [Section 3](#snisecreq){.xref}. In the
absence of a TLS-level solution, the most popular approach to SNI
privacy for web services is HTTP-level fronting, which we discuss in
[Section 4](#httpfronting){.xref}.[¶](#section-1-2){.pilcrow}

This document does not present the design of a solution but provides
guidelines for evaluating proposed solutions. (The review of HTTP-level
solutions in [Section 4](#httpfronting){.xref} is not an endorsement of
these solutions.) The need for related work on the encryption of the
Application-Layer Protocol Negotiation (ALPN) parameters of TLS is
discussed in [Section
3.7.1](#hiding-alpn){.xref}.[¶](#section-1-3){.pilcrow}
:::
:::

::: {#history-of-the-tls-sni-extension}
::: {#section-2 .section}
## [2.](#section-2){.section-number .selfRef} [History of the TLS SNI Extension](#name-history-of-the-tls-sni-exte){.section-name .selfRef} {#name-history-of-the-tls-sni-exte}

The SNI extension was specified in 2003 in
\[[RFC3546](#RFC3546){.xref}\] to facilitate management of \"colocation
servers\", in which multiple services shared the same IP address. A
typical example would be multiple websites served by the same web
server. The SNI extension carries the name of a specific server,
enabling the TLS connection to be established with the desired server
context. The current SNI extension specification can be found in
\[[RFC6066](#RFC6066){.xref}\].[¶](#section-2-1){.pilcrow}

The SNI specification allowed for different types of server names,
though only the \"hostname\" variant was specified and deployed. In that
variant, the SNI extension carries the domain name of the target server.
The SNI extension is carried in cleartext in the TLS \"ClientHello\"
message.[¶](#section-2-2){.pilcrow}

::: {#snileak}
::: {#section-2.1 .section}
### [2.1.](#section-2.1){.section-number .selfRef} [Unanticipated Usage of SNI Information](#name-unanticipated-usage-of-sni-){.section-name .selfRef} {#name-unanticipated-usage-of-sni-}

The SNI was defined to facilitate management of servers, but the
developers of middleboxes found out that they could take advantage of
the information. Many examples of such usage are reviewed in
\[[RFC8404](#RFC8404){.xref}\]. Other examples came out during
discussions of this document. They include:[¶](#section-2.1-1){.pilcrow}

-   [Filtering or censoring specific services for a variety of
    reasons[¶](#section-2.1-2.1){.pilcrow}]{#section-2.1-2.1}
-   [Content filtering by network operators or ISPs blocking specific
    websites, for example, to implement parental controls or to prevent
    access to phishing or other fraudulent
    websites[¶](#section-2.1-2.2){.pilcrow}]{#section-2.1-2.2}
-   [ISP assigning different QoS profiles to target
    services[¶](#section-2.1-2.3){.pilcrow}]{#section-2.1-2.3}
-   [Firewalls within enterprise networks blocking websites not deemed
    appropriate for
    work[¶](#section-2.1-2.4){.pilcrow}]{#section-2.1-2.4}
-   [Firewalls within enterprise networks exempting specific websites
    from man-in-the-middle (MITM) inspection, such as healthcare or
    financial sites for which inspection would intrude on the privacy of
    employees[¶](#section-2.1-2.5){.pilcrow}]{#section-2.1-2.5}

The SNI is probably also included in the general collection of metadata
by pervasive surveillance actors \[[RFC7258](#RFC7258){.xref}\], for
example, to identify services used by surveillance
targets.[¶](#section-2.1-3){.pilcrow}
:::
:::

::: {#sniwhyencryptnow}
::: {#section-2.2 .section}
### [2.2.](#section-2.2){.section-number .selfRef} [SNI Encryption Timeliness](#name-sni-encryption-timeliness){.section-name .selfRef} {#name-sni-encryption-timeliness}

The cleartext transmission of the SNI was not flagged as a problem in
the Security Considerations sections of \[[RFC3546](#RFC3546){.xref}\],
\[[RFC4366](#RFC4366){.xref}\], or \[[RFC6066](#RFC6066){.xref}\]. These
specifications did not anticipate the alternative usage described in
[Section 2.1](#snileak){.xref}. One reason may be that, when these RFCs
were written, the SNI information was available through a variety of
other means, such as tracking IP addresses, DNS names, or server
certificates.[¶](#section-2.2-1){.pilcrow}

Many deployments still allocate different IP addresses to different
services, so that different services can be identified by their IP
addresses. However, CDNs commonly serve a large number of services
through a comparatively small number of
addresses.[¶](#section-2.2-2){.pilcrow}

The SNI carries the domain name of the server, which is also sent as
part of the DNS queries. Most of the SNI usage described in [Section
2.1](#snileak){.xref} could also be implemented by monitoring DNS
traffic or controlling DNS usage. But this is changing with the advent
of DNS resolvers providing services like DNS over TLS
\[[RFC7858](#RFC7858){.xref}\] or DNS over HTTPS
\[[RFC8484](#RFC8484){.xref}\].[¶](#section-2.2-3){.pilcrow}

The subjectAltName extension of type dNSName of the server certificate
(or in its absence, the common name component) exposes the same name as
the SNI. In TLS versions 1.0 \[[RFC2246](#RFC2246){.xref}\], 1.1
\[[RFC4346](#RFC4346){.xref}\], and 1.2 \[[RFC5246](#RFC5246){.xref}\],
servers send certificates in cleartext, ensuring that there would be
limited benefits in hiding the SNI. However, in TLS 1.3
\[[RFC8446](#RFC8446){.xref}\], server certificates are encrypted in
transit. Note that encryption alone is insufficient to protect server
certificates; see [Section 3.1](#cutandpasteattack){.xref} for
details.[¶](#section-2.2-4){.pilcrow}

The decoupling of IP addresses and server names, deployment of DNS
privacy, and protection of server certificate transmissions all
contribute to user privacy in the face of an RFC 7258-style adversary
\[[RFC7258](#RFC7258){.xref}\]. Encrypting the SNI complements this push
for privacy and makes it harder to censor or otherwise provide
differential treatment to specific Internet
services.[¶](#section-2.2-5){.pilcrow}
:::
:::

::: {#end-to-end}
::: {#section-2.3 .section}
### [2.3.](#section-2.3){.section-number .selfRef} [End-to-End Alternatives](#name-end-to-end-alternatives){.section-name .selfRef} {#name-end-to-end-alternatives}

Deploying SNI encryption helps thwart most of the unanticipated SNI
usages, including censorship and pervasive surveillance, but it also
will break or reduce the efficacy of the operational practices and
techniques implemented in middleboxes, as described in [Section
2.1](#snileak){.xref}. Most of these functions can, however, be realized
by other means. For example, some DNS service providers offer customers
the provision to \"opt in\" to filtering services for parental control
and phishing protection. Per-stream QoS could be provided by a
combination of packet marking and end-to-end agreements. As SNI
encryption becomes common, we can expect more deployment of such
\"end-to-end\" solutions.[¶](#section-2.3-1){.pilcrow}

At the time of this writing, enterprises have the option of installing a
firewall performing SNI filtering to prevent connections to certain
websites. With SNI encryption, this becomes ineffective. Obviously,
managers could block usage of SNI encryption in enterprise computers,
but this wide-scale blocking would diminish the privacy protection of
traffic leaving the enterprise, which may not be desirable. Enterprise
managers could rely instead on filtering software and management
software deployed on the enterprise\'s
computers.[¶](#section-2.3-2){.pilcrow}
:::
:::
:::
:::

::: {#snisecreq}
::: {#section-3 .section}
## [3.](#section-3){.section-number .selfRef} [Security and Privacy Requirements for SNI Encryption](#name-security-and-privacy-requir){.section-name .selfRef} {#name-security-and-privacy-requir}

Over the past years, there have been multiple proposals to add an SNI
encryption option in TLS. A review of the TLS mailing list archives
shows that many of these proposals appeared promising but were rejected
after security reviews identified plausible attacks. In this section, we
collect a list of these known attacks.[¶](#section-3-1){.pilcrow}

::: {#cutandpasteattack}
::: {#section-3.1 .section}
### [3.1.](#section-3.1){.section-number .selfRef} [Mitigate Cut-and-Paste Attacks](#name-mitigate-cut-and-paste-atta){.section-name .selfRef} {#name-mitigate-cut-and-paste-atta}

The simplest SNI encryption designs replace the cleartext SNI in the
initial TLS exchange with an encrypted value, using a key known to the
multiplexed server. Regardless of the encryption used, these designs can
be broken by a simple cut-and-paste attack, which works as
follows:[¶](#section-3.1-1){.pilcrow}

1.  [The user starts a TLS connection to the multiplexed server,
    including an encrypted SNI
    value.[¶](#section-3.1-2.1){.pilcrow}]{#section-3.1-2.1}
2.  [The adversary observes the exchange and copies the encrypted SNI
    parameter.[¶](#section-3.1-2.2){.pilcrow}]{#section-3.1-2.2}
3.  [The adversary starts its own connection to the multiplexed server,
    including in its connection parameters the encrypted SNI copied from
    the observed
    exchange.[¶](#section-3.1-2.3){.pilcrow}]{#section-3.1-2.3}
4.  [The multiplexed server establishes the connection to the protected
    service, which sends its certificate, thus revealing the identity of
    the service.[¶](#section-3.1-2.4){.pilcrow}]{#section-3.1-2.4}

One of the goals of SNI encryption is to prevent adversaries from
knowing which hidden service the client is using. Successful
cut-and-paste attacks break that goal by allowing adversaries to
discover that service.[¶](#section-3.1-3){.pilcrow}
:::
:::

::: {#sharedsecrets}
::: {#section-3.2 .section}
### [3.2.](#section-3.2){.section-number .selfRef} [Avoid Widely Shared Secrets](#name-avoid-widely-shared-secrets){.section-name .selfRef} {#name-avoid-widely-shared-secrets}

It is easy to think of simple schemes in which the SNI is encrypted or
hashed using a shared secret. This symmetric key must be known by the
multiplexed server and by every user of the protected services. Such
schemes are thus very fragile, since the compromise of a single user
would compromise the entire set of users and protected
services.[¶](#section-3.2-1){.pilcrow}
:::
:::

::: {#serveroverload}
::: {#section-3.3 .section}
### [3.3.](#section-3.3){.section-number .selfRef} [Prevent SNI-Based Denial-of-Service Attacks](#name-prevent-sni-based-denial-of){.section-name .selfRef} {#name-prevent-sni-based-denial-of}

Encrypting the SNI may create extra load for the multiplexed server.
Adversaries may mount denial-of-service (DoS) attacks by generating
random encrypted SNI values and forcing the multiplexed server to spend
resources in useless decryption attempts.[¶](#section-3.3-1){.pilcrow}

It may be argued that this is not an important avenue for DoS attacks,
as regular TLS connection attempts also require the server to perform a
number of cryptographic operations. However, in many cases, the SNI
decryption will have to be performed by a front-end component with
limited resources, while the TLS operations are performed by the
component dedicated to their respective services. SNI-based DoS attacks
could target the front-end component.[¶](#section-3.3-2){.pilcrow}
:::
:::

::: {#snireqdontstickout}
::: {#section-3.4 .section}
### [3.4.](#section-3.4){.section-number .selfRef} [Do Not Stick Out](#name-do-not-stick-out){.section-name .selfRef} {#name-do-not-stick-out}

In some designs, handshakes using SNI encryption can be easily
differentiated from \"regular\" handshakes. For example, some designs
require specific extensions in the ClientHello packets or specific
values of the cleartext SNI parameter. If adversaries can easily detect
the use of SNI encryption, they could block it, or they could flag the
users of SNI encryption for special
treatment.[¶](#section-3.4-1){.pilcrow}

In the future, it might be possible to assume that a large fraction of
TLS handshakes use SNI encryption. If that were the case, the detection
of SNI encryption would be a lesser concern. However, we have to assume
that, in the near future, only a small fraction of TLS connections will
use SNI encryption.[¶](#section-3.4-2){.pilcrow}

This requirement to not stick out may be difficult to meet in practice,
as noted in [Section 5](#secusec){.xref}.[¶](#section-3.4-3){.pilcrow}
:::
:::

::: {#forward-secrecy}
::: {#section-3.5 .section}
### [3.5.](#section-3.5){.section-number .selfRef} [Maintain Forward Secrecy](#name-maintain-forward-secrecy){.section-name .selfRef} {#name-maintain-forward-secrecy}

TLS 1.3 \[[RFC8446](#RFC8446){.xref}\] is designed to provide forward
secrecy, so that (for example) keys used in past sessions will not be
compromised even if the private key of the server is compromised. The
general concerns about forward secrecy apply to SNI encryption as well.
For example, some proposed designs rely on a public key of the
multiplexed server to define the SNI encryption key. If the
corresponding private key should be compromised, the adversaries would
be able to process archival records of past connections and retrieve the
protected SNI used in these connections. These designs fail to maintain
forward secrecy of SNI encryption.[¶](#section-3.5-1){.pilcrow}
:::
:::

::: {#nocontextsharing}
::: {#section-3.6 .section}
### [3.6.](#section-3.6){.section-number .selfRef} [Enable Multi-party Security Contexts](#name-enable-multi-party-security){.section-name .selfRef} {#name-enable-multi-party-security}

We can design solutions in which a fronting service acts as a relay to
reach the protected service. Some of those solutions involve just one
TLS handshake between the client and the fronting service. The master
secret is verified by verifying a certificate provided by the fronting
service but not by the protected service. These solutions expose the
client to a MITM attack by the fronting service. Even if the client has
some reasonable trust in this service, the possibility of a MITM attack
is troubling.[¶](#section-3.6-1){.pilcrow}

There are other classes of solutions in which the master secret is
verified by verifying a certificate provided by the protected service.
These solutions offer more protection against a MITM attack by the
fronting service. The downside is that the client will not verify the
identity of the fronting service, which enables fronting server spoofing
attacks, such as the \"honeypot\" attack discussed below. Overall,
end-to-end TLS to the protected service is preferable, but it is
important to also provide a way to authenticate the fronting
service.[¶](#section-3.6-2){.pilcrow}

The fronting service could be pressured by adversaries. By design, it
could be forced to deny access to the protected service or to divulge
which client accessed it. But if a MITM attack is possible, the
adversaries would also be able to pressure the fronting service into
intercepting or spoofing the communications between client and protected
service.[¶](#section-3.6-3){.pilcrow}

Adversaries could also mount an attack by spoofing the fronting service.
A spoofed fronting service could act as a \"honeypot\" for users of
hidden services. At a minimum, the fake server could record the IP
addresses of these users. If the SNI encryption solution places too much
trust on the fronting server, the fake server could also serve fake
content of its own choosing, including various forms of
malware.[¶](#section-3.6-4){.pilcrow}

There are two main channels by which adversaries can conduct this
attack. Adversaries can simply try to mislead users into believing that
the honeypot is a valid fronting server, especially if that information
is carried by word of mouth or in unprotected DNS records. Adversaries
can also attempt to hijack the traffic to the regular fronting server,
using, for example, spoofed DNS responses or spoofed IP-level routing,
combined with a spoofed certificate.[¶](#section-3.6-5){.pilcrow}
:::
:::

::: {#multi-protocol}
::: {#section-3.7 .section}
### [3.7.](#section-3.7){.section-number .selfRef} [Support Multiple Protocols](#name-support-multiple-protocols){.section-name .selfRef} {#name-support-multiple-protocols}

The SNI encryption requirement does not stop with HTTP over TLS.
Multiple other applications currently use TLS, including, for example,
SMTP \[[RFC3207](#RFC3207){.xref}\], DNS \[[RFC7858](#RFC7858){.xref}\],
IMAP \[[RFC8314](#RFC8314){.xref}\], and the Extensible Messaging and
Presence Protocol (XMPP) \[[RFC7590](#RFC7590){.xref}\]. These
applications, too, will benefit from SNI encryption. HTTP-only methods,
like those described in [Section 4.1](#httpfrontingtunnels){.xref},
would not apply there. In fact, even for the HTTPS case, the HTTPS
tunneling service described in [Section
4.1](#httpfrontingtunnels){.xref} is compatible with HTTP 1.0 and HTTP
1.1 but interacts awkwardly with the multiple streams feature of HTTP/2
\[[RFC7540](#RFC7540){.xref}\]. This points to the need for an
application-agnostic solution, which would be implemented fully in the
TLS layer.[¶](#section-3.7-1){.pilcrow}

::: {#hiding-alpn}
::: {#section-3.7.1 .section}
#### [3.7.1.](#section-3.7.1){.section-number .selfRef} [Hiding the Application-Layer Protocol Negotiation](#name-hiding-the-application-laye){.section-name .selfRef} {#name-hiding-the-application-laye}

The Application-Layer Protocol Negotiation (ALPN) parameters of TLS
allow implementations to negotiate the application-layer protocol used
on a given connection. TLS provides the ALPN values in cleartext during
the initial handshake. While exposing the ALPN does not create the same
privacy issues as exposing the SNI, there is still a risk. For example,
some networks may attempt to block applications that they do not
understand or that they wish users would not
use.[¶](#section-3.7.1-1){.pilcrow}

In a sense, ALPN filtering could be very similar to the filtering of
specific port numbers exposed in some networks. This filtering by ports
has given rise to evasion tactics in which various protocols are
tunneled over HTTP in order to use open ports 80 or 443. Filtering by
ALPN would probably beget the same responses, in which the applications
just move over HTTP and only the HTTP ALPN values are used. Applications
would not need to do that if the ALPN were hidden in the same way as the
SNI.[¶](#section-3.7.1-2){.pilcrow}

In addition to hiding the SNI, it is thus desirable to also hide the
ALPN. Of course, this implies engineering trade-offs. Using the same
technique for hiding the ALPN and encrypting the SNI may result in
excess complexity. It might be preferable to encrypt these
independently.[¶](#section-3.7.1-3){.pilcrow}
:::
:::

::: {#support-other-transports-than-tcp}
::: {#section-3.7.2 .section}
#### [3.7.2.](#section-3.7.2){.section-number .selfRef} [Supporting Other Transports than TCP](#name-supporting-other-transports){.section-name .selfRef} {#name-supporting-other-transports}

The TLS handshake is also used over other transports, such as UDP with
both DTLS \[[DTLS-1.3](#I-D.ietf-tls-dtls13){.xref}\] and QUIC
\[[QUIC](#I-D.ietf-quic-tls){.xref}\]. The requirement to encrypt the
SNI applies just as well for these transports as for TLS over
TCP.[¶](#section-3.7.2-1){.pilcrow}

This points to a requirement for SNI encryption mechanisms to also be
applicable to non-TCP transports such as DTLS or
QUIC.[¶](#section-3.7.2-2){.pilcrow}
:::
:::
:::
:::
:::
:::

::: {#httpfronting}
::: {#section-4 .section}
## [4.](#section-4){.section-number .selfRef} [HTTP Co-tenancy Fronting](#name-http-co-tenancy-fronting){.section-name .selfRef} {#name-http-co-tenancy-fronting}

In the absence of TLS-level SNI encryption, many sites rely on an \"HTTP
co-tenancy\" solution, often referred to as \"domain fronting\"
\[[DOMFRONT](#DOMFRONT){.xref}\]. The TLS connection is established with
the fronting server, and HTTP requests are then sent over that
connection to the hidden service. For example, the TLS SNI could be set
to \"fronting.example.com\" (the fronting server), and HTTP requests
sent over that connection could be directed to \"hidden.example.com\"
(accessing the hidden service). This solution works well in practice
when the fronting server and the hidden server are \"co-tenants\" of the
same multiplexed server.[¶](#section-4-1){.pilcrow}

The HTTP domain fronting solution can be deployed without modification
to the TLS protocol and does not require using any specific version of
TLS. There are, however, a few issues regarding discovery, client
implementations, trust, and applicability:[¶](#section-4-2){.pilcrow}

-   [The client has to discover that the hidden service can be accessed
    through the fronting
    server.[¶](#section-4-3.1){.pilcrow}]{#section-4-3.1}
-   [The client\'s browser has to be directed to access the hidden
    service through the fronting
    service.[¶](#section-4-3.2){.pilcrow}]{#section-4-3.2}
-   [Since the TLS connection is established with the fronting service,
    the client has no cryptographic proof that the content does, in
    fact, come from the hidden service. Thus, the solution does not
    mitigate the context sharing issues described in [Section
    3.6](#nocontextsharing){.xref}. Note that this is already the case
    for co-tenanted sites.[¶](#section-4-3.3){.pilcrow}]{#section-4-3.3}
-   [Since this is an HTTP-level solution, it does not protect non-HTTP
    protocols, as discussed in [Section
    3.7](#multi-protocol){.xref}.[¶](#section-4-3.4){.pilcrow}]{#section-4-3.4}

The discovery issue is common to most SNI encryption solutions. The
browser issue was solved in \[[DOMFRONT](#DOMFRONT){.xref}\] by
implementing domain fronting as a pluggable transport for the Tor
browser. The multi-protocol issue can be mitigated by implementing other
applications over HTTP, for example, DNS over HTTPS
\[[RFC8484](#RFC8484){.xref}\]. The trust issue, however, requires
specific developments.[¶](#section-4-4){.pilcrow}

::: {#httpfrontingtunnels}
::: {#section-4.1 .section}
### [4.1.](#section-4.1){.section-number .selfRef} [HTTPS Tunnels](#name-https-tunnels){.section-name .selfRef} {#name-https-tunnels}

The HTTP domain fronting solution places a lot of trust in the fronting
server. This required trust can be reduced by tunneling HTTPS in HTTPS,
which effectively treats the fronting server as an HTTP proxy. In this
solution, the client establishes a TLS connection to the fronting server
and then issues an HTTP connect request to the hidden server. This will
establish an end-to-end HTTPS-over-TLS connection between the client and
the hidden server, mitigating the issues described in [Section
3.6](#nocontextsharing){.xref}.[¶](#section-4.1-1){.pilcrow}

The HTTPS-in-HTTPS solution requires double encryption of every packet.
It also requires that the fronting server decrypt and relay messages to
the hidden server. Both of these requirements make the implementation
onerous.[¶](#section-4.1-2){.pilcrow}
:::
:::

::: {#delegationtokens}
::: {#section-4.2 .section}
### [4.2.](#section-4.2){.section-number .selfRef} [Delegation Control](#name-delegation-control){.section-name .selfRef} {#name-delegation-control}

Clients would see their privacy compromised if they contacted the wrong
fronting server to access the hidden service, since this wrong server
could disclose their access to adversaries. This requires a controlled
way to indicate which fronting server is acceptable by the hidden
service.[¶](#section-4.2-1){.pilcrow}

This problem is similar to the \"word of mouth\" variant of the
\"fronting server spoofing\" attack described in [Section
3.6](#nocontextsharing){.xref}. The spoofing would be performed by
distributing fake advice, such as \"to reach hidden.example.com, use
fake.example.com as a fronting server\", when \"fake.example.com\" is
under the control of an adversary.[¶](#section-4.2-2){.pilcrow}

In practice, this attack is well mitigated when the hidden service is
accessed through a specialized application. The name of the fronting
server can then be programmed in the code of the application. But the
attack is harder to mitigate when the hidden service has to be accessed
through general-purpose web browsers.[¶](#section-4.2-3){.pilcrow}

There are several proposed solutions to this problem, such as creating a
special form of certificate to codify the relation between the fronting
and hidden server or obtaining the relation between the hidden and
fronting service through the DNS, possibly using DNSSEC, to avoid
spoofing. The experiment described in \[[DOMFRONT](#DOMFRONT){.xref}\]
solved the issue by integrating with the Lantern Internet circumvention
tool.[¶](#section-4.2-4){.pilcrow}

We can observe that CDNs have a similar requirement. They need to
convince the client that \"www.example.com\" can be accessed through the
seemingly unrelated \"cdn-node-xyz.example.net\". Most CDNs have
deployed DNS-based solutions to this problem. However, the CDN often
holds the authoritative certificate of the origin. There is,
simultaneously, verification of a relationship between the origin and
the CDN (through the certificate) and a risk that the CDN can spoof the
content from the origin.[¶](#section-4.2-5){.pilcrow}
:::
:::

::: {#related-work}
::: {#section-4.3 .section}
### [4.3.](#section-4.3){.section-number .selfRef} [Related Work](#name-related-work){.section-name .selfRef} {#name-related-work}

The ORIGIN frame defined for HTTP/2 \[[RFC8336](#RFC8336){.xref}\] can
be used to flag content provided by the hidden server. Secondary
certificate authentication
\[[HTTP2-SEC-CERTS](#I-D.ietf-httpbis-http2-secondary-certs){.xref}\]
can be used to manage authentication of hidden server content or to
perform client authentication before accessing hidden
content.[¶](#section-4.3-1){.pilcrow}
:::
:::
:::
:::

::: {#secusec}
::: {#section-5 .section}
## [5.](#section-5){.section-number .selfRef} [Security Considerations](#name-security-considerations){.section-name .selfRef} {#name-security-considerations}

This document lists a number of attacks against SNI encryption in
Sections [3](#snisecreq){.xref} and [4.2](#delegationtokens){.xref} and
presents a list of requirements to mitigate these attacks. Current
HTTP-based solutions described in [Section 4](#httpfronting){.xref} only
meet some of these requirements. In practice, it may well be that no
solution can meet every requirement and that practical solutions will
have to make some compromises.[¶](#section-5-1){.pilcrow}

In particular, the requirement to not stick out, presented in [Section
3.4](#snireqdontstickout){.xref}, may have to be lifted, especially for
proposed solutions that could quickly reach large-scale
deployments.[¶](#section-5-2){.pilcrow}

Replacing cleartext SNI transmission by an encrypted variant will break
or reduce the efficacy of the operational practices and techniques
implemented in middleboxes, as described in [Section
2.1](#snileak){.xref}. As explained in [Section
2.3](#end-to-end){.xref}, alternative solutions will have to be
developed.[¶](#section-5-3){.pilcrow}
:::
:::

::: {#iana-considerations}
::: {#section-6 .section}
## [6.](#section-6){.section-number .selfRef} [IANA Considerations](#name-iana-considerations){.section-name .selfRef} {#name-iana-considerations}

This document has no IANA actions.[¶](#section-6-1){.pilcrow}
:::
:::

::: {#section-7 .section}
## [7.](#section-7){.section-number .selfRef} [Informative References](#name-informative-references){.section-name .selfRef} {#name-informative-references}

\[DOMFRONT\]
:   [Fifield, D.]{.refAuthor}[, Lan, C.]{.refAuthor}[,
    Hynes, R.]{.refAuthor}[, Wegmann, P.]{.refAuthor}[, and V.
    Paxson]{.refAuthor}, [\"Blocking-resistant communication through
    domain fronting\"]{.refTitle}, [DOI
    10.1515/popets-2015-0009]{.seriesInfo}, 2015,
    \<<https://www.bamsoftware.com/papers/fronting/>\>.
:   

\[DTLS-1.3\]
:   [Rescorla, E.]{.refAuthor}[, Tschofenig, H.]{.refAuthor}[, and N.
    Modadugu]{.refAuthor}, [\"The Datagram Transport Layer Security
    (DTLS) Protocol Version 1.3\"]{.refTitle}, [Work in
    Progress]{.refContent}, [Internet-Draft,
    draft-ietf-tls-dtls13-38]{.seriesInfo}, 29 May 2020,
    \<<https://tools.ietf.org/html/draft-ietf-tls-dtls13-38>\>.
:   

\[HTTP2-SEC-CERTS\]
:   [Bishop, M.]{.refAuthor}[, Sullivan, N.]{.refAuthor}[, and M.
    Thomson]{.refAuthor}, [\"Secondary Certificate Authentication in
    HTTP/2\"]{.refTitle}, [Work in Progress]{.refContent},
    [Internet-Draft,
    draft-ietf-httpbis-http2-secondary-certs-06]{.seriesInfo}, 14 May
    2020,
    \<<https://tools.ietf.org/html/draft-ietf-httpbis-http2-secondary-certs-06>\>.
:   

\[QUIC\]
:   [Thomson, M.]{.refAuthor}[ and S. Turner]{.refAuthor}, [\"Using TLS
    to Secure QUIC\"]{.refTitle}, [Work in Progress]{.refContent},
    [Internet-Draft, draft-ietf-quic-tls-29]{.seriesInfo}, 9 June 2020,
    \<<https://tools.ietf.org/html/draft-ietf-quic-tls-29>\>.
:   

\[RFC2246\]
:   [Dierks, T.]{.refAuthor}[ and C. Allen]{.refAuthor}, [\"The TLS
    Protocol Version 1.0\"]{.refTitle}, [RFC 2246]{.seriesInfo}, [DOI
    10.17487/RFC2246]{.seriesInfo}, January 1999,
    \<<https://www.rfc-editor.org/info/rfc2246>\>.
:   

\[RFC3207\]
:   [Hoffman, P.]{.refAuthor}, [\"SMTP Service Extension for Secure SMTP
    over Transport Layer Security\"]{.refTitle}, [RFC
    3207]{.seriesInfo}, [DOI 10.17487/RFC3207]{.seriesInfo}, February
    2002, \<<https://www.rfc-editor.org/info/rfc3207>\>.
:   

\[RFC3546\]
:   [Blake-Wilson, S.]{.refAuthor}[, Nystrom, M.]{.refAuthor}[,
    Hopwood, D.]{.refAuthor}[, Mikkelsen, J.]{.refAuthor}[, and T.
    Wright]{.refAuthor}, [\"Transport Layer Security (TLS)
    Extensions\"]{.refTitle}, [RFC 3546]{.seriesInfo}, [DOI
    10.17487/RFC3546]{.seriesInfo}, June 2003,
    \<<https://www.rfc-editor.org/info/rfc3546>\>.
:   

\[RFC4346\]
:   [Dierks, T.]{.refAuthor}[ and E. Rescorla]{.refAuthor}, [\"The
    Transport Layer Security (TLS) Protocol Version 1.1\"]{.refTitle},
    [RFC 4346]{.seriesInfo}, [DOI 10.17487/RFC4346]{.seriesInfo}, April
    2006, \<<https://www.rfc-editor.org/info/rfc4346>\>.
:   

\[RFC4366\]
:   [Blake-Wilson, S.]{.refAuthor}[, Nystrom, M.]{.refAuthor}[,
    Hopwood, D.]{.refAuthor}[, Mikkelsen, J.]{.refAuthor}[, and T.
    Wright]{.refAuthor}, [\"Transport Layer Security (TLS)
    Extensions\"]{.refTitle}, [RFC 4366]{.seriesInfo}, [DOI
    10.17487/RFC4366]{.seriesInfo}, April 2006,
    \<<https://www.rfc-editor.org/info/rfc4366>\>.
:   

\[RFC5246\]
:   [Dierks, T.]{.refAuthor}[ and E. Rescorla]{.refAuthor}, [\"The
    Transport Layer Security (TLS) Protocol Version 1.2\"]{.refTitle},
    [RFC 5246]{.seriesInfo}, [DOI 10.17487/RFC5246]{.seriesInfo}, August
    2008, \<<https://www.rfc-editor.org/info/rfc5246>\>.
:   

\[RFC6066\]
:   [Eastlake 3rd, D.]{.refAuthor}, [\"Transport Layer Security (TLS)
    Extensions: Extension Definitions\"]{.refTitle}, [RFC
    6066]{.seriesInfo}, [DOI 10.17487/RFC6066]{.seriesInfo}, January
    2011, \<<https://www.rfc-editor.org/info/rfc6066>\>.
:   

\[RFC7258\]
:   [Farrell, S.]{.refAuthor}[ and H. Tschofenig]{.refAuthor},
    [\"Pervasive Monitoring Is an Attack\"]{.refTitle}, [BCP
    188]{.seriesInfo}, [RFC 7258]{.seriesInfo}, [DOI
    10.17487/RFC7258]{.seriesInfo}, May 2014,
    \<<https://www.rfc-editor.org/info/rfc7258>\>.
:   

\[RFC7540\]
:   [Belshe, M.]{.refAuthor}[, Peon, R.]{.refAuthor}[, and M. Thomson,
    Ed.]{.refAuthor}, [\"Hypertext Transfer Protocol Version 2
    (HTTP/2)\"]{.refTitle}, [RFC 7540]{.seriesInfo}, [DOI
    10.17487/RFC7540]{.seriesInfo}, May 2015,
    \<<https://www.rfc-editor.org/info/rfc7540>\>.
:   

\[RFC7590\]
:   [Saint-Andre, P.]{.refAuthor}[ and T. Alkemade]{.refAuthor}, [\"Use
    of Transport Layer Security (TLS) in the Extensible Messaging and
    Presence Protocol (XMPP)\"]{.refTitle}, [RFC 7590]{.seriesInfo},
    [DOI 10.17487/RFC7590]{.seriesInfo}, June 2015,
    \<<https://www.rfc-editor.org/info/rfc7590>\>.
:   

\[RFC7858\]
:   [Hu, Z.]{.refAuthor}[, Zhu, L.]{.refAuthor}[,
    Heidemann, J.]{.refAuthor}[, Mankin, A.]{.refAuthor}[,
    Wessels, D.]{.refAuthor}[, and P. Hoffman]{.refAuthor},
    [\"Specification for DNS over Transport Layer Security
    (TLS)\"]{.refTitle}, [RFC 7858]{.seriesInfo}, [DOI
    10.17487/RFC7858]{.seriesInfo}, May 2016,
    \<<https://www.rfc-editor.org/info/rfc7858>\>.
:   

\[RFC8314\]
:   [Moore, K.]{.refAuthor}[ and C. Newman]{.refAuthor}, [\"Cleartext
    Considered Obsolete: Use of Transport Layer Security (TLS) for Email
    Submission and Access\"]{.refTitle}, [RFC 8314]{.seriesInfo}, [DOI
    10.17487/RFC8314]{.seriesInfo}, January 2018,
    \<<https://www.rfc-editor.org/info/rfc8314>\>.
:   

\[RFC8336\]
:   [Nottingham, M.]{.refAuthor}[ and E. Nygren]{.refAuthor}, [\"The
    ORIGIN HTTP/2 Frame\"]{.refTitle}, [RFC 8336]{.seriesInfo}, [DOI
    10.17487/RFC8336]{.seriesInfo}, March 2018,
    \<<https://www.rfc-editor.org/info/rfc8336>\>.
:   

\[RFC8404\]
:   [Moriarty, K., Ed.]{.refAuthor}[ and A. Morton, Ed.]{.refAuthor},
    [\"Effects of Pervasive Encryption on Operators\"]{.refTitle}, [RFC
    8404]{.seriesInfo}, [DOI 10.17487/RFC8404]{.seriesInfo}, July 2018,
    \<<https://www.rfc-editor.org/info/rfc8404>\>.
:   

\[RFC8446\]
:   [Rescorla, E.]{.refAuthor}, [\"The Transport Layer Security (TLS)
    Protocol Version 1.3\"]{.refTitle}, [RFC 8446]{.seriesInfo}, [DOI
    10.17487/RFC8446]{.seriesInfo}, August 2018,
    \<<https://www.rfc-editor.org/info/rfc8446>\>.
:   

\[RFC8484\]
:   [Hoffman, P.]{.refAuthor}[ and P. McManus]{.refAuthor}, [\"DNS
    Queries over HTTPS (DoH)\"]{.refTitle}, [RFC 8484]{.seriesInfo},
    [DOI 10.17487/RFC8484]{.seriesInfo}, October 2018,
    \<<https://www.rfc-editor.org/info/rfc8484>\>.
:   
:::

::: {#acknowledgements}
::: {#section-appendix.a .section}
## [Acknowledgements](#name-acknowledgements){.section-name .selfRef} {#name-acknowledgements}

A large part of this document originated in discussion of SNI encryption
on the TLS WG mailing list, including comments after the tunneling
approach was first proposed in a message to that list:
\<<https://mailarchive.ietf.org/arch/msg/tls/tXvdcqnogZgqmdfCugrV8M90Ftw>\>.[¶](#section-appendix.a-1){.pilcrow}

Thanks to [Eric Rescorla]{.contact-name} for his multiple suggestions,
reviews, and edits to the successive draft versions of this
document.[¶](#section-appendix.a-2){.pilcrow}

Thanks to [Daniel Kahn Gillmor]{.contact-name} for a pretty detailed
review of the initial draft of this document. Thanks to [Bernard
Aboba]{.contact-name}, [Mike Bishop]{.contact-name}, [Alissa
Cooper]{.contact-name}, [Roman Danyliw]{.contact-name}, [Stephen
Farrell]{.contact-name}, [Warren Kumari]{.contact-name}, [Mirja
Kuelewind]{.contact-name}, [Barry Leiba]{.contact-name}, [Martin
Rex]{.contact-name}, [Adam Roach]{.contact-name}, [Meral
Shirazipour]{.contact-name}, [Martin Thomson]{.contact-name}, [Eric
Vyncke]{.contact-name}, and employees of the UK National Cyber Security
Centre for their reviews. Thanks to [Chris Wood]{.contact-name}, [Ben
Kaduk]{.contact-name}, and [Sean Turner]{.contact-name} for helping move
this document toward publication.[¶](#section-appendix.a-3){.pilcrow}
:::
:::

::: {#authors-addresses}
::: {#section-appendix.b .section}
## [Author\'s Address](#name-authors-address){.section-name .selfRef} {#name-authors-address}

::: {.left dir="auto"}
[Christian Huitema]{.fn .nameRole}
:::

::: {.left dir="auto"}
[Private Octopus Inc.]{.org}
:::

::: {.left dir="auto"}
[Friday Harbor]{.locality}, [WA]{.region} [98250]{.postal-code}
:::

::: {.left dir="auto"}
[United States of America]{.country-name}
:::

::: email
Email: <huitema@huitema.net>
:::
:::
:::
